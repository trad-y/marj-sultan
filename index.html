<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الاتصال المرئي والصوتي المتكامل</title>
    <!-- Font Awesome 6 للأيقونات المتطورة -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* ====== المتغيرات العامة - قابلة للتعديل يدوياً ====== */
        :root {
            --primary: #2563eb;        /* اللون الأساسي - قابل للتغيير */
            --primary-dark: #1d4ed8;    /* درجة أغمق للزر الرئيسي */
            --success: #059669;         /* لون النجاح والمكالمات */
            --danger: #dc2626;          /* لون الخطأ والرفض */
            --warning: #d97706;         /* لون التحذير والمكالمات الواردة */
            --bg: #0f172a;             /* خلفية الصفحة الرئيسية */
            --card: #1e293b;           /* خلفية البطاقات */
            --text: #f8fafc;           /* لون النص الأساسي */
            --text-secondary: #94a3b8; /* لون النص الثانوي */
            --border: #334155;         /* لون الحدود */
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif; /* الخط الرئيسي */
            --border-radius-card: 24px; /* تدوير زوايا البطاقات */
            --border-radius-btn: 12px;  /* تدوير زوايا الأزرار */
            --transition-speed: 0.3s;   /* سرعة الحركة */
        }

        /* ====== إعادة تعيين وإعدادات أساسية ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ====== شاشات الدخول والتسجيل ====== */
        #setupScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg) 0%, #1e1b4b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        .auth-card {
            background: var(--card);
            padding: 40px;
            border-radius: var(--border-radius-card);
            text-align: center;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border);
            animation: fadeIn 0.5s ease;
        }

        .auth-card h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 28px;
            background: linear-gradient(to right, var(--primary), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 15px;
            outline: none;
            transition: border-color 0.2s;
        }

        .auth-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4);
        }

        .auth-switch {
            margin-top: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .auth-switch:hover {
            color: var(--primary);
        }

        /* ====== شاشة إدخال رمز التحقق ====== */
        .verification-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .code-input {
            width: 60px;
            height: 70px;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg);
            color: var(--text);
        }

        .code-input:focus {
            border-color: var(--primary);
        }

        /* ====== التطبيق الرئيسي ====== */
        .app-container {
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .app-header {
            background: var(--card);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ====== شريط التحكم ====== */
        .control-bar {
            background: var(--card);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            border: 1px solid var(--border);
        }

        .search-container {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-container input {
            width: 100%;
            padding: 14px 20px 14px 45px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .call-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ====== زر الاتصال العشوائي مع حركة التقليب ====== */
        .btn-random {
            background: linear-gradient(135deg, #9333ea, #7e22ce);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-random i {
            transition: transform 0.3s;
        }

        .btn-random.flip i {
            transform: rotate(360deg);
        }

        /* ====== تأثير التقليب لصندوق الفيديو عند الاتصال العشوائي ====== */
        @keyframes flipVideo {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(0deg); }
        }

        .video-box.flip-animation {
            animation: flipVideo 0.6s ease;
        }

        /* ====== مربعات الفيديو ====== */
        .video-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .video-column {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .video-box {
            position: relative;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--border);
            aspect-ratio: 16/9;
            transition: all 0.3s;
            will-change: transform; /* تحسين الأداء وتقليل التكسير */
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        /* ====== إصلاح انعكاس الكاميرا المحلية - قابلة للتعديل ====== */
        #localVideo {
            transform: scaleX(-1); /* إلغاء المرآة - قابل للتعديل */
        }

        .video-label {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mic-indicator, .cam-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .mic-indicator.on, .cam-indicator.on { background-color: var(--success); }
        .mic-indicator.off, .cam-indicator.off { background-color: var(--danger); }

        /* ====== الأزرار السفلية ====== */
        .bottom-controls {
            background: var(--card);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            min-width: 140px;
            justify-content: center;
        }

        .btn i {
            font-size: 18px;
        }

        .btn-main { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-video { background: linear-gradient(135deg, var(--success), #047857); color: white; }
        .btn-audio { background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #b91c1c); color: white; }
        .btn-end-call { background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; width: 200px; }

        .btn-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background: var(--bg);
            color: white;
            font-size: 24px;
            transition: all 0.2s;
        }

        .btn-toggle.active { background: var(--success); }
        .btn-toggle.inactive { background: var(--danger); }

        /* ====== نافذة المكالمة الواردة ====== */
        .incoming-call-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .call-modal-content {
            background: var(--card);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: modalAppear 0.3s ease;
        }

        /* ====== حالة الاتصال ====== */
        .status-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ====== تحسينات للأجهزة المحمولة ====== */
        @media (max-width: 768px) {
            .control-bar { flex-direction: column; }
            .search-container { min-width: 100%; }
            .btn { min-width: 120px; }
            .code-input { width: 50px; height: 60px; font-size: 24px; }
        }

        /* ====== علامات التعديل اليدوي ====== */
        /* EDITABLE: أضف أو عدل أي ألوان أو أحجام من قسم :root أعلاه */
        /* EDITABLE: لتغيير انعكاس الكاميرا المحلية، عدل transform: scaleX(-1) في #localVideo */
        /* EDITABLE: لتعديل سرعة حركة التقليب، غير مدة animation في .flip-animation */
        /* EDITABLE: أضف أي تنسيقات مخصصة هنا */
    </style>
</head>
<body>

    <!-- ====== شاشة المصادقة (تسجيل الدخول / إنشاء حساب) ====== -->
    <div id="setupScreen">
        <div class="auth-card" id="authContainer">
            <!-- يتم تبديل المحتوى ديناميكياً عبر JavaScript -->
        </div>
    </div>

    <!-- ====== التطبيق الرئيسي ====== -->
    <div class="app-container" id="mainApp">
        <!-- الهيدر -->
        <div class="app-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">?</div>
                <div>
                    <div class="user-name" id="myNameLabel">مستخدم</div>
                    <div class="user-status">
                        <div class="status-indicator"></div>
                        <span id="connectionStatus">متصل بالسيرفر</span>
                    </div>
                </div>
            </div>
            <div class="call-timer" id="callTimer" style="display: none;">
                <span style="font-weight: bold; color: var(--success);"><i class="fas fa-clock"></i> <span id="timerDisplay">00:00</span></span>
            </div>
        </div>

        <!-- شريط التحكم -->
        <div class="control-bar">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="targetNameInput" placeholder="ابحث عن مستخدم للاتصال به...">
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="call-buttons">
                <button class="btn btn-audio" onclick="callUser('audio')">
                    <i class="fas fa-phone-alt"></i>
                    <span>اتصال صوتي</span>
                </button>
                <button class="btn btn-video" onclick="callUser('video')">
                    <i class="fas fa-video"></i>
                    <span>اتصال مرئي</span>
                </button>
                <button class="btn btn-random" id="randomCallBtn" onclick="requestRandomCall()">
                    <i class="fas fa-random"></i>
                    <span>اتصال عشوائي</span>
                </button>
            </div>
        </div>

        <!-- شبكة الفيديو -->
        <div class="video-container">
            <div class="video-column">
                <div class="video-box" id="localVideoContainer">
                    <video id="localVideo" autoplay playsinline muted></video>
                    <div class="video-label">
                        <span>أنت</span>
                        <div class="mic-indicator on" id="localMicIndicator"></div>
                        <div class="cam-indicator on" id="localCamIndicator"></div>
                    </div>
                    <div class="video-overlay">
                        <button class="btn-toggle" id="toggleVideoBtn">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="btn-toggle" id="toggleAudioBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="video-column">
                <div class="video-box" id="remoteVideoContainer">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="video-label" id="remoteTag">
                        <span>في انتظار الاتصال...</span>
                        <div class="mic-indicator off" id="remoteMicIndicator"></div>
                        <div class="cam-indicator off" id="remoteCamIndicator"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- لوحة التحكم السفلية -->
        <div class="bottom-controls">
            <button class="btn-toggle active" id="toggleMicBtn">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="btn-toggle active" id="toggleCamBtn">
                <i class="fas fa-video"></i>
            </button>
            <!-- زر تبديل الكاميرا الأمامية/الخلفية -->
            <button class="btn-toggle" id="flipCameraBtn" onclick="flipCamera()">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-end-call" id="endCallBtn" onclick="endCall()" style="display: none;">
                <i class="fas fa-phone-slash"></i>
                <span>إنهاء المكالمة</span>
            </button>
            <button class="btn btn-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>خروج</span>
            </button>
        </div>

        <!-- حالة النظام -->
        <div class="status-footer">
            <span id="statusMsg">الحالة: <span class="status-connected">متصل بالسيرفر</span></span> | 
            <span id="onlineUsers">المستخدمون المتصلون: 1</span>
        </div>
    </div>

    <!-- نافذة المكالمة الواردة -->
    <div class="incoming-call-modal" id="incomingCallModal">
        <div class="call-modal-content">
            <div class="caller-info">
                <div class="caller-avatar" id="callerAvatar">?</div>
                <div>
                    <div style="font-size: 24px; font-weight: bold;" id="callerName">مستخدم</div>
                    <div class="call-type" id="incomingCallType">اتصال صوتي</div>
                </div>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">يريد الاتصال بك</p>
            <div class="call-actions">
                <button class="btn btn-danger" onclick="rejectCall()" style="min-width: 120px;">
                    <i class="fas fa-times"></i> رفض
                </button>
                <button class="btn btn-success" onclick="acceptCall()" style="min-width: 120px;">
                    <i class="fas fa-check"></i> قبول
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== المتغيرات العامة ====================
        // EDITABLE: عنوان السيرفر - قم بتغييره إلى IP التيرمكس
        const SERVER_URL = "http://192.168.1.33:3000";
        
        let socket;
        let myName = "";
        let myEmail = "";
        let myUserId = null;
        let localStream = null;
        let peerConnection = null;
        let currentCall = null;
        let callTimer = null;
        let callStartTime = null;
        let callType = null;
        let isCallActive = false;
        let incomingCallData = null;
        let connectedUsers = [];
        
        // قائمة انتظار الاتصال العشوائي
        let isWaitingRandom = false;
        
        // كاميرات متاحة
        let videoDevices = [];
        let currentDeviceId = null;

        // إعدادات ICE
        const config = { 
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ] 
        };

        // ==================== نظام المصادقة ====================
        const authContainer = document.getElementById('authContainer');

        function showLoginScreen() {
            authContainer.innerHTML = `
                <h2>تسجيل الدخول</h2>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">أدخل بريدك الإلكتروني وكلمة المرور</p>
                <input type="email" id="loginEmail" class="auth-input" placeholder="البريد الإلكتروني">
                <input type="password" id="loginPassword" class="auth-input" placeholder="كلمة المرور">
                <button class="auth-btn" onclick="login()">دخول</button>
                <div class="auth-switch" onclick="showSignupScreen()">ليس لديك حساب؟ أنشئ حساب جديد</div>
                <div id="authError" style="color: var(--danger); margin-top: 15px; font-size: 14px;"></div>
            `;
        }

        function showSignupScreen() {
            authContainer.innerHTML = `
                <h2>إنشاء حساب جديد</h2>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">أدخل بريدك الإلكتروني واسم المستخدم</p>
                <input type="email" id="signupEmail" class="auth-input" placeholder="البريد الإلكتروني">
                <input type="text" id="signupUsername" class="auth-input" placeholder="اسم المستخدم">
                <input type="password" id="signupPassword" class="auth-input" placeholder="كلمة المرور">
                <button class="auth-btn" onclick="sendVerificationCode()">إرسال رمز التحقق</button>
                <div class="auth-switch" onclick="showLoginScreen()">لديك حساب؟ سجل دخول</div>
                <div id="authError" style="color: var(--danger); margin-top: 15px; font-size: 14px;"></div>
            `;
        }

        function showVerificationScreen(email, username, password) {
            authContainer.innerHTML = `
                <h2>تأكيد البريد الإلكتروني</h2>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">أدخل رمز التحقق المكون من 4 أرقام المرسل إلى</p>
                <p style="font-weight: bold; color: var(--primary); margin-bottom: 20px;">${email}</p>
                <div class="verification-container">
                    <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 0)" onkeyup="handleCodeInput(event, this, 0)">
                    <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)" onkeyup="handleCodeInput(event, this, 1)">
                    <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)" onkeyup="handleCodeInput(event, this, 2)">
                    <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)" onkeyup="handleCodeInput(event, this, 3)">
                </div>
                <button class="auth-btn" onclick="verifyCode('${email}', '${username}', '${password}')">تأكيد</button>
                <div class="auth-switch" onclick="showSignupScreen()">تغيير البريد الإلكتروني</div>
                <div id="authError" style="color: var(--danger); margin-top: 15px;"></div>
            `;
            // تركيز على أول حقل
            setTimeout(() => document.querySelector('.code-input')?.focus(), 100);
        }

        // التنقل بين حقول رمز التحقق
        window.moveToNext = (input, index) => {
            if (input.value.length === 1 && index < 3) {
                input.parentElement.children[index + 1].focus();
            }
        };

        window.handleCodeInput = (e, input, index) => {
            if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                input.parentElement.children[index - 1].focus();
            }
        };

        // إرسال رمز التحقق عبر البريد
        async function sendVerificationCode() {
            const email = document.getElementById('signupEmail')?.value;
            const username = document.getElementById('signupUsername')?.value;
            const password = document.getElementById('signupPassword')?.value;
            const errorEl = document.getElementById('authError');

            if (!email || !username || !password) {
                errorEl.innerText = 'يرجى ملء جميع الحقول';
                return;
            }

            if (!validateEmail(email)) {
                errorEl.innerText = 'البريد الإلكتروني غير صحيح';
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/send-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password })
                });
                const data = await response.json();
                if (data.success) {
                    showVerificationScreen(email, username, password);
                } else {
                    errorEl.innerText = data.message || 'فشل إرسال الرمز';
                }
            } catch (err) {
                errorEl.innerText = 'خطأ في الاتصال بالسيرفر';
            }
        }

        // التحقق من الرمز
        async function verifyCode(email, username, password) {
            const inputs = document.querySelectorAll('.code-input');
            let code = '';
            inputs.forEach(input => code += input.value);
            const errorEl = document.getElementById('authError');

            if (code.length !== 4) {
                errorEl.innerText = 'يرجى إدخال الرمز المكون من 4 أرقام';
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/verify-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });
                const data = await response.json();
                if (data.success) {
                    // إنشاء الحساب
                    const registerResponse = await fetch(`${SERVER_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, username, password })
                    });
                    const registerData = await registerResponse.json();
                    if (registerData.success) {
                        alert('تم إنشاء الحساب بنجاح! يمكنك تسجيل الدخول الآن.');
                        showLoginScreen();
                    } else {
                        errorEl.innerText = registerData.message || 'فشل إنشاء الحساب';
                    }
                } else {
                    errorEl.innerText = data.message || 'رمز التحقق غير صحيح';
                }
            } catch (err) {
                errorEl.innerText = 'خطأ في الاتصال بالسيرفر';
            }
        }

        // تسجيل الدخول
        async function login() {
            const email = document.getElementById('loginEmail')?.value;
            const password = document.getElementById('loginPassword')?.value;
            const errorEl = document.getElementById('authError');

            if (!email || !password) {
                errorEl.innerText = 'يرجى إدخال البريد وكلمة المرور';
                return;
            }

            try {
                const response = await fetch(`${SERVER_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (data.success) {
                    myName = data.username;
                    myEmail = email;
                    myUserId = data.userId;
                    // بدء جلسة الاتصال
                    await initializeApp();
                } else {
                    errorEl.innerText = data.message || 'بريد أو كلمة مرور غير صحيحة';
                }
            } catch (err) {
                errorEl.innerText = 'خطأ في الاتصال بالسيرفر';
            }
        }

        // التحقق من صحة البريد
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // ==================== تهيئة التطبيق بعد تسجيل الدخول ====================
        async function initializeApp() {
            try {
                // طلب صلاحيات الكاميرا والميكروفون
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('userAvatar').innerText = myName.charAt(0).toUpperCase();
                document.getElementById('myNameLabel').innerText = myName;
                
                // الاتصال بالسيرفر
                connectToServer();
                
                // إخفاء شاشة الدخول
                document.getElementById('setupScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('setupScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'flex';
                }, 300);
                
                setupControls();
                getVideoDevices();
                
            } catch (err) {
                console.error(err);
                alert('تعذر الوصول إلى الكاميرا أو الميكروفون. يرجى التحقق من الصلاحيات.');
            }
        }

        // ==================== الاتصال بالسيرفر ====================
        function connectToServer() {
            socket = io(SERVER_URL, {
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                query: { username: myName, email: myEmail }
            });

            socket.on('connect', () => {
                console.log('متصل بالسيرفر');
                updateStatus('متصل بالسيرفر', true);
                socket.emit('register', { name: myName, email: myEmail });
            });

            socket.on('users-updated', (users) => {
                connectedUsers = users.filter(u => u.id !== socket.id);
                updateOnlineUsersCount();
                updateSearchResults();
            });

            socket.on('incoming-call', (data) => {
                incomingCallData = data;
                showIncomingCallModal(data);
            });

            socket.on('call-accepted', async (data) => {
                await handleCallAccepted(data);
            });

            socket.on('call-rejected', (data) => {
                alert(`تم رفض المكالمة من قبل ${data.from}`);
                resetCallState();
            });

            socket.on('call-ended', (data) => {
                if (isCallActive) {
                    alert(`أنهى ${data.from} المكالمة`);
                    endCall();
                }
            });

            socket.on('offer', async (data) => {
                await handleOffer(data);
            });

            socket.on('answer', async (data) => {
                await handleAnswer(data);
            });

            socket.on('ice-candidate', (data) => {
                handleIceCandidate(data);
            });

            // ===== أحداث الاتصال العشوائي =====
            socket.on('random-call-matched', async (data) => {
                isWaitingRandom = false;
                document.getElementById('randomCallBtn').classList.remove('flip');
                // تشغيل حركة التقليب على صندوق الفيديو البعيد
                document.getElementById('remoteVideoContainer').classList.add('flip-animation');
                setTimeout(() => {
                    document.getElementById('remoteVideoContainer').classList.remove('flip-animation');
                }, 600);
                
                // بدء المكالمة مع المستخدم المطابق
                currentCall = data.partnerId;
                callType = data.type || 'video';
                await createPeerConnection(data.partnerId);
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                socket.emit('call', {
                    to: data.partnerId,
                    from: myName,
                    type: callType,
                    offer: offer
                });
                
                updateCallUI(true, `جاري الاتصال العشوائي...`, callType);
                document.getElementById('endCallBtn').style.display = 'flex';
            });

            socket.on('random-call-cancelled', () => {
                isWaitingRandom = false;
                document.getElementById('randomCallBtn').classList.remove('flip');
                alert('لم يتم العثور على مستخدم. حاول مرة أخرى.');
            });
        }

        // ==================== الاتصال العشوائي ====================
        function requestRandomCall() {
            if (isWaitingRandom) {
                // إلغاء الانتظار
                socket.emit('cancel-random-call');
                isWaitingRandom = false;
                document.getElementById('randomCallBtn').classList.remove('flip');
                document.getElementById('randomCallBtn').innerHTML = '<i class="fas fa-random"></i><span>اتصال عشوائي</span>';
            } else {
                // طلب اتصال عشوائي
                socket.emit('request-random-call', { 
                    userId: socket.id, 
                    name: myName 
                });
                isWaitingRandom = true;
                document.getElementById('randomCallBtn').classList.add('flip');
                document.getElementById('randomCallBtn').innerHTML = '<i class="fas fa-times"></i><span>إلغاء الانتظار</span>';
                updateStatus('جاري البحث عن مستخدم عشوائي...', true);
            }
        }

        // ==================== تبديل الكاميرا الأمامية/الخلفية ====================
        async function getVideoDevices() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            videoDevices = devices.filter(device => device.kind === 'videoinput');
            if (videoDevices.length > 0) {
                currentDeviceId = localStream.getVideoTracks()[0]?.getSettings().deviceId;
            }
        }

        async function flipCamera() {
            if (videoDevices.length < 2) {
                alert('لا توجد كاميرا خلفية متاحة');
                return;
            }
            
            // التبديل إلى الجهاز التالي
            const currentIndex = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
            const nextIndex = (currentIndex + 1) % videoDevices.length;
            const newDeviceId = videoDevices[nextIndex].deviceId;
            
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: newDeviceId } },
                    audio: true
                });
                
                // استبدال المسار
                const videoTrack = newStream.getVideoTracks()[0];
                const audioTrack = newStream.getAudioTracks()[0];
                
                const sender = peerConnection?.getSenders().find(s => s.track?.kind === 'video');
                if (sender) await sender.replaceTrack(videoTrack);
                
                localStream.removeTrack(localStream.getVideoTracks()[0]);
                localStream.addTrack(videoTrack);
                
                document.getElementById('localVideo').srcObject = localStream;
                currentDeviceId = newDeviceId;
                
                // إيقاف المسار القديم
                localStream.getVideoTracks().forEach(t => {
                    if (t.id !== videoTrack.id) t.stop();
                });
                
            } catch (err) {
                console.error('فشل تبديل الكاميرا:', err);
            }
        }

        // ==================== دوال WebRTC (محفوظة كما هي مع تحسينات) ====================
        async function createPeerConnection(targetId) {
            if (peerConnection) peerConnection.close();
            
            peerConnection = new RTCPeerConnection(config);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && targetId) {
                    socket.emit('ice-candidate', { to: targetId, candidate: event.candidate });
                }
            };
            
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    isCallActive = true;
                    startCallTimer();
                    updateCallUI(true, `متصل`, callType);
                } else if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) {
                    if (isCallActive) endCall();
                }
            };
        }

        async function callUser(type) {
            const targetName = document.getElementById('targetNameInput').value.trim();
            if (!targetName) return alert('يرجى اختيار مستخدم');
            if (targetName === myName) return alert('لا يمكن الاتصال بنفسك');
            if (isCallActive) return alert('أنت في مكالمة حالياً');
            
            const targetUser = connectedUsers.find(u => u.name === targetName);
            if (!targetUser) return alert('المستخدم غير متصل');
            
            currentCall = targetUser.id;
            callType = type;
            
            await createPeerConnection(targetUser.id);
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            socket.emit('call', { to: targetUser.id, from: myName, type, offer });
            
            updateCallUI(true, `جاري الاتصال بـ ${targetName}...`, type);
            document.getElementById('endCallBtn').style.display = 'flex';
        }

        async function handleOffer(data) {
            if (isCallActive) {
                socket.emit('reject-call', { to: data.fromId, reason: 'مشغول' });
                return;
            }
            incomingCallData = { ...data, fromId: data.fromId };
            showIncomingCallModal(data);
        }

        async function acceptCall() {
            if (!incomingCallData) return;
            document.getElementById('incomingCallModal').style.display = 'none';
            
            currentCall = incomingCallData.fromId;
            callType = incomingCallData.type;
            
            await createPeerConnection(incomingCallData.fromId);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCallData.offer));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('accept-call', { to: incomingCallData.fromId, answer });
            socket.emit('call-accepted', { to: incomingCallData.fromId, from: myName });
            
            updateCallUI(true, `متصل مع ${incomingCallData.from}`, callType);
            document.getElementById('endCallBtn').style.display = 'flex';
            document.getElementById('remoteTag').innerHTML = `<span>${incomingCallData.from}</span>`;
            
            incomingCallData = null;
        }

        function rejectCall() {
            if (incomingCallData) {
                socket.emit('reject-call', { to: incomingCallData.fromId });
                document.getElementById('incomingCallModal').style.display = 'none';
                incomingCallData = null;
            }
        }

        async function handleAnswer(data) {
            if (!peerConnection) return;
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        }

        function handleIceCandidate(data) {
            if (peerConnection) {
                peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        }

        async function handleCallAccepted(data) {
            if (!peerConnection || currentCall !== data.fromId) return;
            updateCallUI(true, `متصل مع ${data.from}`, callType);
            document.getElementById('remoteTag').innerHTML = `<span>${data.from}</span>`;
        }

        function endCall() {
            if (currentCall) {
                socket.emit('end-call', { to: currentCall });
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            resetCallState();
            document.getElementById('endCallBtn').style.display = 'none';
            stopCallTimer();
        }

        function resetCallState() {
            isCallActive = false;
            currentCall = null;
            callType = null;
            incomingCallData = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('remoteTag').innerHTML = '<span>في انتظار الاتصال...</span>';
            document.getElementById('remoteVideoContainer').classList.remove('active-call');
            updateCallUI(false, 'جاهز للاتصال', null);
        }

        // ==================== دوال مساعدة ====================
        function setupControls() {
            // أزرار التحكم بالميكروفون والكاميرا
            document.getElementById('toggleMicBtn').addEventListener('click', toggleMic);
            document.getElementById('toggleCamBtn').addEventListener('click', toggleCam);
            document.getElementById('toggleVideoBtn').addEventListener('click', toggleCam);
            document.getElementById('toggleAudioBtn').addEventListener('click', toggleMic);
            
            // البحث
            document.getElementById('targetNameInput').addEventListener('input', updateSearchResults);
            document.getElementById('targetNameInput').addEventListener('focus', () => {
                updateSearchResults();
                document.getElementById('searchResults').classList.add('active');
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('searchResults').classList.remove('active');
                }
            });
        }

        function toggleMic() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const btn = document.getElementById('toggleMicBtn');
                    btn.classList.toggle('active', audioTrack.enabled);
                    btn.classList.toggle('inactive', !audioTrack.enabled);
                    document.getElementById('localMicIndicator').classList.toggle('on', audioTrack.enabled);
                    document.getElementById('localMicIndicator').classList.toggle('off', !audioTrack.enabled);
                }
            }
        }

        function toggleCam() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    const btn = document.getElementById('toggleCamBtn');
                    btn.classList.toggle('active', videoTrack.enabled);
                    btn.classList.toggle('inactive', !videoTrack.enabled);
                    document.getElementById('localCamIndicator').classList.toggle('on', videoTrack.enabled);
                    document.getElementById('localCamIndicator').classList.toggle('off', !videoTrack.enabled);
                }
            }
        }

        function updateSearchResults() {
            const searchTerm = document.getElementById('targetNameInput').value.toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';
            
            let filtered = connectedUsers;
            if (searchTerm.trim()) {
                filtered = connectedUsers.filter(u => u.name.toLowerCase().includes(searchTerm));
            }
            
            if (filtered.length > 0) {
                filtered.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'user-item';
                    item.innerHTML = `
                        <div class="user-item-avatar">${user.name.charAt(0).toUpperCase()}</div>
                        <div class="user-item-info">
                            <div class="user-item-name">${user.name}</div>
                            <div class="user-item-status">${user.inCall ? 'في مكالمة' : 'متصل'}</div>
                        </div>
                    `;
                    item.onclick = () => {
                        document.getElementById('targetNameInput').value = user.name;
                        resultsContainer.classList.remove('active');
                    };
                    resultsContainer.appendChild(item);
                });
            } else {
                resultsContainer.innerHTML = '<div class="user-item" style="justify-content: center;">لا توجد نتائج</div>';
            }
            resultsContainer.classList.add('active');
        }

        function updateOnlineUsersCount() {
            document.getElementById('onlineUsers').innerText = `المستخدمون المتصلون: ${connectedUsers.length + 1}`;
        }

        function updateStatus(status, isConnected) {
            document.getElementById('connectionStatus').innerText = status;
            document.getElementById('statusMsg').innerHTML = `الحالة: <span class="${isConnected ? 'status-connected' : 'status-disconnected'}">${status}</span>`;
        }

        function updateCallUI(isActive, status, type) {
            const remoteContainer = document.getElementById('remoteVideoContainer');
            if (isActive) {
                remoteContainer.classList.add('active-call');
            } else {
                remoteContainer.classList.remove('active-call');
            }
            if (type === 'audio') {
                document.getElementById('remoteCamIndicator').classList.remove('on');
                document.getElementById('remoteCamIndicator').classList.add('off');
            }
        }

        function showIncomingCallModal(data) {
            document.getElementById('callerName').innerText = data.from;
            document.getElementById('callerAvatar').innerText = data.from.charAt(0).toUpperCase();
            document.getElementById('incomingCallType').innerText = data.type === 'video' ? 'اتصال مرئي' : 'اتصال صوتي';
            document.getElementById('incomingCallModal').style.display = 'flex';
            document.getElementById('remoteVideoContainer').classList.add('incoming-call');
        }

        function startCallTimer() {
            callStartTime = new Date();
            document.getElementById('callTimer').style.display = 'block';
            callTimer = setInterval(() => {
                const diff = Math.floor((new Date() - callStartTime) / 1000);
                const mins = Math.floor(diff / 60);
                const secs = diff % 60;
                document.getElementById('timerDisplay').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopCallTimer() {
            clearInterval(callTimer);
            callTimer = null;
            document.getElementById('timerDisplay').innerText = '00:00';
            document.getElementById('callTimer').style.display = 'none';
        }

        function logout() {
            if (isCallActive) endCall();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (socket) socket.disconnect();
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'flex';
            document.getElementById('setupScreen').style.opacity = '1';
            showLoginScreen();
        }

        // بدء بشاشة تسجيل الدخول
        window.onload = () => {
            showLoginScreen();
        };
    </script>
</body>
</html>
