<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø±ÙˆÙ† - Ø´Ø¨ÙƒØ© Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-top: env(safe-area-inset-top, 0px);
        }

        body.light-mode {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            transition: all 0.3s ease;
        }

        /* ===== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
        #authScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg), #1e1b4b);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9000;
            padding: 20px;
            overflow-y: auto;
        }

        .auth-card {
            background: var(--card);
            padding: 30px 20px;
            border-radius: 32px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
            animation: fadeUp 0.5s;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .auth-logo h1 {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 600;
            transition: all 0.2s;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .auth-input {
            width: 100%;
            padding: 16px 18px;
            border-radius: 20px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 15px;
            outline: none;
            transition: all 0.2s;
        }

        .auth-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.2);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border-radius: 20px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 15px;
        }

        .auth-btn:active { transform: scale(0.98); }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .auth-link {
            color: var(--text-secondary);
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
        }

        .auth-link:hover { color: var(--primary); }

        .code-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            direction: ltr;
        }

        .code-input {
            width: 55px;
            height: 65px;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            border: 2px solid var(--border);
            border-radius: 16px;
            background: var(--bg);
            color: var(--text);
            outline: none;
        }

        .code-input:focus { border-color: var(--primary); }

        #authError {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }

        /* ===== Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0 calc(8px + var(--safe-bottom));
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .bottom-nav.hide { transform: translateY(100%); }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 11px;
            flex: 1;
            max-width: 70px;
            transition: all 0.2s;
        }

        .nav-item i { font-size: 22px; }
        .nav-item.active { color: var(--primary); }
        .nav-item:active { transform: scale(0.95); }

        /* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ===== */
        .app-header {
            background: var(--card);
            padding: 12px 16px;
            border-radius: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
            margin: 10px 16px 16px;
            position: sticky;
            top: 10px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            flex: 1;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-icon:active {
            background: var(--primary);
            transform: scale(0.95);
        }

        .btn-icon.has-notification {
            position: relative;
        }

        .btn-icon.has-notification::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 10px;
            height: 10px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--card);
        }

        /* ===== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===== */
        .notifications-panel {
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            max-width: 400px;
            margin: 0 auto;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .notification-item:active { background: var(--bg); }
        .notification-item:last-child { border-bottom: none; }

        .notification-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* ===== Ø§Ù„Ø´Ø§Ø´Ø§Øª ===== */
        .screen {
            display: none;
            width: 100%;
            min-height: calc(100vh - 160px);
            padding-bottom: 80px;
        }

        .screen.active { display: block; }

        /* ===== Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== */
        .search-box {
            position: relative;
            margin: 0 16px 20px;
        }

        .search-box input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border-radius: 30px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
        }

        .search-box i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-results {
            position: absolute;
            width: 100%;
            background: var(--card);
            border-radius: 24px;
            margin-top: 8px;
            display: none;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .search-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .search-item:active { background: var(--bg); }
        .search-item:last-child { border-bottom: none; }

        .search-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .stories-section {
            background: var(--card);
            padding: 16px;
            border-radius: 24px;
            border: 1px solid var(--border);
            margin: 0 16px 20px;
        }

        .stories-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stories-header h3 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stories-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 4px 0;
            scrollbar-width: none;
        }

        .stories-container::-webkit-scrollbar { display: none; }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            min-width: 70px;
        }

        .story-avatar {
            width: 68px;
            height: 68px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            object-fit: cover;
            margin-bottom: 6px;
        }

        .story-avatar.add {
            border: 2px dashed var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--primary);
            background: var(--bg);
        }

        .story-name {
            font-size: 12px;
            color: var(--text-secondary);
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .suggestions-section {
            background: var(--card);
            padding: 20px 16px;
            border-radius: 24px;
            border: 1px solid var(--border);
            margin: 0 16px 20px;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .suggestion-item:last-child { border-bottom: none; }

        .suggestion-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .suggestion-info { flex: 1; }
        .suggestion-name { font-weight: 600; }
        .suggestion-bio { font-size: 12px; color: var(--text-secondary); }

        .follow-btn {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .follow-btn.following {
            background: var(--primary);
            color: white;
        }

        .follow-btn:active { transform: scale(0.95); }

        .chats-section {
            background: var(--card);
            padding: 20px 16px;
            border-radius: 24px;
            border: 1px solid var(--border);
            margin: 0 16px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .chat-item:last-child { border-bottom: none; }
        .chat-item:active { background: var(--bg); }

        .chat-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-info { flex: 1; }
        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chat-last {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .unread-badge {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .offline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            display: inline-block;
        }

        /* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===== */
        .loading-spinner {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <h2>Ø±ÙˆÙ†</h2>
        <p style="color: var(--text-secondary);">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© -->
    <div id="authScreen">
        <div class="auth-card" id="authCard">
            <div class="auth-logo">
                <h1>Ø±ÙˆÙ†</h1>
                <p style="color: var(--text-secondary);">ØªÙˆØ§ØµÙ„ Ø¨Ø·Ø±ÙŠÙ‚ØªÙƒ</p>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                <div class="auth-tab" onclick="switchAuthTab('signup')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
            </div>
            <div id="authContent"></div>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="mainApp" style="display: none;">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="app-header">
            <div class="user-info" onclick="navigateTo('profile')">
                <img class="user-avatar" id="headerAvatar" src="" alt="avatar">
                <div>
                    <div class="user-name" id="headerName"></div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span class="online-dot"></span>
                        <span id="connectionStatus">Ù…ØªØµÙ„</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" id="notificationsBtn"><i class="fas fa-bell"></i></button>
                <button class="btn-icon" id="uploadAvatarBtn"><i class="fas fa-camera"></i></button>
                <input type="file" id="avatarInput" accept="image/*" style="display: none;">
            </div>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div class="notifications-panel" id="notificationsPanel"></div>

        <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="screen active" id="homeScreen">
            <!-- Ø§Ù„Ø¨Ø­Ø« -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ØµØ¯Ù‚Ø§Ø¡...">
                <div class="search-results" id="searchResults"></div>
            </div>

            <!-- Ø§Ù„Ù‚ØµØµ -->
            <div class="stories-section">
                <div class="stories-header">
                    <h3><i class="fas fa-circle" style="color: var(--primary); font-size: 12px;"></i> Ø§Ù„Ù‚ØµØµ</h3>
                    <button class="btn-icon" style="width: 36px; height: 36px;" onclick="showAddStory()"><i class="fas fa-plus"></i></button>
                </div>
                <div class="stories-container" id="storiesList">
                    <div class="story-item" onclick="showAddStory()">
                        <div class="story-avatar add"><i class="fas fa-plus"></i></div>
                        <span class="story-name">Ø¥Ø¶Ø§ÙØ©</span>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© -->
            <div class="suggestions-section" id="suggestionsSection">
                <h3 style="margin-bottom: 15px;">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù…ØªØ§Ø¨Ø¹ØªÙƒ</h3>
                <div id="suggestionsList"></div>
            </div>

            <!-- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© -->
            <div class="chats-section">
                <h3 style="margin-bottom: 15px;">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h3>
                <div id="chatsList"></div>
            </div>
        </div>

        <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
        <div class="screen" id="profileScreen">
            <div style="padding: 20px;">
                <div style="background: var(--card); border-radius: 24px; padding: 30px 20px; border: 1px solid var(--border);">
                    <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù -->
                    <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                        <img src="" id="profileAvatar" class="user-avatar" style="width: 100px; height: 100px; margin-bottom: 15px;">
                        <h2 id="profileUsername"></h2>
                        <p id="profileBio" style="color: var(--text-secondary); text-align: center; margin: 10px 0;"></p>
                        
                        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                        <div style="display: flex; gap: 30px; margin: 20px 0;">
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: var(--primary);" id="followersCount">0</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Ù…ØªØ§Ø¨Ø¹ÙˆÙ†</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: var(--primary);" id="followingCount">0</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">ÙŠØªØ§Ø¨Ø¹</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 20px; font-weight: bold; color: var(--primary);" id="storiesCount">0</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">Ù‚ØµØµ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                    <h3 style="margin-bottom: 15px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
                    <input type="text" class="auth-input" id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…">
                    <input type="text" class="auth-input" id="editUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                    <textarea class="auth-input" id="editBio" placeholder="Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©" rows="3"></textarea>
                    <input type="password" class="auth-input" id="editPassword" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                    <button class="auth-btn" onclick="updateProfile()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    <button class="auth-btn" style="background: var(--danger);" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>

        <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div class="screen" id="settingsScreen">
            <div style="padding: 20px;">
                <div style="background: var(--card); border-radius: 24px; padding: 30px 20px; border: 1px solid var(--border);">
                    <h2 style="margin-bottom: 20px;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border);">
                        <span>Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¯Ø§ÙƒÙ†</span>
                        <div class="theme-switch" id="themeSwitch" style="width: 60px; height: 30px; background: var(--border); border-radius: 30px; position: relative; cursor: pointer;">
                            <div style="width: 26px; height: 26px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s;"></div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border);">
                        <span>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</span>
                        <input type="range" id="fontSize" min="12" max="24" value="16">
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0;">
                        <span>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</span>
                        <select id="fontFamily" style="background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px; border-radius: 12px;">
                            <option value="'Segoe UI', system-ui">Ø§ÙØªØ±Ø§Ø¶ÙŠ</option>
                            <option value="'Cairo', sans-serif">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option>
                            <option value="'Tajawal', sans-serif">ØªØ§Ø¬ÙˆØ§Ù„</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Ø³ØªØ¶Ø§Ù ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ) -->
        <!-- ØµÙØ­Ø© Ø§Ù„Ù‚ØµØµ (Ø³ØªØ¶Ø§Ù ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ) -->
        <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (Ø³ØªØ¶Ø§Ù ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ) -->
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ -->
    <div class="bottom-nav">
        <div class="nav-item active" data-screen="home"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-item" data-screen="profile"><i class="fas fa-user"></i><span>Ø§Ù„Ù…Ù„Ù</span></div>
        <div class="nav-item" data-screen="settings"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div id="toastContainer" style="position: fixed; bottom: 80px; left: 16px; right: 16px; z-index: 9999; pointer-events: none;"></div>

    <script>
        // ==================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„ÙŠØ© ====================
        const SERVER_URL = 'http://192.168.1.101:3000'; // ØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø­Ø³Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        let socket = null;
        let currentUser = {
            id: null,
            name: null,
            email: null,
            avatar: null,
            bio: null
        };
        let onlineUsers = new Map();
        let notifications = [];
        let stories = [];
        let chats = [];
        let suggestions = [];
        let following = new Set();

        // ==================== Ø¹Ù†Ø§ØµØ± DOM ====================
        const loadingScreen = document.getElementById('loadingScreen');
        const authScreen = document.getElementById('authScreen');
        const mainApp = document.getElementById('mainApp');
        const authContent = document.getElementById('authContent');

        // ==================== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ====================
        window.onload = () => {
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                showLoginTab();
            }, 1000);
        };

        // ==================== Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª ====================
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                this.classList.add('active');
                const target = this.dataset.screen;
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(target + 'Screen').classList.add('active');
                
                if (target === 'profile' && currentUser.id) loadProfile();
            });
        });

        window.navigateTo = (screen) => {
            document.querySelector(`[data-screen="${screen}"]`).click();
        };

        // ==================== Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ====================
        window.switchAuthTab = (tab) => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            if (tab === 'login') showLoginTab();
            else showSignupTab();
        };

        function showLoginTab() {
            authContent.innerHTML = `
                <div>
                    <input type="email" id="loginEmail" class="auth-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                    <input type="password" id="loginPassword" class="auth-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <button class="auth-btn" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                    <div class="auth-link" onclick="showForgotPassword()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</div>
                    <div id="authError"></div>
                </div>
            `;
        }

        function showSignupTab() {
            authContent.innerHTML = `
                <div>
                    <input type="email" id="signupEmail" class="auth-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                    <input type="text" id="signupName" class="auth-input" placeholder="Ø§Ù„Ø§Ø³Ù…">
                    <input type="password" id="signupPassword" class="auth-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <button class="auth-btn" onclick="sendVerification()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</button>
                    <div id="authError"></div>
                </div>
            `;
        }

        window.showForgotPassword = () => {
            authContent.innerHTML = `
                <div>
                    <h3 style="text-align: center; margin-bottom: 20px;">Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
                    <input type="email" id="forgotEmail" class="auth-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                    <button class="auth-btn" onclick="sendResetCode()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø²</button>
                    <div class="auth-link" onclick="showLoginTab()">Ø§Ù„Ø¹ÙˆØ¯Ø©</div>
                    <div id="authError"></div>
                </div>
            `;
        };

        // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ====================
        window.sendVerification = async () => {
            const email = document.getElementById('signupEmail')?.value;
            const username = document.getElementById('signupName')?.value;
            const password = document.getElementById('signupPassword')?.value;
            
            if (!email || !username || !password) {
                return showAuthError('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©');
            }

            try {
                const res = await fetch(`${SERVER_URL}/send-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    showVerificationCode(email, username, password);
                } else {
                    showAuthError(data.message);
                }
            } catch (err) {
                showAuthError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        };

        function showVerificationCode(email, username, password) {
            authContent.innerHTML = `
                <div>
                    <h3 style="text-align: center; margin-bottom: 10px;">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</h3>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„Ù‰ ${email}</p>
                    <div class="code-inputs">
                        <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this,0)" onkeyup="handleCodeInput(event,this,0)">
                        <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this,1)" onkeyup="handleCodeInput(event,this,1)">
                        <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this,2)" onkeyup="handleCodeInput(event,this,2)">
                        <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this,3)" onkeyup="handleCodeInput(event,this,3)">
                    </div>
                    <button class="auth-btn" onclick="verifyCode('${email}','${username}','${password}')">ØªØ£ÙƒÙŠØ¯</button>
                    <div id="authError"></div>
                </div>
            `;
        }

        window.moveToNext = (input, index) => {
            if (input.value.length === 1 && index < 3) {
                input.parentElement.children[index + 1].focus();
            }
        };

        window.handleCodeInput = (e, input, index) => {
            if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                input.parentElement.children[index - 1].focus();
            }
        };

        window.verifyCode = async (email, username, password) => {
            const inputs = document.querySelectorAll('.code-input');
            let code = '';
            inputs.forEach(i => code += i.value);
            
            if (code.length !== 4) {
                return showAuthError('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² ÙƒØ§Ù…Ù„Ø§Ù‹');
            }

            try {
                const verifyRes = await fetch(`${SERVER_URL}/verify-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });
                const verifyData = await verifyRes.json();
                
                if (verifyData.success) {
                    const registerRes = await fetch(`${SERVER_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, username, password })
                    });
                    const registerData = await registerRes.json();
                    
                    if (registerData.success) {
                        showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        showLoginTab();
                    } else {
                        showAuthError(registerData.message);
                    }
                } else {
                    showAuthError(verifyData.message);
                }
            } catch (err) {
                showAuthError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        };

        window.login = async () => {
            const email = document.getElementById('loginEmail')?.value;
            const password = document.getElementById('loginPassword')?.value;
            
            if (!email || !password) {
                return showAuthError('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            }

            try {
                const res = await fetch(`${SERVER_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    currentUser = {
                        id: data.userId,
                        name: data.username,
                        email: email,
                        avatar: data.avatar,
                        bio: data.bio
                    };
                    showAuthSuccess();
                } else {
                    showAuthError(data.message);
                }
            } catch (err) {
                showAuthError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        };

        function showAuthError(msg) {
            document.getElementById('authError').innerText = msg;
        }

        function showAuthSuccess() {
            showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`, 'success');
            authScreen.style.display = 'none';
            mainApp.style.display = 'block';
            document.getElementById('headerName').innerText = currentUser.name;
            document.getElementById('headerAvatar').src = currentUser.avatar || 'https://via.placeholder.com/48';
            connectSocket();
            loadInitialData();
        }

        // ==================== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ====================
        function connectSocket() {
            socket = io(SERVER_URL);
            
            socket.on('connect', () => {
                socket.emit('register', { name: currentUser.name, email: currentUser.email });
                updateConnectionStatus(true);
            });

            socket.on('disconnect', () => {
                updateConnectionStatus(false);
            });

            socket.on('users-updated', (users) => {
                onlineUsers.clear();
                users.forEach(u => onlineUsers.set(u.userId, u));
            });

            socket.on('follow-notification', (data) => {
                addNotification(`ğŸ“¢ ${data.followerName || 'Ù…Ø³ØªØ®Ø¯Ù…'} Ø¨Ø¯Ø£ Ù…ØªØ§Ø¨Ø¹ØªÙƒ`);
            });

            socket.on('new-story', (story) => {
                addNotification(`Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ${story.userName}`);
                loadStories();
            });

            socket.on('story-interaction', (data) => {
                const action = data.type === 'like' ? 'Ø£Ø¹Ø¬Ø¨' : 'Ø¹Ù„Ù‚';
                addNotification(`ğŸ”” ${data.userName} ${action} Ø¹Ù„Ù‰ Ù‚ØµØªÙƒ`);
            });

            socket.on('avatar-updated', (data) => {
                if (data.email === currentUser.email) {
                    document.getElementById('headerAvatar').src = data.avatar;
                    currentUser.avatar = data.avatar;
                }
            });
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerText = connected ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„';
            statusEl.style.color = connected ? 'var(--success)' : 'var(--danger)';
        }

        // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ====================
        async function loadInitialData() {
            await Promise.all([
                loadUserStats(),
                loadFollowing(),
                loadSuggestions(),
                loadStories(),
                loadChats()
            ]);
        }

        async function loadUserStats() {
            try {
                const res = await fetch(`${SERVER_URL}/followers/${currentUser.id}`);
                const data = await res.json();
                document.getElementById('followersCount').innerText = data.followers?.length || 0;
            } catch (err) {}
        }

        async function loadFollowing() {
            try {
                const res = await fetch(`${SERVER_URL}/following/${currentUser.id}`);
                const data = await res.json();
                if (data.success) {
                    following = new Set(data.following.map(f => f.userId));
                }
            } catch (err) {}
        }

        async function loadSuggestions() {
            try {
                const res = await fetch(`${SERVER_URL}/suggestions/${currentUser.id}`);
                const data = await res.json();
                if (data.success) {
                    suggestions = data.suggestions;
                    renderSuggestions();
                }
            } catch (err) {}
        }

        async function loadStories() {
            try {
                const res = await fetch(`${SERVER_URL}/stories/${currentUser.id}`);
                const data = await res.json();
                if (data.success) {
                    stories = data.stories;
                    renderStories();
                }
            } catch (err) {}
        }

        async function loadChats() {
            try {
                const res = await fetch(`${SERVER_URL}/chats/${currentUser.id}`);
                const data = await res.json();
                if (data.success) {
                    chats = data.chats;
                    renderChats();
                }
            } catch (err) {}
        }

        // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
        function renderSuggestions() {
            const list = document.getElementById('suggestionsList');
            if (!suggestions.length) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</p></div>';
                return;
            }
            list.innerHTML = suggestions.map(s => `
                <div class="suggestion-item">
                    <img src="${s.avatar || 'https://via.placeholder.com/50'}" class="suggestion-avatar">
                    <div class="suggestion-info">
                        <div class="suggestion-name">${s.username}</div>
                        <div class="suggestion-bio">${s.bio || ''}</div>
                    </div>
                    <button class="follow-btn ${following.has(s.userId) ? 'following' : ''}" onclick="toggleFollow('${s.userId}')">
                        ${following.has(s.userId) ? 'Ù…ØªØ§Ø¨Ø¹' : 'Ù…ØªØ§Ø¨Ø¹Ø©'}
                    </button>
                </div>
            `).join('');
        }

        function renderStories() {
            const container = document.getElementById('storiesList');
            let html = '<div class="story-item" onclick="showAddStory()"><div class="story-avatar add"><i class="fas fa-plus"></i></div><span class="story-name">Ø¥Ø¶Ø§ÙØ©</span></div>';
            
            stories.forEach(s => {
                html += `
                    <div class="story-item" onclick="viewStory('${s.id}')">
                        <img class="story-avatar" src="${s.userAvatar || 'https://via.placeholder.com/68'}">
                        <span class="story-name">${s.userName}</span>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderChats() {
            const list = document.getElementById('chatsList');
            if (!chats.length) {
                list.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</p></div>';
                return;
            }
            list.innerHTML = chats.map(c => {
                const user = onlineUsers.get(c.userId);
                return `
                    <div class="chat-item" onclick="openChat('${c.userId}','${c.userName}','${c.userAvatar}')">
                        <img src="${c.userAvatar || 'https://via.placeholder.com/56'}" class="chat-avatar">
                        <div class="chat-info">
                            <div class="chat-name">
                                ${c.userName}
                                ${user?.online ? '<span class="online-dot" style="width: 8px; height: 8px;"></span>' : '<span class="offline-dot" style="width: 8px; height: 8px;"></span>'}
                            </div>
                            <div class="chat-last">${c.lastMessage?.content || 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©'}</div>
                        </div>
                        ${c.unreadCount ? `<span class="unread-badge">${c.unreadCount}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ====================
        window.toggleFollow = async (targetId) => {
            const isFollowing = following.has(targetId);
            const endpoint = isFollowing ? '/unfollow' : '/follow';
            
            try {
                const res = await fetch(`${SERVER_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, targetId })
                });
                const data = await res.json();
                
                if (data.success) {
                    if (isFollowing) {
                        following.delete(targetId);
                    } else {
                        following.add(targetId);
                    }
                    renderSuggestions();
                    showToast(isFollowing ? 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©' : 'ØªÙ…Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'success');
                }
            } catch (err) {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£', 'error');
            }
        };

        // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ====================
        window.loadProfile = () => {
            document.getElementById('profileUsername').innerText = currentUser.name;
            document.getElementById('profileAvatar').src = currentUser.avatar || 'https://via.placeholder.com/100';
            document.getElementById('profileBio').innerText = currentUser.bio || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ©';
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editUsername').value = currentUser.name;
            document.getElementById('editBio').value = currentUser.bio || '';
        };

        window.updateProfile = async () => {
            const name = document.getElementById('editName').value;
            const username = document.getElementById('editUsername').value;
            const bio = document.getElementById('editBio').value;
            const pass = document.getElementById('editPassword').value;

            try {
                const res = await fetch(`${SERVER_URL}/update-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentUser.email,
                        username: name,
                        bio: bio,
                        password: pass || undefined
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    currentUser.name = name;
                    currentUser.bio = bio;
                    document.getElementById('headerName').innerText = name;
                    showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            } catch (err) {
                showToast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
            }
        };

        // ==================== Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ====================
        document.getElementById('uploadAvatarBtn').addEventListener('click', () => {
            document.getElementById('avatarInput').click();
        });

        document.getElementById('avatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const res = await fetch(`${SERVER_URL}/update-avatar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: currentUser.email, avatar: ev.target.result })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        document.getElementById('headerAvatar').src = ev.target.result;
                        currentUser.avatar = ev.target.result;
                        showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©', 'success');
                    }
                } catch (err) {
                    showToast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
                }
            };
            reader.readAsDataURL(file);
        });

        // ==================== Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====================
        function addNotification(text, avatar) {
            notifications.unshift({ text, avatar, time: Date.now() });
            document.getElementById('notificationsBtn').classList.add('has-notification');
            renderNotifications();
        }

        function renderNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.innerHTML = notifications.map(n => `
                <div class="notification-item">
                    <img src="${n.avatar || 'https://via.placeholder.com/44'}" class="notification-avatar">
                    <div>${n.text}</div>
                </div>
            `).join('');
        }

        document.getElementById('notificationsBtn').addEventListener('click', () => {
            const panel = document.getElementById('notificationsPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            document.getElementById('notificationsBtn').classList.remove('has-notification');
        });

        // ==================== Ø§Ù„Ø¨Ø­Ø« ====================
        document.getElementById('searchInput').addEventListener('input', async (e) => {
            const term = e.target.value.trim();
            if (term.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }

            try {
                const res = await fetch(`${SERVER_URL}/search-users?q=${term}`);
                const data = await res.json();
                
                if (data.success && data.users.length) {
                    document.getElementById('searchResults').innerHTML = data.users.map(u => `
                        <div class="search-item" onclick="selectUser('${u.userId}','${u.username}','${u.avatar}')">
                            <img src="${u.avatar || 'https://via.placeholder.com/40'}" class="search-avatar">
                            <div>
                                <div style="font-weight: 600;">${u.username}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${u.bio || ''}</div>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('searchResults').style.display = 'block';
                }
            } catch (err) {}
        });

        window.selectUser = (userId, name, avatar) => {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = name;
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©
        };

        // ==================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ====================
        const themeSwitch = document.getElementById('themeSwitch');
        themeSwitch.addEventListener('click', () => {
            themeSwitch.classList.toggle('active');
            document.body.classList.toggle('light-mode');
        });

        document.getElementById('fontSize').addEventListener('input', (e) => {
            document.body.style.fontSize = e.target.value + 'px';
        });

        document.getElementById('fontFamily').addEventListener('change', (e) => {
            document.body.style.fontFamily = e.target.value;
        });

        // ==================== Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ====================
        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: var(--card);
                color: var(--text);
                padding: 14px 20px;
                border-radius: 30px;
                border-right: 4px solid ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--primary)'};
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                margin-bottom: 8px;
                animation: slideIn 0.3s;
                font-size: 14px;
                max-width: 300px;
                margin-left: auto;
                margin-right: auto;
            `;
            toast.innerText = msg;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==================== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ====================
        window.logout = () => {
            if (socket) socket.disconnect();
            mainApp.style.display = 'none';
            authScreen.style.display = 'flex';
            showLoginTab();
        };

        // ==================== Ø³ØªØ¶Ø§Ù Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ ====================
        window.showAddStory = () => {};
        window.viewStory = (id) => {};
        window.openChat = (id, name, avatar) => {};
    </script>
<!-- 
    =====================================================
    Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø±ÙˆÙ†
    Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø£ÙˆÙ„ ÙˆÙ‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ </body>
    =====================================================
-->

<!-- ====== ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ====== -->
<div class="screen" id="chatScreen">
    <div class="chat-container" style="display: flex; flex-direction: column; height: 100vh; background: var(--bg);">
        <!-- Ø±Ø£Ø³ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
        <div class="chat-header" style="background: var(--card); padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px;">
            <button class="btn-icon" onclick="closeChat()" style="width: 40px; height: 40px;"><i class="fas fa-arrow-right"></i></button>
            <img src="" id="chatAvatar" class="user-avatar" style="width: 45px; height: 45px;">
            <div style="flex: 1;">
                <div class="chat-name" id="chatName" style="font-weight: 600;"></div>
                <div class="chat-status" id="chatStatus" style="font-size: 13px; color: var(--text-secondary);"></div>
            </div>
            <button class="btn-icon" onclick="startAudioCall()" style="width: 40px; height: 40px;"><i class="fas fa-phone"></i></button>
            <button class="btn-icon" onclick="startVideoCall()" style="width: 40px; height: 40px;"><i class="fas fa-video"></i></button>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div class="messages-area" id="messagesArea" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px;"></div>

        <!-- ÙÙ‚Ø§Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±) -->
        <div class="typing-bubble" id="typingBubble" style="display: none; align-items: center; gap: 5px; padding: 8px 16px; background: var(--card); border-radius: 30px; width: fit-content; margin: 0 20px 10px;">
            <span style="width: 6px; height: 6px; background: var(--text-secondary); border-radius: 50%; animation: typingDot 1.4s infinite;"></span>
            <span style="width: 6px; height: 6px; background: var(--text-secondary); border-radius: 50%; animation: typingDot 1.4s infinite; animation-delay: 0.2s;"></span>
            <span style="width: 6px; height: 6px; background: var(--text-secondary); border-radius: 50%; animation: typingDot 1.4s infinite; animation-delay: 0.4s;"></span>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
        <div class="chat-input-area" style="background: var(--card); padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; position: relative;">
            <button class="btn-icon" id="chatAttachBtn" style="width: 45px; height: 45px;"><i class="fas fa-paperclip"></i></button>
            
            <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø±ÙØ§Ù‚ -->
            <div class="attach-options" id="attachOptions" style="position: absolute; bottom: 70px; left: 20px; background: var(--card); border-radius: 20px; padding: 12px; display: none; flex-direction: column; gap: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 100;">
                <button onclick="sendMedia('image')" style="background: none; border: none; color: var(--text); padding: 12px 20px; display: flex; align-items: center; gap: 12px; width: 100%; border-radius: 12px; cursor: pointer;">
                    <i class="fas fa-image"></i> ØµÙˆØ±Ø©
                </button>
                <button onclick="sendMedia('video')" style="background: none; border: none; color: var(--text); padding: 12px 20px; display: flex; align-items: center; gap: 12px; width: 100%; border-radius: 12px; cursor: pointer;">
                    <i class="fas fa-video"></i> ÙÙŠØ¯ÙŠÙˆ
                </button>
                <button onclick="sendMedia('file')" style="background: none; border: none; color: var(--text); padding: 12px 20px; display: flex; align-items: center; gap: 12px; width: 100%; border-radius: 12px; cursor: pointer;">
                    <i class="fas fa-file"></i> Ù…Ù„Ù
                </button>
            </div>

            <input type="text" class="chat-input" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="flex: 1; padding: 14px 18px; border-radius: 30px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none;">

            <button class="record-btn" id="recordBtn" style="width: 45px; height: 45px; border-radius: 50%; background: var(--danger); color: white; border: none; display: flex; align-items: center; justify-content: center; position: relative;">
                <i class="fas fa-microphone"></i>
            </button>

            <button class="send-btn" id="sendBtn" style="width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; display: none; align-items: center; justify-content: center;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- ====== ØµÙØ­Ø© Ø§Ù„Ù‚ØµØµ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© ====== -->
<div class="screen" id="storyViewerScreen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 10000; display: none; overflow-y: auto;">
    <!-- Ø±Ø£Ø³ Ø§Ù„Ù‚ØµØ© -->
    <div style="position: sticky; top: 0; background: rgba(0,0,0,0.9); padding: 15px; display: flex; align-items: center; gap: 15px; backdrop-filter: blur(10px); z-index: 10;">
        <button class="btn-icon" onclick="closeStoryViewer()" style="background: rgba(255,255,255,0.2); color: white;"><i class="fas fa-arrow-right"></i></button>
        <img src="" id="storyUserAvatar" class="user-avatar" style="width: 45px; height: 45px;">
        <div style="flex: 1;">
            <div id="storyUserName" style="font-weight: 600; color: white;"></div>
            <div id="storyTime" style="font-size: 12px; color: rgba(255,255,255,0.6);"></div>
        </div>
        <button class="btn-icon" onclick="showStoryMenu()" style="background: rgba(255,255,255,0.2); color: white;"><i class="fas fa-ellipsis-h"></i></button>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚ØµØ© -->
    <div style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
        <img src="" id="storyImage" style="max-width: 100%; max-height: 60vh; border-radius: 20px; display: none;">
        <video src="" id="storyVideo" style="max-width: 100%; max-height: 60vh; border-radius: 20px; display: none;" controls></video>
        <div id="storyText" style="color: white; font-size: 24px; text-align: center; padding: 30px; background: rgba(255,255,255,0.1); border-radius: 20px; width: 100%; display: none;"></div>
    </div>

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù‚ØµØ© -->
    <div style="display: flex; justify-content: space-around; padding: 20px; background: rgba(0,0,0,0.8); margin: 20px; border-radius: 30px;">
        <div style="text-align: center;">
            <i class="fas fa-eye" style="color: var(--primary); font-size: 20px;"></i>
            <div id="storyViewsCount" style="color: white; font-weight: bold;">0</div>
        </div>
        <div style="text-align: center;">
            <i class="fas fa-heart" style="color: #f472b6; font-size: 20px;"></i>
            <div id="storyLikesCount" style="color: white; font-weight: bold;">0</div>
        </div>
        <div style="text-align: center;">
            <i class="fas fa-comment" style="color: var(--success); font-size: 20px;"></i>
            <div id="storyCommentsCount" style="color: white; font-weight: bold;">0</div>
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† -->
    <div id="viewersList" style="padding: 20px; background: rgba(0,0,0,0.8); margin: 20px; border-radius: 30px; display: none;">
        <h4 style="color: white; margin-bottom: 15px;">Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</h4>
        <div id="viewersContainer"></div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ -->
    <div style="display: flex; gap: 15px; padding: 20px; background: rgba(0,0,0,0.8); margin: 20px; border-radius: 30px;">
        <button class="btn-icon" id="storyLikeBtn" onclick="likeStory()" style="background: rgba(255,255,255,0.2); color: white; width: 50px; height: 50px;">
            <i class="fas fa-heart"></i>
        </button>
        <button class="btn-icon" onclick="toggleViewersList()" style="background: rgba(255,255,255,0.2); color: white; width: 50px; height: 50px;">
            <i class="fas fa-eye"></i>
        </button>
        <input type="text" id="storyCommentInput" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." style="flex: 1; padding: 15px; border-radius: 30px; border: none; background: rgba(255,255,255,0.2); color: white; outline: none;">
        <button class="btn-icon" onclick="sendStoryComment()" style="background: var(--primary); color: white; width: 50px; height: 50px;">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>

    <!-- Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª -->
    <div id="commentsList" style="padding: 20px; background: rgba(0,0,0,0.8); margin: 20px; border-radius: 30px;"></div>
</div>

<!-- ====== Ù†Ø§ÙØ°Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚ØµØ© ====== -->
<div class="context-menu" id="storyMenu" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); border-radius: 30px; padding: 20px; width: 250px; display: none; z-index: 11000;">
    <button onclick="deleteStory()" style="background: none; border: none; color: var(--danger); padding: 15px; width: 100%; display: flex; align-items: center; gap: 10px; justify-content: center;">
        <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù‚ØµØ©
    </button>
    <hr style="border-color: var(--border); margin: 10px 0;">
    <button onclick="closeStoryMenu()" style="background: none; border: none; color: var(--text); padding: 15px; width: 100%;">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<!-- ====== Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ù‚ØµØ© ====== -->
<div class="context-menu" id="addStoryMenu" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); border-radius: 30px; padding: 20px; width: 280px; display: none; z-index: 11000;">
    <h3 style="text-align: center; margin-bottom: 20px;">Ø¥Ø¶Ø§ÙØ© Ù‚ØµØ©</h3>
    <button onclick="addTextStory()" style="background: none; border: none; color: var(--text); padding: 15px; width: 100%; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-font"></i> Ù†Øµ
    </button>
    <button onclick="addImageStory()" style="background: none; border: none; color: var(--text); padding: 15px; width: 100%; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-image"></i> ØµÙˆØ±Ø©
    </button>
    <button onclick="addVideoStory()" style="background: none; border: none; color: var(--text); padding: 15px; width: 100%; display: flex; align-items: center; gap: 15px;">
        <i class="fas fa-video"></i> ÙÙŠØ¯ÙŠÙˆ
    </button>
    <hr style="border-color: var(--border); margin: 15px 0;">
    <button onclick="closeAddStory()" style="background: none; border: none; color: var(--text-secondary); padding: 10px; width: 100%;">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<!-- ====== Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ====== -->
<div class="call-modal" id="incomingCallModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; align-items: center; justify-content: center; z-index: 12000; backdrop-filter: blur(15px);">
    <div style="background: var(--card); padding: 40px 30px; border-radius: 60px; text-align: center; max-width: 400px; width: 90%;">
        <div style="width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; background: linear-gradient(135deg, var(--primary), #8b5cf6); display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; font-weight: bold; border: 4px solid var(--primary);" id="callerAvatar">
            ?
        </div>
        <h2 style="font-size: 28px; margin-bottom: 10px;" id="callerName"></h2>
        <p style="color: var(--text-secondary); font-size: 18px; margin-bottom: 30px;" id="callType"></p>
        
        <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ù†ÙŠÙ† Ø§Ù„Ù…ØªØ­Ø±Ùƒ -->
        <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 30px;">
            <div style="width: 12px; height: 12px; background: var(--primary); border-radius: 50%; animation: ringWave 1s infinite;"></div>
            <div style="width: 12px; height: 12px; background: var(--primary); border-radius: 50%; animation: ringWave 1s infinite; animation-delay: 0.2s;"></div>
            <div style="width: 12px; height: 12px; background: var(--primary); border-radius: 50%; animation: ringWave 1s infinite; animation-delay: 0.4s;"></div>
        </div>

        <div style="display: flex; gap: 30px; justify-content: center;">
            <button class="call-btn" onclick="rejectCall()" style="width: 70px; height: 70px; border-radius: 50%; border: none; background: var(--danger); color: white; font-size: 28px; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
            <button class="call-btn" onclick="acceptCall()" style="width: 70px; height: 70px; border-radius: 50%; border: none; background: var(--success); color: white; font-size: 28px; cursor: pointer;">
                <i class="fas fa-phone-alt"></i>
            </button>
        </div>
        <button class="auth-link" onclick="muteRingtone()" style="margin-top: 20px;">ÙƒØªÙ… Ø§Ù„Ø±Ù†Ø©</button>
    </div>
</div>

<!-- ====== Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø© (ÙÙŠØ¯ÙŠÙˆ) ====== -->
<div class="video-call" id="videoCallContainer" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; display: none; flex-direction: column; z-index: 11000;">
    <!-- Ø±Ø£Ø³ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© -->
    <div style="position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10;">
        <div style="background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); padding: 8px 20px; border-radius: 40px; color: white;">
            <span id="callTimer">00:00</span>
        </div>
        <div style="display: flex; gap: 15px;">
            <button class="btn-icon" id="callMicBtn" style="background: rgba(0,0,0,0.5); color: white;"><i class="fas fa-microphone"></i></button>
            <button class="btn-icon" id="callCamBtn" style="background: rgba(0,0,0,0.5); color: white;"><i class="fas fa-video"></i></button>
            <button class="btn-icon" id="callEndBtn" style="background: var(--danger); color: white;"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <!-- ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¨Ø¹ÙŠØ¯ -->
    <div style="flex: 1; position: relative;">
        <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
        <div style="position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 30px; color: white;" id="remoteName"></div>
    </div>

    <!-- ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØªØµÙ„ (ØµØºÙŠØ±) -->
    <div style="position: absolute; bottom: 30px; left: 20px; width: 100px; height: 140px; border-radius: 20px; overflow: hidden; border: 2px solid var(--primary); background: #000;">
        <video id="localVideo" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
    </div>

    <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <button class="btn-icon" onclick="flipCamera()" style="position: absolute; bottom: 30px; right: 20px; background: rgba(0,0,0,0.5); color: white; z-index: 20;">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<!-- ====== Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© ====== -->
<style>
    @keyframes ringWave {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5); opacity: 0.5; }
    }

    @keyframes typingDot {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
    }

    @keyframes wave {
        0%, 100% { transform: scaleY(0.3); }
        50% { transform: scaleY(1); }
    }

    .message {
        max-width: 70%;
        word-wrap: break-word;
        animation: fadeIn 0.2s;
    }

    .message.sent { align-self: flex-end; }
    .message.received { align-self: flex-start; }

    .message-text {
        padding: 12px 16px;
        border-radius: 20px;
        background: var(--card);
    }

    .message.sent .message-text {
        background: var(--primary);
        color: white;
        border-bottom-left-radius: 4px;
    }

    .message.received .message-text {
        background: var(--card);
        border-bottom-right-radius: 4px;
    }

    .message-image, .message-video {
        max-width: 250px;
        border-radius: 20px;
        cursor: pointer;
    }

    .audio-message {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255,255,255,0.1);
        padding: 12px 18px;
        border-radius: 40px;
        cursor: pointer;
    }

    .audio-wave {
        display: flex;
        align-items: center;
        gap: 4px;
        height: 24px;
    }

    .audio-wave span {
        width: 4px;
        height: 100%;
        background: currentColor;
        border-radius: 4px;
        animation: wave 1s infinite;
    }

    .audio-wave span:nth-child(2) { animation-delay: 0.1s; }
    .audio-wave span:nth-child(3) { animation-delay: 0.2s; }
    .audio-wave span:nth-child(4) { animation-delay: 0.3s; }

    .record-btn.recording {
        animation: pulseRecord 1s infinite;
    }

    .record-btn.recording::after {
        content: '';
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 2px solid var(--danger);
        animation: ripple 1s infinite;
    }

    @keyframes pulseRecord {
        0% { box-shadow: 0 0 0 0 rgba(220,38,38,0.7); }
        70% { box-shadow: 0 0 0 15px rgba(220,38,38,0); }
    }

    @keyframes ripple {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(1.5); opacity: 0; }
    }

    .recording-indicator {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--danger);
        color: white;
        padding: 8px 20px;
        border-radius: 40px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        animation: slideDown 0.2s;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translate(-50%, -10px); }
        to { opacity: 1; transform: translate(-50%, 0); }
    }

    .uploading-indicator {
        width: 20px;
        height: 20px;
        border: 3px solid var(--primary);
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .theme-switch.active div { left: 32px; }
    .theme-switch.active { background: var(--primary); }

    #storyLikeBtn.liked { color: #f472b6; animation: heartPop 0.3s; }
    @keyframes heartPop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }
</style>

<script>
    // ==================== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ====================
    let currentChat = null;
    let chatMessages = [];
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let recordStartY = 0;
    let typingTimeout = null;

    // ==================== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù‚ØµØµ ====================
    let currentStory = null;
    let storyViewers = [];
    let storyComments = [];

    // ==================== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª ====================
    let peerConnection = null;
    let localStream = null;
    let currentCall = null;
    let isCallActive = false;
    let incomingCall = null;
    let ringtone = null;
    let callTimer = null;
    let callSeconds = 0;

    // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ====================
    window.openChat = (userId, userName, userAvatar) => {
        currentChat = { id: userId, name: userName, avatar: userAvatar };
        document.querySelector('.bottom-nav').classList.add('hide');
        document.getElementById('chatName').innerText = userName;
        document.getElementById('chatAvatar').src = userAvatar || 'https://via.placeholder.com/45';
        document.getElementById('chatScreen').classList.add('active');
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('chatScreen').classList.add('active');
        loadMessages();
    };

    window.closeChat = () => {
        document.querySelector('.bottom-nav').classList.remove('hide');
        document.querySelector('[data-screen="home"]').click();
    };

    async function loadMessages() {
        try {
            const res = await fetch(`${SERVER_URL}/messages/${currentUser.id}/${currentChat.id}`);
            const data = await res.json();
            if (data.success) {
                chatMessages = data.messages;
                renderMessages();
            }
        } catch (err) {
            showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„', 'error');
        }
    }

    function renderMessages() {
        const area = document.getElementById('messagesArea');
        area.innerHTML = '';
        
        chatMessages.forEach(msg => {
            const div = document.createElement('div');
            div.className = `message ${msg.from === currentUser.id ? 'sent' : 'received'}`;

            if (msg.type === 'text') {
                div.innerHTML = `<div class="message-text">${escapeHtml(msg.content)}</div>`;
            } else if (msg.type === 'image') {
                div.innerHTML = `<img src="${msg.content}" class="message-image" onclick="viewMedia('${msg.content}')">`;
            } else if (msg.type === 'video') {
                div.innerHTML = `<video src="${msg.content}" class="message-video" onclick="this.paused ? this.play() : this.pause()"></video>`;
            } else if (msg.type === 'audio') {
                div.innerHTML = `
                    <div class="audio-message" onclick="playAudio(this)" data-src="${msg.content}">
                        <i class="fas fa-play"></i>
                        <div class="audio-wave">
                            <span></span><span></span><span></span><span></span>
                        </div>
                        <span class="audio-duration">${msg.duration || '0:03'}</span>
                    </div>
                `;
            }

            area.appendChild(div);
        });
        
        area.scrollTop = area.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ ====================
    const recordBtn = document.getElementById('recordBtn');
    recordBtn.addEventListener('mousedown', startRecording);
    recordBtn.addEventListener('touchstart', startRecording);
    recordBtn.addEventListener('mouseup', stopRecording);
    recordBtn.addEventListener('touchend', stopRecording);
    recordBtn.addEventListener('mouseleave', cancelRecording);

    function startRecording(e) {
        if (!currentChat) return;
        e.preventDefault();
        isRecording = true;
        recordStartY = e.clientY || (e.touches?.[0]?.clientY || 0);
        recordBtn.classList.add('recording');
        recordBtn.innerHTML = '<i class="fas fa-stop"></i>';

        const indicator = document.createElement('div');
        indicator.className = 'recording-indicator';
        indicator.id = 'recordingIndicator';
        indicator.innerHTML = '<i class="fas fa-microphone"></i> <span id="recTime">0:00</span> <i class="fas fa-arrow-up"></i> Ø§Ø³Ø­Ø¨ Ù„Ù„Ø¥Ù„ØºØ§Ø¡';
        document.querySelector('.chat-input-area').appendChild(indicator);

        let sec = 0;
        window.recTimer = setInterval(() => {
            sec++;
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            document.getElementById('recTime').innerText = `${m}:${s < 10 ? '0' + s : s}`;
        }, 1000);

        startAudioRecording();
    }

    async function startAudioRecording() {
        audioChunks = [];
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.onload = () => {
                    socket.emit('send-message', {
                        to: currentChat.id,
                        type: 'audio',
                        content: reader.result,
                        duration: document.getElementById('recTime')?.innerText || '0:03'
                    });
                };
                reader.readAsDataURL(blob);
                stream.getTracks().forEach(t => t.stop());
            };
            mediaRecorder.start();
            socket.emit('recording', { to: currentChat.id, isRecording: true });
        } catch (err) {
            showToast('Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ØªØ§Ø­', 'error');
            cancelRecording();
        }
    }

    function stopRecording(e) {
        if (!isRecording) return;
        const endY = e.clientY || (e.changedTouches?.[0]?.clientY || 0);
        if (recordStartY - endY > 100) {
            cancelRecording();
            showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'info');
            return;
        }
        finishRecording();
    }

    function cancelRecording() {
        if (mediaRecorder?.state === 'recording') {
            mediaRecorder.stop();
            mediaRecorder.stream?.getTracks().forEach(t => t.stop());
        }
        resetRecordingUI();
    }

    function finishRecording() {
        if (mediaRecorder?.state === 'recording') {
            mediaRecorder.stop();
            mediaRecorder.stream?.getTracks().forEach(t => t.stop());
        }
        resetRecordingUI();
        if (currentChat) {
            socket.emit('recording', { to: currentChat.id, isRecording: false });
        }
    }

    function resetRecordingUI() {
        isRecording = false;
        recordBtn.classList.remove('recording');
        recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        document.getElementById('recordingIndicator')?.remove();
        clearInterval(window.recTimer);
    }

    // ==================== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ====================
    document.getElementById('chatInput').addEventListener('input', function() {
        const record = document.getElementById('recordBtn');
        const send = document.getElementById('sendBtn');
        
        if (this.value.trim()) {
            record.style.display = 'none';
            send.style.display = 'flex';
            if (currentChat) {
                socket.emit('typing', { to: currentChat.id, isTyping: true });
                if (typingTimeout) clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    socket.emit('typing', { to: currentChat.id, isTyping: false });
                }, 1000);
            }
        } else {
            record.style.display = 'flex';
            send.style.display = 'none';
        }
    });

    document.getElementById('sendBtn').addEventListener('click', () => {
        const input = document.getElementById('chatInput');
        if (input.value.trim() && currentChat) {
            socket.emit('send-message', {
                to: currentChat.id,
                type: 'text',
                content: input.value
            });
            input.value = '';
            document.getElementById('recordBtn').style.display = 'flex';
            document.getElementById('sendBtn').style.display = 'none';
        }
    });

    document.getElementById('chatAttachBtn').addEventListener('click', () => {
        const opt = document.getElementById('attachOptions');
        opt.style.display = opt.style.display === 'flex' ? 'none' : 'flex';
    });

    window.sendMedia = (type) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = type === 'image' ? 'image/*' : type === 'video' ? 'video/*' : '*/*';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onloadstart = () => {
                const temp = document.createElement('div');
                temp.className = 'message sent';
                temp.id = 'uploadingMsg';
                temp.innerHTML = '<div style="display: flex; align-items: center; gap: 10px;"><div class="uploading-indicator"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</div>';
                document.getElementById('messagesArea').appendChild(temp);
            };

            reader.onload = (ev) => {
                document.getElementById('uploadingMsg')?.remove();
                socket.emit('send-message', {
                    to: currentChat.id,
                    type: type,
                    content: ev.target.result
                });
            };
            reader.readAsDataURL(file);
        };
        input.click();
        document.getElementById('attachOptions').style.display = 'none';
    };

    // ==================== Ø£Ø­Ø¯Ø§Ø« Socket Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© ====================
    socket?.on('new-message', (msg) => {
        if (currentChat && (msg.from === currentChat.id || msg.to === currentChat.id)) {
            chatMessages.push(msg);
            renderMessages();
            if (msg.to === currentUser.id) {
                socket.emit('mark-seen', { from: msg.from });
            }
        } else {
            loadChats();
        }
    });

    socket?.on('message-sent', (msg) => {
        if (currentChat && msg.from === currentUser.id && msg.to === currentChat.id) {
            chatMessages.push(msg);
            renderMessages();
        }
    });

    socket?.on('typing', (data) => {
        if (currentChat && data.from === currentChat.id) {
            const bubble = document.getElementById('typingBubble');
            bubble.style.display = data.isTyping ? 'flex' : 'none';
        }
    });

    socket?.on('messages-seen', (data) => {
        if (currentChat && data.by === currentChat.id) {
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        }
    });

    // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚ØµØµ ====================
    window.showAddStory = () => {
        document.getElementById('addStoryMenu').style.display = 'block';
    };

    window.closeAddStory = () => {
        document.getElementById('addStoryMenu').style.display = 'none';
    };

    window.addTextStory = () => {
        const text = prompt('Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ù‚ØµØ©:');
        if (text?.trim()) {
            closeAddStory();
            showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...', 'info');
            fetch(`${SERVER_URL}/post-story`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: currentUser.id, text })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'success');
                    loadStories();
                }
            });
        }
    };

    window.addImageStory = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                closeAddStory();
                showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...', 'info');
                fetch(`${SERVER_URL}/post-story`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, media: ev.target.result })
                }).then(res => res.json()).then(data => {
                    if (data.success) {
                        showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'success');
                        loadStories();
                    }
                });
            };
            reader.readAsDataURL(file);
        };
        input.click();
    };

    window.addVideoStory = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'video/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                closeAddStory();
                showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...', 'info');
                fetch(`${SERVER_URL}/post-story`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, media: ev.target.result })
                }).then(res => res.json()).then(data => {
                    if (data.success) {
                        showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'success');
                        loadStories();
                    }
                });
            };
            reader.readAsDataURL(file);
        };
        input.click();
    };

    window.viewStory = async (storyId) => {
        try {
            const res = await fetch(`${SERVER_URL}/story/${storyId}`);
            const data = await res.json();
            if (data.success) {
                currentStory = data.story;
                document.getElementById('storyUserAvatar').src = currentStory.userAvatar || 'https://via.placeholder.com/45';
                document.getElementById('storyUserName').innerText = currentStory.userName;
                document.getElementById('storyTime').innerText = new Date(currentStory.createdAt).toLocaleString('ar');

                document.getElementById('storyImage').style.display = 'none';
                document.getElementById('storyVideo').style.display = 'none';
                document.getElementById('storyText').style.display = 'none';

                if (currentStory.type === 'image') {
                    document.getElementById('storyImage').src = currentStory.media;
                    document.getElementById('storyImage').style.display = 'block';
                } else if (currentStory.type === 'video') {
                    document.getElementById('storyVideo').src = currentStory.media;
                    document.getElementById('storyVideo').style.display = 'block';
                } else {
                    document.getElementById('storyText').innerText = currentStory.text;
                    document.getElementById('storyText').style.display = 'block';
                }

                await loadStoryInteractions(storyId);
                document.getElementById('storyViewerScreen').style.display = 'block';

                fetch(`${SERVER_URL}/view-story`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ storyId, userId: currentUser.id })
                });
            }
        } catch (err) {
            showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ©', 'error');
        }
    };

    async function loadStoryInteractions(storyId) {
        try {
            const res = await fetch(`${SERVER_URL}/story-interactions/${storyId}`);
            const data = await res.json();
            if (data.success) {
                document.getElementById('storyViewsCount').innerText = data.viewers?.length || 0;
                document.getElementById('storyLikesCount').innerText = data.likes || 0;
                document.getElementById('storyCommentsCount').innerText = data.comments?.length || 0;

                const viewers = data.viewers || [];
                document.getElementById('viewersContainer').innerHTML = viewers.map(v => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <img src="${v.avatar || 'https://via.placeholder.com/35'}" style="width: 35px; height: 35px; border-radius: 50%;">
                        <span style="flex: 1;">${v.name}</span>
                        ${v.liked ? '<i class="fas fa-heart" style="color: #f472b6;"></i>' : ''}
                    </div>
                `).join('');

                const comments = data.comments || [];
                document.getElementById('commentsList').innerHTML = comments.map(c => `
                    <div style="display: flex; gap: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 20px; margin-bottom: 10px;">
                        <img src="${c.avatar || 'https://via.placeholder.com/30'}" style="width: 30px; height: 30px; border-radius: 50%;">
                        <div style="flex: 1;">
                            <strong>${c.name}</strong><br>
                            ${c.content}
                        </div>
                    </div>
                `).join('');
            }
        } catch (err) {}
    }

    window.closeStoryViewer = () => {
        document.getElementById('storyViewerScreen').style.display = 'none';
        const video = document.getElementById('storyVideo');
        if (video) video.pause();
    };

    window.likeStory = () => {
        if (!currentStory) return;
        const btn = document.getElementById('storyLikeBtn');
        btn.classList.toggle('liked');
        
        fetch(`${SERVER_URL}/interact`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                storyId: currentStory.id,
                userId: currentUser.id,
                type: 'like'
            })
        });
    };

    window.sendStoryComment = () => {
        const input = document.getElementById('storyCommentInput');
        const comment = input.value.trim();
        if (!comment || !currentStory) return;
        input.value = '';

        fetch(`${SERVER_URL}/interact`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                storyId: currentStory.id,
                userId: currentUser.id,
                type: 'comment',
                content: comment
            })
        }).then(() => loadStoryInteractions(currentStory.id));
    };

    window.toggleViewersList = () => {
        const list = document.getElementById('viewersList');
        list.style.display = list.style.display === 'none' ? 'block' : 'none';
    };

    window.showStoryMenu = () => {
        if (currentStory && currentStory.userId === currentUser.id) {
            document.getElementById('storyMenu').style.display = 'block';
        }
    };

    window.closeStoryMenu = () => {
        document.getElementById('storyMenu').style.display = 'none';
    };

    window.deleteStory = () => {
        if (!currentStory || currentStory.userId !== currentUser.id) return;
        if (confirm('Ø­Ø°Ù Ø§Ù„Ù‚ØµØ©ØŸ')) {
            fetch(`${SERVER_URL}/delete-story`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ storyId: currentStory.id })
            }).then(() => {
                showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
                closeStoryViewer();
                closeStoryMenu();
                loadStories();
            });
        }
    };

    // ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª ====================
    window.startAudioCall = async () => {
        if (!currentChat) return;
        const user = onlineUsers.get(currentChat.id);
        if (!user) return showToast('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªØµÙ„', 'warning');
        startCall('audio', user);
    };

    window.startVideoCall = async () => {
        if (!currentChat) return;
        const user = onlineUsers.get(currentChat.id);
        if (!user) return showToast('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªØµÙ„', 'warning');
        startCall('video', user);
    };

    async function startCall(type, user) {
        try {
            if (!localStream) {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: type === 'video',
                    audio: true
                });
            } else if (type === 'video' && !localStream.getVideoTracks().length) {
                const newStream = await navigator.mediaDevices.getUserMedia({ video: true });
                localStream.addTrack(newStream.getVideoTracks()[0]);
            }

            peerConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

            peerConnection.ontrack = (e) => {
                document.getElementById('remoteVideo').srcObject = e.streams[0];
            };

            peerConnection.onicecandidate = (e) => {
                if (e.candidate) {
                    socket.emit('ice-candidate', { to: user.id, candidate: e.candidate });
                }
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            currentCall = user.id;
            socket.emit('call', {
                to: user.id,
                from: currentUser.name,
                fromId: currentUser.id,
                type,
                offer
            });

            document.getElementById('videoCallContainer').style.display = 'flex';
            document.getElementById('remoteName').innerText = user.name;
            document.getElementById('localVideo').srcObject = localStream;

        } catch (err) {
            showToast('ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©', 'error');
        }
    }

    socket?.on('offer', async (data) => {
        if (isCallActive) {
            socket.emit('reject-call', { to: data.fromId });
            return;
        }

        incomingCall = data;
        document.getElementById('callerName').innerText = data.from;
        document.getElementById('callerAvatar').innerText = data.from[0];
        document.getElementById('callType').innerText = data.type === 'video' ? 'Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ' : 'Ù…ÙƒØ§Ù„Ù…Ø© ØµÙˆØªÙŠØ©';
        document.getElementById('incomingCallModal').style.display = 'flex';

        ringtone = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
        ringtone.loop = true;
        ringtone.play().catch(() => {});
    });

    window.acceptCall = async () => {
        if (!incomingCall) return;
        muteRingtone();
        document.getElementById('incomingCallModal').style.display = 'none';

        try {
            if (!localStream) {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: incomingCall.type === 'video',
                    audio: true
                });
            }

            peerConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));

            peerConnection.ontrack = (e) => {
                document.getElementById('remoteVideo').srcObject = e.streams[0];
            };

            peerConnection.onicecandidate = (e) => {
                if (e.candidate) {
                    socket.emit('ice-candidate', { to: incomingCall.fromId, candidate: e.candidate });
                }
            };

            await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCall.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            currentCall = incomingCall.fromId;
            socket.emit('accept-call', { to: incomingCall.fromId, answer });

            document.getElementById('videoCallContainer').style.display = 'flex';
            document.getElementById('remoteName').innerText = incomingCall.from;
            document.getElementById('localVideo').srcObject = localStream;

            startCallTimer();
            isCallActive = true;

        } catch (err) {
            showToast('ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©', 'error');
        }
    };

    window.rejectCall = () => {
        if (incomingCall) {
            socket.emit('reject-call', { to: incomingCall.fromId });
            muteRingtone();
            document.getElementById('incomingCallModal').style.display = 'none';
        }
    };

    window.muteRingtone = () => {
        if (ringtone) {
            ringtone.pause();
            ringtone = null;
        }
    };

    function startCallTimer() {
        callSeconds = 0;
        callTimer = setInterval(() => {
            callSeconds++;
            const m = Math.floor(callSeconds / 60);
            const s = callSeconds % 60;
            document.getElementById('callTimer').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }, 1000);
    }

    function stopCallTimer() {
        if (callTimer) clearInterval(callTimer);
        document.getElementById('callTimer').innerText = '00:00';
    }

    window.endCall = () => {
        if (currentCall) socket.emit('end-call', { to: currentCall });
        if (peerConnection) peerConnection.close();
        peerConnection = null;
        isCallActive = false;
        currentCall = null;
        document.getElementById('videoCallContainer').style.display = 'none';
        stopCallTimer();
    };

    document.getElementById('callMicBtn')?.addEventListener('click', () => {
        if (localStream) {
            const track = localStream.getAudioTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                document.getElementById('callMicBtn').innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            }
        }
    });

    document.getElementById('callCamBtn')?.addEventListener('click', () => {
        if (localStream) {
            const track = localStream.getVideoTracks()[0];
            if (track) {
                track.enabled = !track.enabled;
                document.getElementById('callCamBtn').innerHTML = track.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            }
        }
    });

    document.getElementById('callEndBtn')?.addEventListener('click', endCall);

    window.flipCamera = async () => {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(d => d.kind === 'videoinput');
            if (cameras.length < 2) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ø®Ù„ÙÙŠØ©', 'warning');
                return;
            }

            const currentId = localStream.getVideoTracks()[0].getSettings().deviceId;
            const nextCam = cameras.find(c => c.deviceId !== currentId) || cameras[0];
            const newStream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: { exact: nextCam.deviceId } }
            });
            const newTrack = newStream.getVideoTracks()[0];

            const sender = peerConnection?.getSenders().find(s => s.track?.kind === 'video');
            if (sender) await sender.replaceTrack(newTrack);

            localStream.removeTrack(localStream.getVideoTracks()[0]);
            localStream.addTrack(newTrack);
            document.getElementById('localVideo').srcObject = localStream;

        } catch (err) {
            showToast('ÙØ´Ù„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'error');
        }
    };

    socket?.on('call-accepted', (data) => {
        if (currentCall === data.fromId) {
            startCallTimer();
            isCallActive = true;
            document.getElementById('remoteName').innerText = data.from;
        }
    });

    socket?.on('call-rejected', (data) => {
        if (currentCall === data.fromId) {
            showToast(`Ø±ÙØ¶ ${data.from} Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©`, 'warning');
            endCall();
        }
    });

    socket?.on('answer', async (data) => {
        if (peerConnection && currentCall === data.fromId) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    });

    socket?.on('ice-candidate', async (data) => {
        if (peerConnection && currentCall === data.fromId) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    });

    socket?.on('call-ended', (data) => {
        if (isCallActive && currentCall === data.fromId) {
            showToast('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©', 'info');
            endCall();
        }
    });

    // ==================== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© ====================
    window.playAudio = (el) => {
        const audio = new Audio(el.dataset.src);
        audio.play();
        el.querySelector('i').className = 'fas fa-pause';
        audio.onended = () => {
            el.querySelector('i').className = 'fas fa-play';
        };
    };

    window.viewMedia = (url) => {
        window.open(url, '_blank');
    };

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', () => {
        document.getElementById('attachOptions').style.display = 'none';
        document.getElementById('storyMenu').style.display = 'none';
        document.getElementById('addStoryMenu').style.display = 'none';
    });
</script>
<!-- ====== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ====== -->
<script>
// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©) ====================
const STORAGE_KEYS = {
    USER: 'ron_user_session',
    THEME: 'ron_theme',
    FONT_SIZE: 'ron_font_size',
    FONT_FAMILY: 'ron_font_family'
};

// Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function saveUserSession() {
    if (currentUser?.id) {
        const sessionData = {
            id: currentUser.id,
            name: currentUser.name,
            email: currentUser.email,
            avatar: currentUser.avatar,
            bio: currentUser.bio,
            timestamp: Date.now()
        };
        localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(sessionData));
    }
}

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function loadUserSession() {
    const saved = localStorage.getItem(STORAGE_KEYS.USER);
    if (saved) {
        try {
            const session = JSON.parse(saved);
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© (7 Ø£ÙŠØ§Ù…)
            if (Date.now() - session.timestamp < 7 * 24 * 60 * 60 * 1000) {
                return session;
            }
        } catch (e) {}
    }
    return null;
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø­Ø³Ù† ====================

// ÙÙ‚Ø§Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© - Ù…Ø³ØªØ·ÙŠÙ„ Ø¨ÙŠØ¶ÙˆÙŠ ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹
const typingBubbleHTML = `
    <div class="typing-bubble-enhanced" style="display: none; align-items: center; gap: 4px; padding: 8px 16px; background: var(--card); border-radius: 30px; width: fit-content; margin: 5px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <span style="width: 6px; height: 6px; background: var(--text-secondary); border-radius: 50%; animation: typingDot 1.2s infinite;"></span>
        <span style="width: 6px; height: 6px; background: var(--text-secondary); border-radius: 50%; animation: typingDot 1.2s infinite; animation-delay: 0.2s;"></span>
        <span style="width: 6px; height: 6px; background: var(--text-secondary); border-radius: 50%; animation: typingDot 1.2s infinite; animation-delay: 0.4s;"></span>
    </div>
`;

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ù„Ù„ØµÙØ­Ø©
document.body.insertAdjacentHTML('beforeend', typingBubbleHTML);
const typingBubbleEnhanced = document.querySelector('.typing-bubble-enhanced');

// Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ù…Ø¤Ù‚Øª Ø¯Ù‚ÙŠÙ‚
let typingTimer = null;
let typingTimeoutMs = 1000; // Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ‚Ù

// Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
function sendTypingStatus(isTyping) {
    if (!currentChat?.id) return;
    
    socket.emit('typing', {
        to: currentChat.id,
        isTyping: isTyping
    });
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
document.getElementById('chatInput')?.addEventListener('input', function() {
    const hasText = this.value.trim().length > 0;
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    const recordBtn = document.getElementById('recordBtn');
    const sendBtn = document.getElementById('sendBtn');
    
    if (hasText) {
        recordBtn.style.display = 'none';
        sendBtn.style.display = 'flex';
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ 500ms)
        if (!typingTimer) {
            sendTypingStatus(true);
            typingTimer = setTimeout(() => {
                typingTimer = null;
            }, 500);
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¤Ù‚Øª Ø§Ù„ØªÙˆÙ‚Ù
        if (window.stopTypingTimer) {
            clearTimeout(window.stopTypingTimer);
        }
        window.stopTypingTimer = setTimeout(() => {
            sendTypingStatus(false);
            window.stopTypingTimer = null;
        }, typingTimeoutMs);
        
    } else {
        recordBtn.style.display = 'flex';
        sendBtn.style.display = 'none';
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆØ±Ø§Ù‹
        sendTypingStatus(false);
        if (window.stopTypingTimer) {
            clearTimeout(window.stopTypingTimer);
            window.stopTypingTimer = null;
        }
    }
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
socket?.on('typing', (data) => {
    if (currentChat && data.from === currentChat.id) {
        if (data.isTyping) {
            typingBubbleEnhanced.style.display = 'flex';
        } else {
            typingBubbleEnhanced.style.display = 'none';
        }
    }
});

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙÙˆØ±ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ±) ====================

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±ÙŠØ©
window.sendMessageImmediate = function(content, type = 'text') {
    if (!currentChat || !content) return false;
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ù…Ø¤Ù‚Øª
    const tempId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©
    const tempMessage = {
        id: tempId,
        from: currentUser.id,
        to: currentChat.id,
        type: type,
        content: content,
        timestamp: Date.now(),
        seen: false,
        temp: true
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ±ÙŠ
    chatMessages.push(tempMessage);
    renderMessages();
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±
    socket.emit('send-message', {
        to: currentChat.id,
        type: type,
        content: content,
        tempId: tempId
    });
    
    return true;
};

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
socket?.on('message-sent', (data) => {
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    const index = chatMessages.findIndex(m => m.temp && m.content === data.content);
    if (index !== -1) {
        chatMessages.splice(index, 1);
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    chatMessages.push(data);
    renderMessages();
});

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© (ÙÙˆØ±ÙŠØ©)
socket?.on('new-message', (msg) => {
    if (currentChat && (msg.from === currentChat.id || msg.to === currentChat.id)) {
        chatMessages.push(msg);
        renderMessages();
        
        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
        if (msg.to === currentUser.id) {
            socket.emit('mark-seen', { from: msg.from });
        }
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø´Ø§Ø´Ø©)
        if (!currentChat || msg.from !== currentChat.id) {
            playNotificationSound();
        }
    } else {
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        loadChats();
    }
});

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ Ø§Ù„Ø°Ø¨Ø°Ø¨Ø§Øª ====================

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¬Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©
class AudioVisualizer {
    constructor(audioContext, stream) {
        this.audioContext = audioContext;
        this.source = audioContext.createMediaStreamSource(stream);
        this.analyser = audioContext.createAnalyser();
        this.analyser.fftSize = 256;
        this.source.connect(this.analyser);
        this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
    }
    
    getWaveform() {
        this.analyser.getByteFrequencyData(this.dataArray);
        // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ù…ÙˆØ¬Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹
        const avg = Array(4).fill(0);
        for (let i = 0; i < 4; i++) {
            const start = Math.floor(i * this.dataArray.length / 4);
            const end = Math.floor((i + 1) * this.dataArray.length / 4);
            let sum = 0;
            for (let j = start; j < end; j++) {
                sum += this.dataArray[j];
            }
            avg[i] = sum / (end - start) / 255; // ØªØ·Ø¨ÙŠØ¹ Ù…Ù† 0-1
        }
        return avg;
    }
}

let audioVisualizer = null;
let animationFrame = null;

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹ Ø§Ù„Ø°Ø¨Ø°Ø¨Ø§Øª
async function startEnhancedRecording() {
    if (!currentChat) return;
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioVisualizer = new AudioVisualizer(audioContext, stream);
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        
        mediaRecorder.onstop = () => {
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø°Ø¨Ø°Ø¨Ø§Øª
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.onload = () => {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø©
                const duration = Math.floor((Date.now() - recordStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const durationStr = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
                
                socket.emit('send-message', {
                    to: currentChat.id,
                    type: 'audio',
                    content: reader.result,
                    duration: durationStr
                });
            };
            reader.readAsDataURL(blob);
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
            stream.getTracks().forEach(t => t.stop());
            audioContext.close();
        };
        
        mediaRecorder.start();
        recordStartTime = Date.now();
        
        // Ø¨Ø¯Ø¡ Ø±Ø³Ù… Ø§Ù„Ø°Ø¨Ø°Ø¨Ø§Øª
        function drawWaveform() {
            if (!audioVisualizer) return;
            
            const waves = audioVisualizer.getWaveform();
            const waveElements = document.querySelectorAll('.audio-wave.recording span');
            
            waveElements.forEach((el, i) => {
                if (i < waves.length) {
                    const height = 15 + (waves[i] * 30); // 15-45px
                    el.style.height = height + 'px';
                }
            });
            
            animationFrame = requestAnimationFrame(drawWaveform);
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¬Ø§Øª
        const indicator = document.getElementById('recordingIndicator');
        if (indicator) {
            indicator.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-microphone" style="color: white;"></i>
                    <div class="audio-wave recording" style="display: flex; align-items: center; gap: 3px; height: 30px;">
                        <span style="width: 4px; background: white; border-radius: 2px;"></span>
                        <span style="width: 4px; background: white; border-radius: 2px;"></span>
                        <span style="width: 4px; background: white; border-radius: 2px;"></span>
                        <span style="width: 4px; background: white; border-radius: 2px;"></span>
                    </div>
                    <span id="recTime">0:00</span>
                    <i class="fas fa-arrow-up" style="margin-right: 8px;"></i>
                </div>
            `;
        }
        
        drawWaveform();
        
    } catch (err) {
        showToast('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†', 'error');
    }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†
const originalStartRecording = window.startRecording;
window.startRecording = function(e) {
    if (!currentChat) return;
    
    isRecording = true;
    recordStartY = e.clientY || (e.touches?.[0]?.clientY || 0);
    recordBtn.classList.add('recording');
    recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
    
    const indicator = document.createElement('div');
    indicator.className = 'recording-indicator';
    indicator.id = 'recordingIndicator';
    indicator.style.cssText = 'position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%); background: var(--danger); padding: 10px 20px; border-radius: 40px; display: flex; align-items: center; gap: 10px; z-index: 100;';
    document.querySelector('.chat-input-area').appendChild(indicator);
    
    startEnhancedRecording();
    
    // Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ø¯Ø©
    let seconds = 0;
    window.recTimer = setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        const timeEl = document.getElementById('recTime');
        if (timeEl) timeEl.innerText = `${m}:${s < 10 ? '0' + s : s}`;
    }, 1000);
};

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„Ø© ÙˆØ¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ====================

let followersSet = new Set(); // Ù…Ù† ÙŠØªØ§Ø¨Ø¹Ù†ÙŠ

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
async function loadFollowers() {
    try {
        const res = await fetch(`${SERVER_URL}/followers/${currentUser.id}`);
        const data = await res.json();
        if (data.success) {
            followersSet = new Set(data.followers.map(f => f.userId));
        }
    } catch (err) {}
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„Ø©
function isMutualFollow(userId) {
    return following.has(userId) && followersSet.has(userId);
}

// ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù†
function updateChatButtons() {
    // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
    document.querySelectorAll('.chat-item').forEach(item => {
        const userId = item.dataset.userId;
        if (userId && isMutualFollow(userId)) {
            let btn = item.querySelector('.direct-chat-btn');
            if (!btn) {
                btn = document.createElement('button');
                btn.className = 'direct-chat-btn';
                btn.innerHTML = '<i class="fas fa-comment"></i>';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const name = item.querySelector('.chat-name')?.innerText.split(' ')[0] || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    const avatar = item.querySelector('.chat-avatar')?.src || '';
                    openChat(userId, name, avatar);
                };
                btn.style.cssText = 'background: var(--primary); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 8px;';
                item.querySelector('.chat-info')?.after(btn);
            }
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
    document.querySelectorAll('.suggestion-item').forEach(item => {
        const userId = item.dataset.userId;
        if (userId && isMutualFollow(userId)) {
            let btn = item.querySelector('.mutual-chat-btn');
            if (!btn) {
                btn = document.createElement('button');
                btn.className = 'mutual-chat-btn';
                btn.innerHTML = '<i class="fas fa-comment"></i>';
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const name = item.querySelector('.suggestion-name')?.innerText || 'Ù…Ø³ØªØ®Ø¯Ù…';
                    const avatar = item.querySelector('.suggestion-avatar')?.src || '';
                    openChat(userId, name, avatar);
                };
                btn.style.cssText = 'background: var(--primary); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer;';
                item.querySelector('.follow-btn')?.after(btn);
            }
        }
    });
}

// ==================== ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØµ ====================

// Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‚ØµØµ
window.viewStory = async function(storyId) {
    try {
        const res = await fetch(`${SERVER_URL}/story/${storyId}`);
        const data = await res.json();
        
        if (data.success) {
            currentStory = data.story;
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('storyUserAvatar').src = currentStory.userAvatar || 'https://via.placeholder.com/45';
            document.getElementById('storyUserName').innerText = currentStory.userName;
            document.getElementById('storyTime').innerText = new Date(currentStory.createdAt).toLocaleString('ar');
            
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            document.getElementById('storyImage').style.display = 'none';
            document.getElementById('storyVideo').style.display = 'none';
            document.getElementById('storyText').style.display = 'none';
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
            if (currentStory.media) {
                // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† media ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ
                if (currentStory.media.includes('image') || currentStory.media.match(/\.(jpg|jpeg|png|gif|webp)/i)) {
                    document.getElementById('storyImage').src = currentStory.media;
                    document.getElementById('storyImage').style.display = 'block';
                } else {
                    document.getElementById('storyVideo').src = currentStory.media;
                    document.getElementById('storyVideo').style.display = 'block';
                }
            } else if (currentStory.text) {
                document.getElementById('storyText').innerText = currentStory.text;
                document.getElementById('storyText').style.display = 'block';
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
            await loadStoryInteractions(storyId);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©
            document.getElementById('storyViewerScreen').style.display = 'block';
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
            fetch(`${SERVER_URL}/view-story`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ storyId, userId: currentUser.id })
            });
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ø¹Ø¨Ø± socket
            if (socket) {
                socket.emit('view-story', { storyId, userId: currentUser.id });
            }
        }
    } catch (err) {
        console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ©:', err);
        showToast('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ØµØ©', 'error');
    }
};

// Ø¥ØµÙ„Ø§Ø­ Ù†Ø´Ø± Ø§Ù„Ù‚ØµØ©
window.addTextStory = function() {
    const text = prompt('Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ù‚ØµØ©:');
    if (text?.trim()) {
        closeAddStory();
        showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...', 'info');
        
        fetch(`${SERVER_URL}/post-story`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                userId: currentUser.id, 
                text: text.trim() 
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'success');
                loadStories();
            } else {
                showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±', 'error');
            }
        })
        .catch(err => {
            console.error('âŒ Ø®Ø·Ø£:', err);
            showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        });
    }
};

window.addImageStory = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        closeAddStory();
        showToast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'info');
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            fetch(`${SERVER_URL}/post-story`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: currentUser.id, 
                    media: ev.target.result 
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'success');
                    loadStories();
                } else {
                    showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±', 'error');
                }
            })
            .catch(err => {
                console.error('âŒ Ø®Ø·Ø£:', err);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            });
        };
        reader.readAsDataURL(file);
    };
    input.click();
};

window.addVideoStory = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        closeAddStory();
        showToast('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...', 'info');
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            fetch(`${SERVER_URL}/post-story`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: currentUser.id, 
                    media: ev.target.result 
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'success');
                    loadStories();
                } else {
                    showToast('ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±', 'error');
                }
            })
            .catch(err => {
                console.error('âŒ Ø®Ø·Ø£:', err);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            });
        };
        reader.readAsDataURL(file);
    };
    input.click();
};

// ==================== ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ====================

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø­Ø¬Ù…
function handleResize() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
    
    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø§Ù„Ø´Ø§Ø´Ø§Øª
    const screens = document.querySelectorAll('.screen');
    screens.forEach(screen => {
        screen.style.minHeight = `calc(${vh * 100}px - 160px)`;
    });
    
    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Øª
    const chatScreen = document.querySelector('.chat-container');
    if (chatScreen) {
        chatScreen.style.height = `${vh * 100}px`;
    }
}

window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', handleResize);
handleResize();

// ==================== ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ====================

// Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const content = e.target.value.trim();
        if (content && currentChat) {
            sendMessageImmediate(content, 'text');
        }
    }
});

// ==================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ====================

// Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
(async function initializeApp() {
    const savedSession = loadUserSession();
    if (savedSession) {
        currentUser = savedSession;
        document.getElementById('headerName').innerText = currentUser.name;
        document.getElementById('headerAvatar').src = currentUser.avatar || 'https://via.placeholder.com/48';
        
        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        authScreen.style.display = 'none';
        mainApp.style.display = 'block';
        
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
        connectSocket();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await loadFollowers();
        await loadFollowing();
        await loadSuggestions();
        await loadStories();
        await loadChats();
    }
})();

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© connectSocket
const originalConnectSocket = connectSocket;
connectSocket = function() {
    originalConnectSocket();
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    socket?.on('users-updated', (users) => {
        onlineUsers.clear();
        users.forEach(u => onlineUsers.set(u.userId, u));
        updateUserOnlineStatus();
        updateChatButtons();
    });
};

// ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© toggleFollow
const originalToggleFollow = window.toggleFollow;
window.toggleFollow = async function(targetId) {
    await originalToggleFollow(targetId);
    await loadFollowers(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†
    updateChatButtons(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
};

// Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
const originalShowAuthSuccess = showAuthSuccess;
showAuthSuccess = function() {
    originalShowAuthSuccess();
    saveUserSession();
    loadFollowers();
};

// ==================== Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© ====================
const style = document.createElement('style');
style.textContent = `
    @keyframes typingDot {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-6px); }
    }
    
    .typing-bubble-enhanced {
        animation: fadeIn 0.2s ease;
    }
    
    .audio-wave.recording span {
        transition: height 0.1s ease;
        background: white;
    }
    
    .direct-chat-btn, .mutual-chat-btn {
        transition: all 0.2s;
    }
    
    .direct-chat-btn:hover, .mutual-chat-btn:hover {
        transform: scale(1.1);
        background: var(--primary-dark) !important;
    }
    
    .direct-chat-btn:active, .mutual-chat-btn:active {
        transform: scale(0.95);
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 380px) {
        .typing-bubble-enhanced {
            padding: 6px 12px;
        }
        .typing-bubble-enhanced span {
            width: 5px;
            height: 5px;
        }
    }
`;
document.head.appendChild(style);
</script>
<!-- ====== Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ£Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ ====== -->
<script>
// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙØ§Ø¦Ù‚ Ø§Ù„Ø³Ø±Ø¹Ø© (Zero Lag) ====================

// Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
if (window.messageTimer) clearInterval(window.messageTimer);
if (window.typingTimer) clearTimeout(window.typingTimer);

// ==================== 1. ØªØ­Ø³ÙŠÙ† Ø§ØªØµØ§Ù„ Socket ====================
if (socket) {
    // Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    socket.off('new-message');
    socket.off('message-sent');
}

// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙ socket Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³Ø±Ø¹Ø© Ø¹Ø§Ù„ÙŠØ©
socket = io(SERVER_URL, {
    reconnection: true,
    reconnectionAttempts: 10,
    reconnectionDelay: 500,
    reconnectionDelayMax: 2000,
    timeout: 5000,
    transports: ['websocket'], // Ø§Ø³ØªØ®Ø¯Ø§Ù… WebSocket ÙÙ‚Ø· Ù„Ù„Ø³Ø±Ø¹Ø©
    upgrade: false
});

// ==================== 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙÙˆØ±ÙŠØ© (Direct Push) ====================

// Ø°Ø§ÙƒØ±Ø© ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
const messageCache = new Map();
let lastMessageTime = 0;

// Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© - Ù„Ø§ ØªØ£Ø®ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
window.sendMessageNow = function(content, type = 'text') {
    if (!currentChat || !content) return false;
    
    const now = Date.now();
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±ÙŠØ©
    const message = {
        id: 'temp_' + now + '_' + Math.random().toString(36).substr(2, 5),
        from: currentUser.id,
        to: currentChat.id,
        type: type,
        content: content,
        timestamp: now,
        seen: false,
        status: 'sending'
    };
    
    // Ø¹Ø±Ø¶ ÙÙˆØ±ÙŠ (0ms)
    chatMessages.push(message);
    renderMessages();
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± socket (Ù…ÙˆØ§Ø²ÙŠ)
    socket.emit('send-message', {
        to: currentChat.id,
        type: type,
        content: content,
        clientId: message.id,
        timestamp: now
    });
    
    // ØªØ®Ø²ÙŠÙ† ÙÙŠ Ø§Ù„ÙƒØ§Ø´
    messageCache.set(message.id, message);
    
    // ØªÙ†Ø¸ÙŠÙ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    document.getElementById('chatInput').value = '';
    document.getElementById('recordBtn').style.display = 'flex';
    document.getElementById('sendBtn').style.display = 'none';
    
    return true;
};

// ==================== 3. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„Ø¶ÙˆØ¡ ====================

socket.on('new-message', (msg) => {
    console.log('âš¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§ØµÙ„Ø©:', msg);
    
    // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    if (currentChat && (msg.from === currentChat.id || msg.to === currentChat.id)) {
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø³Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ© Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        const existingIndex = chatMessages.findIndex(m => 
            m.temp && m.content === msg.content && m.from === msg.from
        );
        
        if (existingIndex !== -1) {
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
            chatMessages[existingIndex] = msg;
        } else {
            // Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ…Ø§Ù…Ø§Ù‹
            chatMessages.push(msg);
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… (Ø¨Ø³Ø±Ø¹Ø©)
        renderMessages();
        
        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
        if (msg.to === currentUser.id) {
            socket.emit('mark-seen', { from: msg.from });
        }
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª ØºÙŠØ± Ù†Ø´Ø·Ø©
        if (document.hidden) {
            playNotificationSound();
        }
    } else {
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        loadChats();
    }
});

// ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
socket.on('message-sent', (msg) => {
    console.log('âœ… ØªØ£ÙƒÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„:', msg.id);
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    const index = chatMessages.findIndex(m => m.id === msg.id || (m.temp && m.content === msg.content));
    
    if (index !== -1) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        chatMessages[index] = {...msg, status: 'sent'};
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… ÙƒØ§Ù…Ù„Ø©
        const messageEl = document.querySelector(`[data-message-id="${msg.id}"]`);
        if (messageEl) {
            const statusEl = messageEl.querySelector('.message-status');
            if (statusEl) {
                statusEl.innerHTML = '<i class="fas fa-check" style="font-size: 10px;"></i>';
            }
        } else {
            renderMessages(); // Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        }
    }
});

// ==================== 4. ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ====================

const originalRenderMessages = renderMessages;
renderMessages = function() {
    const area = document.getElementById('messagesArea');
    if (!area) return;
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… DocumentFragment Ù„Ù„Ø³Ø±Ø¹Ø©
    const fragment = document.createDocumentFragment();
    
    chatMessages.forEach(msg => {
        const div = document.createElement('div');
        div.className = `message ${msg.from === currentUser.id ? 'sent' : 'received'}`;
        div.setAttribute('data-message-id', msg.id);
        div.setAttribute('data-timestamp', msg.timestamp);
        
        if (msg.type === 'text') {
            div.innerHTML = `
                <div class="message-text">${escapeHtml(msg.content)}</div>
                <div class="message-footer" style="display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 2px;">
                    <span class="message-time">${formatMessageTime(msg.timestamp)}</span>
                    ${msg.from === currentUser.id ? `<span class="message-status">${msg.seen ? '<i class="fas fa-check-double" style="color: var(--success);"></i>' : (msg.status === 'sending' ? '<i class="fas fa-clock" style="color: var(--text-secondary);"></i>' : '<i class="fas fa-check"></i>')}</span>` : ''}
                </div>
            `;
        } else if (msg.type === 'image') {
            div.innerHTML = `
                <img src="${msg.content}" class="message-image" onclick="viewMedia('${msg.content}')">
                <div class="message-footer" style="display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 2px;">
                    <span class="message-time">${formatMessageTime(msg.timestamp)}</span>
                    ${msg.from === currentUser.id ? `<span class="message-status">${msg.seen ? '<i class="fas fa-check-double" style="color: var(--success);"></i>' : '<i class="fas fa-check"></i>'}</span>` : ''}
                </div>
            `;
        } else if (msg.type === 'video') {
            div.innerHTML = `
                <video src="${msg.content}" class="message-video" onclick="this.paused ? this.play() : this.pause()"></video>
                <div class="message-footer" style="display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 2px;">
                    <span class="message-time">${formatMessageTime(msg.timestamp)}</span>
                    ${msg.from === currentUser.id ? `<span class="message-status">${msg.seen ? '<i class="fas fa-check-double" style="color: var(--success);"></i>' : '<i class="fas fa-check"></i>'}</span>` : ''}
                </div>
            `;
        } else if (msg.type === 'audio') {
            div.innerHTML = `
                <div class="audio-message" onclick="playAudioMessage(this)" data-src="${msg.content}" data-duration="${msg.duration || '0:03'}">
                    <i class="fas fa-play"></i>
                    <div class="audio-wave">
                        <span></span><span></span><span></span><span></span>
                    </div>
                    <span class="audio-duration">${msg.duration || '0:03'}</span>
                </div>
                <div class="message-footer" style="display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 2px;">
                    <span class="message-time">${formatMessageTime(msg.timestamp)}</span>
                    ${msg.from === currentUser.id ? `<span class="message-status">${msg.seen ? '<i class="fas fa-check-double" style="color: var(--success);"></i>' : '<i class="fas fa-check"></i>'}</span>` : ''}
                </div>
            `;
        }
        
        fragment.appendChild(div);
    });
    
    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    area.innerHTML = '';
    area.appendChild(fragment);
    
    // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
    area.scrollTop = area.scrollHeight;
};

// ==================== 5. ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ====================

// Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
document.getElementById('sendBtn')?.removeEventListener('click', window.sendMessage);
document.getElementById('sendBtn')?.addEventListener('click', function() {
    const input = document.getElementById('chatInput');
    const content = input.value.trim();
    if (content && currentChat) {
        sendMessageNow(content, 'text');
    }
});

// ØªØ­Ø³ÙŠÙ† Ø¥Ø±Ø³Ø§Ù„ Enter
document.getElementById('chatInput')?.removeEventListener('keypress', window.handleEnterKey);
document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const content = this.value.trim();
        if (content && currentChat) {
            sendMessageNow(content, 'text');
        }
    }
});

// ==================== 6. ØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ====================

const originalLoadMessages = loadMessages;
loadMessages = async function() {
    if (!currentChat) return;
    
    try {
        const res = await fetch(`${SERVER_URL}/messages/${currentUser.id}/${currentChat.id}`);
        const data = await res.json();
        
        if (data.success) {
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
            chatMessages = data.messages.sort((a, b) => a.timestamp - b.timestamp);
            renderMessages();
        }
    } catch (err) {
        console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', err);
    }
};

// ==================== 7. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø­Ø³Ù†Ø© ====================

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª (Ù…Ù†Ø° Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ø§Ù„Ø³Ø§Ø¹Ø©...)
function formatMessageTime(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    if (diff < 60000) return 'Ø§Ù„Ø¢Ù†';
    if (diff < 3600000) return `${Math.floor(diff / 60000)} Ø¯`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)} Ø³`;
    return new Date(timestamp).toLocaleDateString('ar');
}

// ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹)
function playNotificationSound() {
    const audio = new Audio();
    audio.src = 'data:audio/wav;base64,UklGRlwAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YVAAAAA8PHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHw=';
    audio.volume = 0.3;
    audio.play().catch(() => {});
}

// ==================== 8. ØªØµØ­ÙŠØ­ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© ====================

// Ù…Ø¤Ù‚Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø­Ø³Ù†
let typingTimerMs = null;
const TYPING_TIMEOUT = 800; // 0.8 Ø«Ø§Ù†ÙŠØ©

document.getElementById('chatInput')?.addEventListener('input', function() {
    const hasText = this.value.trim().length > 0;
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('recordBtn').style.display = hasText ? 'none' : 'flex';
    document.getElementById('sendBtn').style.display = hasText ? 'flex' : 'none';
    
    if (currentChat) {
        if (hasText && !typingTimerMs) {
            // Ø¨Ø¯Ø£ Ø§Ù„ÙƒØªØ§Ø¨Ø©
            socket.emit('typing', { to: currentChat.id, isTyping: true });
            typingTimerMs = setTimeout(() => {
                typingTimerMs = null;
            }, TYPING_TIMEOUT);
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¤Ù‚Øª Ø§Ù„ØªÙˆÙ‚Ù
        if (window.stopTypingTimerMs) {
            clearTimeout(window.stopTypingTimerMs);
        }
        window.stopTypingTimerMs = setTimeout(() => {
            if (currentChat) {
                socket.emit('typing', { to: currentChat.id, isTyping: false });
            }
            window.stopTypingTimerMs = null;
        }, TYPING_TIMEOUT);
    }
});

// ==================== 9. Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ====================

const messageStyles = document.createElement('style');
messageStyles.textContent = `
    .message {
        animation: messagePop 0.15s ease-out;
        margin-bottom: 8px;
    }
    
    @keyframes messagePop {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .message-time {
        font-size: 10px;
        color: var(--text-secondary);
        opacity: 0.7;
    }
    
    .message-status {
        font-size: 10px;
        color: var(--text-secondary);
        display: inline-flex;
        align-items: center;
    }
    
    .message.sent .message-status i.fa-check-double {
        color: var(--success);
    }
    
    .message.sent .message-status i.fa-clock {
        color: var(--text-secondary);
    }
    
    .message-image, .message-video {
        max-width: 250px;
        border-radius: 16px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .message-image:active, .message-video:active {
        transform: scale(0.98);
    }
    
    .audio-message {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255,255,255,0.1);
        padding: 10px 16px;
        border-radius: 40px;
        cursor: pointer;
        transition: background 0.2s;
        max-width: 250px;
    }
    
    .audio-message:active {
        background: rgba(255,255,255,0.2);
    }
    
    .audio-wave {
        display: flex;
        align-items: center;
        gap: 3px;
        height: 24px;
    }
    
    .audio-wave span {
        width: 4px;
        height: 100%;
        background: currentColor;
        border-radius: 2px;
        animation: audioWave 1s infinite;
    }
    
    .audio-wave span:nth-child(2) { animation-delay: 0.1s; }
    .audio-wave span:nth-child(3) { animation-delay: 0.2s; }
    .audio-wave span:nth-child(4) { animation-delay: 0.3s; }
    
    @keyframes audioWave {
        0%, 100% { transform: scaleY(0.3); }
        50% { transform: scaleY(1); }
    }
    
    .audio-duration {
        font-size: 12px;
        opacity: 0.8;
        min-width: 35px;
    }
`;

document.head.appendChild(messageStyles);

// ==================== 10. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ====================

window.playAudioMessage = function(element) {
    const src = element.dataset.src;
    const duration = element.dataset.duration;
    const audio = new Audio(src);
    const icon = element.querySelector('i');
    const wave = element.querySelector('.audio-wave');
    
    if (audio.paused) {
        audio.play();
        icon.className = 'fas fa-pause';
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…ÙˆØ¬Ø§Øª
        let interval = setInterval(() => {
            if (audio.paused) {
                clearInterval(interval);
                icon.className = 'fas fa-play';
            }
        }, 100);
        
        audio.onended = () => {
            icon.className = 'fas fa-play';
            clearInterval(interval);
        };
    } else {
        audio.pause();
        icon.className = 'fas fa-play';
    }
};

console.log('âš¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙÙˆØ±ÙŠØ© Ù†Ø´Ø· ÙˆØ¬Ø§Ù‡Ø²');
</script>
</body>
</html>
