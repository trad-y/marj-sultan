<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø±Ø¬ Ø§Ù„Ø³Ù„Ø·Ø§Ù† | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #d4af37;
            --gold-light: rgba(212, 175, 55, 0.2);
            --bg: #050505;
            --card: #111;
            --input-bg: #151515;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: #fff; overflow-x: hidden; line-height: 1.6; }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ --- */
        #status-bar { 
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.95); border: 2px solid var(--gold); 
            padding: 12px 25px; border-radius: 50px; display: none; z-index: 11000;
            box-shadow: 0 5px 25px rgba(212,175,55,0.4); backdrop-filter: blur(15px);
            text-align: center; min-width: 280px; animation: fadeInDown 0.5s ease;
        }
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¨Ø­Ø« --- */
        .hero { padding: 40px 20px; text-align: center; background: linear-gradient(to bottom, #111, var(--bg)); }
        .hero h1 { font-size: 2.8rem; color: var(--gold); font-weight: 900; letter-spacing: 1px; }
        .hero p.subtitle { color: var(--gold); font-size: 0.7rem; letter-spacing: 3px; margin-top: -5px; }
        
        .search-box { max-width: 500px; margin: 20px auto; padding: 0 20px; }
        .search-box input { 
            width: 100%; padding: 16px 20px; border-radius: 15px; border: 1px solid #333; 
            background: var(--card); color: #fff; text-align: center; font-size: 1.1rem;
            transition: var(--transition);
        }
        .search-box input:focus { border-color: var(--gold); background: #181818; box-shadow: 0 0 15px rgba(212,175,55,0.2); }

        /* --- Ø§Ù„Ù…Ù†ÙŠÙˆ (3 Ø£Ø¹Ù…Ø¯Ø©) --- */
        .container { padding: 0 15px 120px; max-width: 1200px; margin: 0 auto; }
        .category-title { 
            color: var(--gold); font-size: 1.5rem; margin: 35px 0 15px; 
            border-right: 5px solid var(--gold); padding-right: 15px; 
            position: relative; display: inline-block;
        }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        .item-card { 
            background: var(--card); border-radius: 18px; overflow: hidden; 
            aspect-ratio: 1/1.3; border: 1px solid rgba(255,255,255,0.05); position: relative;
            cursor: pointer; transition: var(--transition); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .item-card:hover { transform: translateY(-5px); border-color: rgba(212,175,55,0.3); }
        .item-card:active { transform: scale(0.96); }
        .item-card img { width: 100%; height: 60%; object-fit: cover; opacity: 0.9; transition: opacity 0.3s; }
        .item-card:hover img { opacity: 1; }
        .item-info { padding: 12px 10px; }
        .item-name { font-size: 0.85rem; font-weight: bold; display: block; height: 38px; overflow: hidden; line-height: 1.4; }
        .item-price { color: var(--gold); font-weight: 900; font-size: 0.95rem; display: block; margin-top: 5px; }

        /* --- Ø§Ù„Ù†ÙˆØ§ÙØ° (Overlays) --- */
        .overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.97); z-index:10000; display:none; 
            justify-content:center; align-items:center; backdrop-filter: blur(15px);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content { 
            background: #0d0d0d; width: 92%; max-width: 450px; border-radius: 30px; 
            border: 1px solid #222; padding: 25px; position: relative;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª --- */
        .input-group { margin-bottom: 15px; text-align: right; }
        .input-group label { display: block; color: var(--gold); font-size: 0.8rem; margin-bottom: 5px; margin-right: 5px; }
        .modern-input {
            width: 100%; padding: 16px 20px; background: var(--input-bg); border: 1px solid #252525;
            color: #fff; border-radius: 15px; font-size: 1rem; transition: 0.3s;
        }
        .modern-input:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 10px rgba(212,175,55,0.2); }
        
        .delivery-box { display: none; background: #131313; padding: 15px; border-radius: 15px; margin-top: 10px; border: 1px dashed #333; }

        /* --- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… --- */
        .btn-submit { 
            background: var(--gold); color: #000; font-weight: 900; padding: 18px; 
            border-radius: 15px; border: none; width: 100%; font-size: 1.1rem; 
            cursor: pointer; margin-top: 15px; transition: all 0.2s; letter-spacing: 0.5px;
            position: relative; overflow: hidden;
        }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit:before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .btn-submit:hover:before { left: 100%; }

        /* --- Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ --- */
        .loader-container { display: none; text-align: center; padding: 40px 0; }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #222;
            border-top: 4px solid var(--gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Ù„ÙˆØ­Ø© TRAD --- */
        #admin-panel { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:#000; z-index:20000; display:none; padding:20px; overflow-y:auto; 
        }
        .admin-card { background:#111; padding:20px; border-radius:15px; margin-bottom:15px; border: 1px solid #222; }

        /* --- ÙƒØ¨Ø³ÙˆÙ„Ø© Ø§Ù„Ø³Ù„Ø© --- */
        .cart-capsule { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); 
            background: var(--gold); color: #000; padding: 16px 35px; border-radius: 50px; 
            font-weight: 900; display: none; z-index: 9000; box-shadow: 0 10px 30px rgba(0,0,0,0.7); 
            cursor: pointer; transition: all 0.3s; border: 2px solid rgba(0,0,0,0.1);
        }
        .cart-capsule:hover { transform: translateX(-50%) scale(1.05); }
        .cart-capsule:active { transform: translateX(-50%) scale(0.95); }

        /* --- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ --- */
        .notification {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: #000; padding: 12px 25px; border-radius: 50px;
            font-weight: bold; z-index: 10000; display: none; box-shadow: 0 5px 20px rgba(212,175,55,0.4);
        }

        /* --- ÙˆÙ‚Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø®ØµØµ --- */
        .prep-time {
            font-weight: bold; margin-bottom: 20px; 
            background: var(--gold-light); padding: 6px 14px; 
            border-radius: 20px; display: inline-block; 
            font-size: 0.8rem; color: var(--gold); 
            border: 1px solid rgba(212,175,55,0.3);
        }
    </style>
</head>
<body>

    <div id="status-bar">
        <div id="status-text" style="color:var(--gold); font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</div>
        <div id="status-id" style="font-size:0.7rem; opacity:0.6; margin-top:5px;"></div>
    </div>

    <div id="notification" class="notification"></div>

    <header class="hero">
        <h1>Ù…Ø±Ø¬ Ø§Ù„Ø³Ù„Ø·Ø§Ù†</h1>
        <p class="subtitle">PREMIUM SYSTEM</p>
        <div class="search-box">
            <input type="text" id="mainSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ø¨ØªÙƒ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²..." onkeyup="checkTrad(this.value)">
        </div>
    </header>

    <main class="container" id="menuView"></main>

    <div id="itemModal" class="overlay" onclick="if(event.target==this) this.style.display='none'">
        <div class="modal-content" id="itemDetails"></div>
    </div>

    <div id="cartModal" class="overlay">
        <div class="modal-content" id="cartContainer">
            <div id="orderForm">
                <h2 style="color:var(--gold); text-align:center; margin-bottom:20px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h2>
                <div id="cartItemsList" style="margin-bottom:20px; border-bottom:1px solid #222; max-height:120px; overflow-y:auto; padding-bottom:15px;"></div>
                
                <div class="input-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="custName" class="modern-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
                </div>
                <div class="input-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="custPhone" class="modern-input" placeholder="07XXXXXXXX">
                </div>

                <label style="display:flex; align-items:center; gap:10px; margin: 15px 0; cursor:pointer;">
                    <input type="checkbox" id="isDelivery" onchange="toggleDelivery()" style="width:20px; height:20px; accent-color:var(--gold);">
                    <span style="font-weight:bold;">Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ (Delivery)</span>
                </label>

                <div id="deliveryFields" class="delivery-box">
                    <input type="text" id="area" class="modern-input" style="margin-bottom:10px;" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
                    <input type="text" id="street" class="modern-input" style="margin-bottom:10px;" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹">
                    <input type="text" id="house" class="modern-input" placeholder="Ø§Ù„Ø¨Ù†Ø§ÙŠØ© ÙˆØ§Ù„Ø´Ù‚Ø©">
                </div>

                <button class="btn-submit" id="submitBtn" onclick="processFinalOrder()">Ø£Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
                <button onclick="closeCart()" style="width:100%; background:none; border:none; color:#555; margin-top:15px; padding:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>

            <div id="loadingOrder" class="loader-container">
                <div class="spinner"></div>
                <h3 style="color:var(gold); margin-bottom:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</h3>
                <p style="font-size:0.85rem; color:#888;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ù„Ø§ ØªØºÙ„Ù‚ Ø§Ù„ØµÙØ­Ø©</p>
                <div id="orderIdDisplay" style="margin-top:15px; padding:8px; background:#111; border-radius:10px; font-size:0.8rem;">
                    Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <span id="currentOrderId" style="color:var(--gold); font-weight:bold;"></span>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h1 style="color:var(--gold)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ</h1>
            <button onclick="saveAndCloseAdmin()" style="padding:10px 20px; background:var(--gold); border:none; border-radius:10px; font-weight:bold; cursor:pointer;">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
        </div>
        <button class="btn-submit" style="background:#27ae60; color:#fff; margin-bottom:20px;" onclick="addCategory()">+ Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</button>
        <div id="adminContainer"></div>
    </div>

    <div id="cartCapsule" class="cart-capsule" onclick="openCart()">
        Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø© (<span id="count">0</span>)
    </div>

    <script>
        // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø§ØªØµØ§Ù„ ---
        let db = JSON.parse(localStorage.getItem('sultan_final_v1')) || [
            { 
                category: "Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹", 
                items: [
                    { id: 1, name: "Ø´Ø§ÙˆØ±Ù…Ø§ Ù…Ù„ÙƒÙŠ Ø¯Ø¨Ù„", price: "4.50", img: "https://images.unsplash.com/photo-1529006557810-274b9b2fc783?w=500", desc: "Ù„Ø­Ù… Ø·Ø§Ø²Ø¬ØŒ Ø«ÙˆÙ…ÙŠØ©ØŒ Ø¨Ø·Ø§Ø·Ø³ØŒ Ø®Ø¶Ø§Ø±", time: "12 Ø¯" },
                    { id: 2, name: "Ø¨Ø±ØºØ± Ù…Ù„ÙƒÙŠ", price: "5.00", img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=500", desc: "Ù„Ø­Ù… Ø¨Ù‚Ø±ÙŠØŒ Ø¬Ø¨Ù†Ø©ØŒ Ø®Ø³ØŒ Ø·Ù…Ø§Ø·Ù…", time: "15 Ø¯" },
                    { id: 3, name: "Ø¯Ø¬Ø§Ø¬ Ù…Ø´ÙˆÙŠ", price: "3.75", img: "https://images.unsplash.com/photo-1532550907401-a500c9a57435?w=500", desc: "Ø¯Ø¬Ø§Ø¬ Ù…Ø´ÙˆÙŠ Ù…Ø¹ Ø£Ø±Ø² ÙˆØ®Ø¶Ø§Ø±", time: "18 Ø¯" }
                ] 
            },
            { 
                category: "Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª", 
                items: [
                    { id: 4, name: "Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„ Ø·Ø§Ø²Ø¬", price: "1.50", img: "https://images.unsplash.com/photo-1621506289937-a8e4df240d0b?w=500", desc: "Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„ Ø·Ø¨ÙŠØ¹ÙŠ 100%", time: "5 Ø¯" },
                    { id: 5, name: "ÙƒÙˆÙ„Ø§", price: "1.00", img: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=500", desc: "Ù…Ø´Ø±ÙˆØ¨ ØºØ§Ø²ÙŠ", time: "2 Ø¯" }
                ] 
            }
        ];
        
        let cart = [];
        let socket;

        function connect() {
            try {
                socket = new WebSocket("ws://192.168.1.101:8080");
                
                socket.onopen = function() {
                    console.log("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
                };
                
                socket.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        const bar = document.getElementById('status-bar');
                        const txt = document.getElementById('status-text');
                        const statusId = document.getElementById('status-id');
                        
                        bar.style.display = 'block';
                        bar.style.animation = 'fadeInDown 0.5s ease';
                        
                        if(msg.status === "preparing") {
                            txt.innerText = "ğŸ‘¨â€ğŸ³ Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¢Ù†";
                            if(msg.estimatedTime) {
                                statusId.innerText = "â± " + msg.estimatedTime + " | #" + (msg.orderId || "");
                            } else {
                                statusId.innerText = "#" + (msg.orderId || "");
                            }
                        }
                        else if(msg.status === "ready") { 
                            txt.innerText = "âœ… Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…!";
                            statusId.innerText = "#" + (msg.orderId || "");
                            showNotification("Ø·Ù„Ø¨Ùƒ Ø£ØµØ¨Ø­ Ø¬Ø§Ù‡Ø²Ø§Ù‹ Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…!");
                        }
                        else if(msg.status === "rejected") { 
                            txt.innerText = "âŒ Ù†Ø¹ØªØ°Ø±ØŒ ØªØ¹Ø°Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨";
                            statusId.innerText = "#" + (msg.orderId || "");
                            showNotification("Ù†Ø¹ØªØ°Ø±ØŒ ØªØ¹Ø°Ø± Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹");
                        }
                        else if(msg.status === "received") {
                            txt.innerText = "ğŸ“¥ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ";
                            statusId.innerText = "#" + (msg.orderId || "");
                        }
                        
                        setTimeout(() => {
                            bar.style.animation = 'fadeInDown 0.5s ease reverse';
                            setTimeout(() => { bar.style.display = 'none'; }, 500);
                        }, 5000);
                        
                    } catch(err) {
                        console.log("Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:", e.data);
                    }
                };
                
                socket.onerror = function(error) {
                    console.log("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
                };
                
                socket.onclose = function() {
                    console.log("ğŸ”Œ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
                };
                
            } catch(err) {
                console.log("âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebSocket");
            }
        }

        function showNotification(text) {
            const notif = document.getElementById('notification');
            notif.innerText = text;
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.display = 'none';
            }, 3000);
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ---
        function renderMenu(filter = "") {
            const view = document.getElementById('menuView');
            view.innerHTML = "";
            
            db.forEach(cat => {
                const items = cat.items.filter(i => 
                    i.name.includes(filter) || 
                    (i.desc && i.desc.includes(filter))
                );
                
                if(items.length === 0) return;
                
                let html = `<h2 class="category-title">${cat.category}</h2><div class="menu-grid">`;
                
                items.forEach(item => {
                    html += `
                        <div class="item-card" onclick="openItemDetails(${item.id})">
                            <img src="${item.img || 'https://via.placeholder.com/150'}" alt="${item.name}">
                            <div class="item-info">
                                <span class="item-name">${item.name}</span>
                                <span class="item-price">${item.price} Ø¯.Ø£</span>
                            </div>
                        </div>
                    `;
                });
                
                view.innerHTML += html + `</div>`;
            });
            
            if(view.innerHTML === "") {
                view.innerHTML = `
                    <div style="text-align:center; padding:50px 20px;">
                        <i class="fas fa-search" style="font-size:3rem; color:#333; margin-bottom:20px;"></i>
                        <h3 style="color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
                        <p style="color:#444;">Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ù…Ø§Øª Ø¨Ø­Ø« Ø£Ø®Ø±Ù‰</p>
                    </div>
                `;
            }
        }

        function openItemDetails(id) {
            let item;
            db.forEach(c => c.items.forEach(i => { if(i.id == id) item = i; }));
            
            if(!item) return;
            
            document.getElementById('itemDetails').innerHTML = `
                <img src="${item.img || 'https://via.placeholder.com/150'}" 
                     style="width:100%; border-radius:20px; margin-bottom:20px; height:200px; object-fit:cover;"
                     alt="${item.name}">
                <h2 style="color:var(--gold); margin-bottom:10px;">${item.name}</h2>
                <p style="color:#888; margin-bottom:15px; font-size:0.9rem; line-height:1.5;">${item.desc || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"}</p>
                <div class="prep-time">
                    â± ÙˆÙ‚Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²: ${item.time || "10 Ø¯"}
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <span style="font-size:1.5rem; font-weight:900; color:var(--gold);">${item.price} Ø¯.Ø£</span>
                    <button class="btn-submit" onclick="addToCart(${item.id})" style="width:auto; padding:12px 30px;">
                        <i class="fas fa-plus" style="margin-left:5px;"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
                    </button>
                </div>
            `;
            document.getElementById('itemModal').style.display = 'flex';
        }

        function addToCart(id) {
            let item;
            db.forEach(c => c.items.forEach(i => { if(i.id == id) item = i; }));
            
            if(!item) return;
            
            cart.push(item);
            document.getElementById('count').innerText = cart.length;
            document.getElementById('cartCapsule').style.display = 'block';
            document.getElementById('itemModal').style.display = 'none';
            
            showNotification("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø© âœ“");
        }

        function toggleDelivery() {
            const deliveryFields = document.getElementById('deliveryFields');
            const isChecked = document.getElementById('isDelivery').checked;
            deliveryFields.style.display = isChecked ? 'block' : 'none';
        }

        function openCart() {
            if(cart.length === 0) {
                showNotification("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
                return;
            }
            
            const list = document.getElementById('cartItemsList');
            const counts = {};
            
            cart.forEach(i => counts[i.name] = (counts[i.name] || 0) + 1);
            
            list.innerHTML = Object.keys(counts).map(name => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; font-size:0.9rem; align-items:center;">
                    <span>${name}</span> 
                    <span style="color:var(--gold); font-weight:bold;">x${counts[name]}</span>
                </div>
            `).join('');
            
            document.getElementById('cartModal').style.display = 'flex';
        }

        // --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ø²Ø± Ø§Ù„Ø°ÙƒÙŠ) ---
        function processFinalOrder() {
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            
            if(!name || !phone) {
                showNotification("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‡Ø§ØªÙ");
                return;
            }
            
            if(!phone.match(/^07[0-9]{8}$/)) {
                showNotification("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 10 Ø£Ø±Ù‚Ø§Ù… ÙˆÙŠØ¨Ø¯Ø£ Ø¨Ù€ 07)");
                return;
            }
            
            const isDelivery = document.getElementById('isDelivery').checked;
            let address = "Ø§Ø³ØªÙ„Ø§Ù… ÙØ±Ø¹";
            
            if(isDelivery) {
                const area = document.getElementById('area').value.trim();
                const street = document.getElementById('street').value.trim();
                const house = document.getElementById('house').value.trim();
                
                if(!area || !street) {
                    showNotification("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ù„ØªÙˆØµÙŠÙ„");
                    return;
                }
                
                address = `${area} - ${street} ${house ? ' - ' + house : ''}`;
            }
            
            const orderId = "MS-" + Date.now().toString().slice(-6);
            
            document.getElementById('currentOrderId').innerText = orderId;
            document.getElementById('orderForm').style.display = 'none';
            document.getElementById('loadingOrder').style.display = 'block';
            
            const orderData = {
                orderID: orderId,
                customer: name,
                phone: phone,
                items: cart,
                address: address,
                timestamp: new Date().toISOString(),
                isDelivery: isDelivery,
                total: calculateTotal()
            };
            
            setTimeout(() => {
                if(socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify(orderData));
                    document.getElementById('status-bar').style.display = 'block';
                    document.getElementById('status-text').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
                    document.getElementById('status-id').innerText = "#" + orderId;
                } else {
                    console.log("Ø§Ù„Ø§ØªØµØ§Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹");
                    saveOrderLocally(orderData);
                }
                
                document.getElementById('cartModal').style.display = 'none';
                cart = [];
                document.getElementById('cartCapsule').style.display = 'none';
                document.getElementById('count').innerText = "0";
                resetOrderForm();
                
                showNotification("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ“");
                
            }, 1500);
        }

        function calculateTotal() {
            return cart.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                return sum + price;
            }, 0).toFixed(2);
        }

        function saveOrderLocally(orderData) {
            const orders = JSON.parse(localStorage.getItem('sultan_orders')) || [];
            orders.push(orderData);
            localStorage.setItem('sultan_orders', JSON.stringify(orders));
        }

        function resetOrderForm() {
            document.getElementById('orderForm').style.display = 'block';
            document.getElementById('loadingOrder').style.display = 'none';
            document.getElementById('custName').value = "";
            document.getElementById('custPhone').value = "";
            document.getElementById('area').value = "";
            document.getElementById('street').value = "";
            document.getElementById('house').value = "";
            document.getElementById('isDelivery').checked = false;
            document.getElementById('deliveryFields').style.display = 'none';
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© TRAD ---
        function checkTrad(val) {
            if(val.toLowerCase() === 'trad') {
                document.getElementById('admin-panel').style.display = 'block';
                renderAdmin();
            } else {
                renderMenu(val);
            }
        }

        function renderAdmin() {
            const container = document.getElementById('adminContainer');
            container.innerHTML = db.map((cat, cIdx) => `
                <div class="admin-card">
                    <input class="modern-input" style="color:var(--gold); font-weight:bold; margin-bottom:15px;" 
                           value="${cat.category}" 
                           onchange="db[${cIdx}].category=this.value">
                    
                    ${cat.items.map((item, iIdx) => `
                        <div style="background:#000; padding:15px; border-radius:15px; margin-top:10px; border:1px solid #222;">
                            <input class="modern-input" style="margin-bottom:8px;" 
                                   value="${item.name}" 
                                   onchange="db[${cIdx}].items[${iIdx}].name=this.value"
                                   placeholder="Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ø¨Ø©">
                            
                            <input class="modern-input" style="margin-bottom:8px;" 
                                   value="${item.price}" 
                                   onchange="db[${cIdx}].items[${iIdx}].price=this.value"
                                   placeholder="Ø§Ù„Ø³Ø¹Ø±">
                            
                            <input class="modern-input" style="margin-bottom:8px;" 
                                   value="${item.img}" 
                                   onchange="db[${cIdx}].items[${iIdx}].img=this.value" 
                                   placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
                            
                            <input class="modern-input" style="margin-bottom:8px;" 
                                   value="${item.desc || ''}" 
                                   onchange="db[${cIdx}].items[${iIdx}].desc=this.value" 
                                   placeholder="ÙˆØµÙ Ø§Ù„ÙˆØ¬Ø¨Ø©">
                            
                            <input class="modern-input" style="margin-bottom:10px;" 
                                   value="${item.time || '10 Ø¯'}" 
                                   onchange="db[${cIdx}].items[${iIdx}].time=this.value" 
                                   placeholder="ÙˆÙ‚Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ² (Ù…Ø«Ø§Ù„: 12 Ø¯)">
                            
                            <button onclick="db[${cIdx}].items.splice(${iIdx},1); renderAdmin()" 
                                    style="color:#ff4444; background:none; border:none; font-size:0.8rem; cursor:pointer; padding:5px 10px;">
                                <i class="fas fa-trash" style="margin-left:5px;"></i> Ø­Ø°Ù Ø§Ù„ØµÙ†Ù
                            </button>
                        </div>
                    `).join('')}
                    
                    <button onclick="addItem(${cIdx})" 
                            style="width:100%; margin-top:15px; background:#333; color:#fff; border:none; padding:12px; border-radius:10px; cursor:pointer;">
                        <i class="fas fa-plus" style="margin-left:5px;"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØ¬Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            `).join('');
        }

        function addItem(cIdx) { 
            db[cIdx].items.push({ 
                id: Date.now(), 
                name: "ÙˆØ¬Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©", 
                price: "2.50", 
                img: "", 
                desc: "ÙˆØµÙ Ø§Ù„ÙˆØ¬Ø¨Ø©", 
                time: "10 Ø¯" 
            }); 
            renderAdmin(); 
        }
        
        function addCategory() { 
            db.push({ 
                category: "Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯", 
                items: [] 
            }); 
            renderAdmin(); 
        }
        
        function saveAndCloseAdmin() {
            localStorage.setItem('sultan_final_v1', JSON.stringify(db));
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('mainSearch').value = "";
            renderMenu();
            showNotification("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ“");
        }

        function closeCart() { 
            document.getElementById('cartModal').style.display = 'none'; 
        }

        window.onload = () => { 
            renderMenu(); 
            connect();
            
            document.addEventListener('keydown', function(e) {
                if(e.key === 'Escape') {
                    document.getElementById('cartModal').style.display = 'none';
                    document.getElementById('itemModal').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>
