<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الاتصال المتكامل - محادثات ومكالمات وقصص</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* ====== المتغيرات العامة (قابلة للتخصيص) ====== */
        :root {
            --primary: #2563eb;        --primary-dark: #1d4ed8;    --success: #059669;         --danger: #dc2626;
            --warning: #d97706;         --bg: #0f172a;             --card: #1e293b;           --text: #f8fafc;
            --text-secondary: #94a3b8; --border: #334155;         --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --border-radius-card: 24px; --border-radius-btn: 12px;  --transition-speed: 0.3s;
            --toast-bg: #1e293b;        --toast-text: #f8fafc;      --chat-width: 350px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-main); background-color: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; position: relative; }

        /* ====== Toast Notifications ====== */
        .toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--toast-bg); color: var(--toast-text); padding: 12px 24px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); border-left: 4px solid var(--primary); animation: slideIn 0.3s ease; max-width: 300px; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ====== شاشات الدخول والتسجيل (كما هي) ====== */
        #setupScreen { position: fixed; inset: 0; background: linear-gradient(135deg, var(--bg) 0%, #1e1b4b 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s; }
        .auth-card { background: var(--card); padding: 40px; border-radius: var(--border-radius-card); text-align: center; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6); border: 1px solid var(--border); animation: fadeIn 0.5s ease; }
        .auth-card h2 { margin-top: 0; margin-bottom: 15px; font-size: 28px; background: linear-gradient(to right, var(--primary), #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-input { width: 100%; padding: 14px 16px; border-radius: 12px; border: 2px solid var(--border); background: var(--bg); color: var(--text); font-size: 16px; margin-bottom: 15px; outline: none; transition: border-color 0.2s; }
        .auth-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .auth-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.2s; margin-top: 10px; }
        .auth-btn:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.4); }
        .auth-switch { margin-top: 20px; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; }
        .auth-switch:hover { color: var(--primary); }

        /* ====== نافذة نسيت كلمة المرور ====== */
        .forgot-password-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .forgot-modal-content { background: var(--card); padding: 30px; border-radius: var(--border-radius-card); width: 90%; max-width: 400px; text-align: center; }

        /* ====== شاشة إدخال رمز التحقق ====== */
        .verification-container { display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .code-input { width: 60px; height: 70px; text-align: center; font-size: 28px; font-weight: bold; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); }
        .code-input:focus { border-color: var(--primary); }

        /* ====== التطبيق الرئيسي ====== */
        .app-container { width: 100%; max-width: 1400px; padding: 20px; display: none; flex-direction: column; gap: 20px; }

        /* الهيدر */
        .app-header { background: var(--card); padding: 20px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #7c3aed); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; object-fit: cover; }
        .user-name { font-size: 18px; font-weight: 600; }
        .user-status { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-secondary); }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; background-color: var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .header-actions { display: flex; gap: 15px; }
        .btn-icon { width: 50px; height: 50px; border-radius: 50%; background: var(--bg); border: 1px solid var(--border); color: var(--text); font-size: 20px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: var(--primary); }
        .btn-icon.active { background: var(--primary); }

        /* ====== شريط التحكم ====== */
        .control-bar { background: var(--card); padding: 20px; border-radius: 20px; display: flex; gap: 15px; flex-wrap: wrap; border: 1px solid var(--border); }
        .search-container { position: relative; flex: 1; min-width: 300px; }
        .search-container input { width: 100%; padding: 14px 20px 14px 45px; border-radius: 12px; border: 2px solid var(--border); background: var(--bg); color: var(--text); font-size: 16px; transition: all 0.3s; }
        .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .search-results { position: absolute; width: 100%; background: var(--card); border-radius: 12px; margin-top: 5px; display: none; z-index: 100; max-height: 300px; overflow-y: auto; }

        /* ====== قسم القصص ====== */
        .stories-section { background: var(--card); padding: 15px; border-radius: 20px; border: 1px solid var(--border); overflow-x: auto; white-space: nowrap; }
        .stories-container { display: flex; gap: 15px; padding: 5px; }
        .story-item { display: inline-flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; }
        .story-avatar { width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; background: var(--bg); }
        .story-avatar.add { border: 2px dashed var(--primary); display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--primary); }
        .story-username { font-size: 12px; margin-top: 5px; color: var(--text-secondary); max-width: 70px; overflow: hidden; text-overflow: ellipsis; }

        /* ====== قائمة المستخدمين المتصلين ====== */
        .users-section { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); }
        .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; max-height: 300px; overflow-y: auto; padding: 5px; }
        .user-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg); border-radius: 16px; border: 1px solid var(--border); transition: all 0.2s; }
        .user-card:hover { background: var(--border); transform: translateY(-2px); }
        .user-card-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; color: white; cursor: pointer; }
        .user-card-info { flex: 1; cursor: pointer; }
        .user-card-name { font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        .online-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--success); display: inline-block; }
        .offline-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--text-secondary); display: inline-block; }
        .last-seen { font-size: 10px; color: var(--text-secondary); }
        .user-card-status { font-size: 12px; color: var(--text-secondary); }
        .user-card-status.online { color: var(--success); }
        .user-card-status.in-call { color: var(--warning); }
        .user-actions { display: flex; gap: 5px; flex-direction: column; }
        .chat-btn, .follow-btn, .call-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); border-radius: 20px; padding: 4px 10px; font-size: 12px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
        .chat-btn:hover, .follow-btn:hover, .call-btn:hover { background: var(--primary); color: white; }

        /* ====== نافذة الدردشة ====== */
        .chat-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 4000; }
        .chat-container { background: var(--card); width: 90%; max-width: 1000px; height: 85vh; border-radius: 24px; display: flex; overflow: hidden; }
        .chat-sidebar { width: 300px; background: var(--bg); border-left: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; }
        .chat-sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .chat-user-item { display: flex; align-items: center; gap: 10px; padding: 15px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border); }
        .chat-user-item:hover { background: var(--border); }
        .chat-user-item.active { background: var(--primary); color: white; }
        .chat-user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .chat-user-info { flex: 1; }
        .chat-user-name { font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .chat-last-message { font-size: 12px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .unread-badge { background: var(--primary); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .chat-main { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; background: var(--card); }
        .chat-header-user { display: flex; align-items: center; gap: 10px; flex: 1; }
        .chat-header-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .chat-header-info { flex: 1; }
        .chat-header-name { font-weight: 600; }
        .chat-header-status { font-size: 12px; color: var(--text-secondary); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: var(--bg); }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; position: relative; }
        .message.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-left-radius: 4px; }
        .message.received { align-self: flex-start; background: var(--card); border-bottom-right-radius: 4px; }
        .message-image { max-width: 200px; max-height: 200px; border-radius: 10px; cursor: pointer; }
        .message-video { max-width: 250px; border-radius: 10px; }
        .message-file { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 10px; }
        .message-time { font-size: 10px; opacity: 0.7; margin-top: 5px; text-align: left; }
        .seen-indicator { font-size: 10px; margin-left: 5px; }
        .typing-indicator { padding: 10px 20px; color: var(--text-secondary); font-style: italic; }
        .chat-input-area { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: var(--card); }
        .chat-input { flex: 1; padding: 12px 15px; border-radius: 30px; border: 1px solid var(--border); background: var(--bg); color: var(--text); outline: none; }
        .chat-attach-btn, .chat-send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .chat-attach-btn { background: var(--bg); border: 1px solid var(--border); color: var(--text); }
        .attach-options { position: absolute; bottom: 80px; left: 20px; background: var(--card); border-radius: 12px; padding: 10px; display: none; flex-direction: column; gap: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .attach-options button { background: none; border: none; color: var(--text); padding: 8px 15px; text-align: right; cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; border-radius: 8px; }
        .attach-options button:hover { background: var(--border); }

        /* ====== مربعات الفيديو (كما هي) ====== */
        .video-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .video-column { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 20px; }
        .video-box { position: relative; background: #000; border-radius: 20px; overflow: hidden; border: 2px solid var(--border); aspect-ratio: 16/9; transition: all 0.3s; }
        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        #localVideo { transform: scaleX(-1); }
        .video-label { position: absolute; bottom: 15px; left: 15px; background: rgba(0, 0, 0, 0.7); padding: 8px 16px; border-radius: 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .video-overlay { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .mic-indicator, .cam-indicator { width: 10px; height: 10px; border-radius: 50%; }
        .mic-indicator.on, .cam-indicator.on { background-color: var(--success); }
        .mic-indicator.off, .cam-indicator.off { background-color: var(--danger); }

        /* ====== فلاتر تجميلية ====== */
        .filter-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; padding: 15px; background: var(--bg); border-radius: 16px; justify-content: center; }
        .filter-btn { padding: 10px 16px; border: 1px solid var(--border); border-radius: 30px; background: var(--card); color: var(--text); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .filter-btn.active { background: var(--primary); border-color: var(--primary); }

        /* ====== الأزرار السفلية ====== */
        .bottom-controls { background: var(--card); padding: 20px; border-radius: 20px; display: flex; justify-content: center; gap: 20px; margin-top: 20px; border: 1px solid var(--border); flex-wrap: wrap; }
        .btn { padding: 14px 24px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; font-size: 16px; display: inline-flex; align-items: center; gap: 10px; transition: all 0.2s; min-width: 140px; justify-content: center; }
        .btn i { font-size: 18px; }
        .btn-main { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-video { background: linear-gradient(135deg, var(--success), #047857); color: white; }
        .btn-audio { background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #b91c1c); color: white; }
        .btn-end-call { background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; width: 200px; }
        .btn-toggle { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; background: var(--bg); color: white; font-size: 24px; transition: all 0.2s; }
        .btn-toggle.active { background: var(--success); }
        .btn-toggle.inactive { background: var(--danger); }

        /* ====== نافذة المكالمة الواردة ====== */
        .incoming-call-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .call-modal-content { background: var(--card); padding: 40px; border-radius: 24px; text-align: center; max-width: 500px; width: 90%; }

        /* ====== نافذة الملف الشخصي ====== */
        .profile-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .profile-content { background: var(--card); padding: 30px; border-radius: 24px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        .profile-stats { display: flex; gap: 20px; margin: 20px 0; justify-content: center; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 14px; color: var(--text-secondary); }
        .profile-bio { margin: 15px 0; color: var(--text-secondary); text-align: center; }

        /* ====== نافذة عرض القصة ====== */
        .story-viewer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 3500; }
        .story-content { max-width: 400px; width: 90%; background: #000; border-radius: 20px; overflow: hidden; position: relative; }
        .story-image { width: 100%; max-height: 70vh; object-fit: contain; }
        .story-text { padding: 20px; color: white; text-align: center; }
        .story-interactions { padding: 15px; background: var(--card); display: flex; gap: 20px; justify-content: center; }
        .interact-btn { background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .comments-section { max-height: 200px; overflow-y: auto; padding: 10px; background: var(--bg); }
        .comment { padding: 8px; border-bottom: 1px solid var(--border); }

        /* ====== حالة الاتصال ====== */
        .status-footer { margin-top: 20px; text-align: center; font-size: 14px; color: var(--text-secondary); }
        .status-connected { color: var(--success); }
        .status-disconnected { color: var(--danger); }

        /* ====== لوحة التخصيص ====== */
        .customize-panel { position: fixed; top: 100px; right: 20px; background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); z-index: 5000; display: none; flex-direction: column; gap: 15px; width: 250px; }
        .customize-panel.show { display: flex; }
        .customize-item { display: flex; flex-direction: column; gap: 5px; }
        .customize-item label { font-size: 14px; color: var(--text-secondary); }
        .customize-item input { padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }

        @media (max-width: 768px) {
            .control-bar { flex-direction: column; }
            .search-container { min-width: 100%; }
            .btn { min-width: 120px; }
            .code-input { width: 50px; height: 60px; font-size: 24px; }
            .users-grid { grid-template-columns: 1fr; }
            .chat-container { flex-direction: column; width: 95%; height: 90vh; }
            .chat-sidebar { width: 100%; height: 200px; }
            .user-actions { flex-direction: row; }
        }
    </style>
</head>
<body>

<!-- شاشة المصادقة -->
<div id="setupScreen">
    <div class="auth-card" id="authContainer"></div>
</div>

<!-- نافذة نسيت كلمة المرور -->
<div class="forgot-password-modal" id="forgotPasswordModal">
    <div class="forgot-modal-content">
        <h2 style="margin-bottom: 20px;">استعادة كلمة المرور</h2>
        <p style="color: var(--text-secondary); margin-bottom: 25px;">أدخل بريدك الإلكتروني لاستلام رمز التحقق</p>
        <input type="email" id="forgotEmail" class="auth-input" placeholder="البريد الإلكتروني">
        <div id="resetCodeSection" style="display: none;">
            <div class="verification-container" style="margin: 15px 0;">
                <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 0)" onkeyup="handleCodeInput(event, this, 0)">
                <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)" onkeyup="handleCodeInput(event, this, 1)">
                <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)" onkeyup="handleCodeInput(event, this, 2)">
                <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)" onkeyup="handleCodeInput(event, this, 3)">
            </div>
            <input type="password" id="newPassword" class="auth-input" placeholder="كلمة المرور الجديدة">
        </div>
        <button class="auth-btn" id="forgotActionBtn">إرسال الرمز</button>
        <div class="auth-switch" onclick="document.getElementById('forgotPasswordModal').style.display='none'">إلغاء</div>
        <div id="forgotError" style="color: var(--danger); margin-top: 15px;"></div>
    </div>
</div>

<!-- نافذة الملف الشخصي -->
<div class="profile-modal" id="profileModal">
    <div class="profile-content">
        <div class="profile-header">
            <img class="profile-avatar" id="profileAvatar" src="https://via.placeholder.com/80">
            <div>
                <h2 id="profileUsername">اسم المستخدم</h2>
            </div>
        </div>
        <div class="profile-bio" id="profileBio">السيرة الذاتية</div>
        <div class="profile-stats">
            <div class="stat-item"><span class="stat-number" id="profileFollowers">0</span><div class="stat-label">متابعون</div></div>
            <div class="stat-item"><span class="stat-number" id="profileFollowing">0</span><div class="stat-label">يتابع</div></div>
            <div class="stat-item"><span class="stat-number" id="profileStories">0</span><div class="stat-label">قصص</div></div>
        </div>
        <button class="auth-btn" onclick="closeProfile()">إغلاق</button>
    </div>
</div>

<!-- نافذة عرض القصة -->
<div class="story-viewer" id="storyViewer">
    <div class="story-content">
        <img class="story-image" id="storyImage" src="" alt="قصة">
        <div class="story-text" id="storyText"></div>
        <div class="story-interactions">
            <button class="interact-btn" onclick="likeCurrentStory()"><i class="fas fa-heart"></i> <span id="storyLikes">0</span></button>
            <button class="interact-btn" onclick="showCommentBox()"><i class="fas fa-comment"></i> <span id="storyComments">0</span></button>
        </div>
        <div class="comments-section" id="storyCommentsList"></div>
        <button class="auth-btn" style="margin: 10px;" onclick="closeStoryViewer()">إغلاق</button>
    </div>
</div>

<!-- نافذة الدردشة -->
<div class="chat-modal" id="chatModal">
    <div class="chat-container">
        <div class="chat-sidebar">
            <div class="chat-sidebar-header">
                <span><i class="fas fa-comments"></i> المحادثات</span>
                <button class="btn-icon" style="width:30px;height:30px;" onclick="loadChats()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div id="chatUsersList" style="flex:1; overflow-y: auto;"></div>
        </div>
        <div class="chat-main">
            <div class="chat-header" id="chatHeader" style="display: none;">
                <div class="chat-header-user">
                    <img src="https://via.placeholder.com/40" class="chat-header-avatar" id="chatCurrentAvatar">
                    <div class="chat-header-info">
                        <div class="chat-header-name" id="chatCurrentName"></div>
                        <div class="chat-header-status" id="chatCurrentStatus"></div>
                    </div>
                </div>
                <button class="btn-icon" style="width:35px;height:35px;" onclick="closeChat()"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="typing-indicator" id="typingIndicator" style="display: none;">يكتب...</div>
            <div class="chat-input-area" id="chatInputArea" style="display: none;">
                <button class="chat-attach-btn" id="attachBtn"><i class="fas fa-paperclip"></i></button>
                <div class="attach-options" id="attachOptions">
                    <button onclick="sendMedia('image')"><i class="fas fa-image"></i> صورة</button>
                    <button onclick="sendMedia('video')"><i class="fas fa-video"></i> فيديو</button>
                    <button onclick="sendMedia('file')"><i class="fas fa-file"></i> ملف</button>
                </div>
                <input type="text" class="chat-input" id="chatInput" placeholder="اكتب رسالة...">
                <button class="chat-send-btn" id="chatSendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<!-- التطبيق الرئيسي -->
<div class="app-container" id="mainApp">
    <!-- الهيدر -->
    <div class="app-header">
        <div class="user-info" onclick="openMyProfile()">
            <img class="user-avatar" id="userAvatar" src="https://via.placeholder.com/50" alt="صورة المستخدم">
            <div>
                <div class="user-name" id="myNameLabel">مستخدم</div>
                <div class="user-status">
                    <div class="status-indicator"></div>
                    <span id="connectionStatus">متصل بالسيرفر</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-icon" id="chatToggleBtn" onclick="toggleChat()"><i class="fas fa-comment"></i></button>
            <button class="btn-icon" id="customizeBtn" onclick="toggleCustomize()"><i class="fas fa-palette"></i></button>
            <button class="btn-icon" id="profileBtn" onclick="openMyProfile()"><i class="fas fa-user"></i></button>
            <button class="btn-icon" id="uploadAvatarBtn"><i class="fas fa-camera"></i></button>
            <input type="file" id="avatarUploadInput" accept="image/*" style="display: none;">
        </div>
        <div class="call-timer" id="callTimer" style="display: none;">
            <span style="font-weight: bold; color: var(--success);"><i class="fas fa-clock"></i> <span id="timerDisplay">00:00</span></span>
        </div>
    </div>

    <!-- شريط التحكم -->
    <div class="control-bar">
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="targetNameInput" placeholder="ابحث عن مستخدم للاتصال به...">
            <div class="search-results" id="searchResults"></div>
        </div>
        <div class="call-buttons">
            <button class="btn btn-audio" onclick="callUser('audio')"><i class="fas fa-phone-alt"></i><span>اتصال صوتي</span></button>
            <button class="btn btn-video" onclick="callUser('video')"><i class="fas fa-video"></i><span>اتصال مرئي</span></button>
            <button class="btn btn-random" id="randomCallBtn" onclick="requestRandomCall()"><i class="fas fa-random"></i><span>اتصال عشوائي</span></button>
        </div>
    </div>

    <!-- قسم القصص -->
    <div class="stories-section">
        <div class="stories-container" id="storiesContainer">
            <div class="story-item" onclick="showAddStoryModal()">
                <div class="story-avatar add"><i class="fas fa-plus"></i></div>
                <span class="story-username">إضافة قصة</span>
            </div>
        </div>
    </div>

    <!-- قائمة المستخدمين المتصلين -->
    <div class="users-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color: var(--text);"><i class="fas fa-users" style="margin-left: 10px;"></i> المستخدمون المتصلون</h3>
            <span style="background: var(--primary); padding: 5px 12px; border-radius: 20px; font-size: 14px;" id="onlineCount">0</span>
        </div>
        <div class="users-grid" id="onlineUsersGrid"></div>
    </div>

    <!-- شبكة الفيديو -->
    <div class="video-container">
        <div class="video-column">
            <div class="video-box" id="localVideoContainer">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="video-label">
                    <span>أنت</span>
                    <div class="mic-indicator on" id="localMicIndicator"></div>
                    <div class="cam-indicator on" id="localCamIndicator"></div>
                </div>
                <div class="video-overlay">
                    <button class="btn-toggle" id="toggleVideoBtn"><i class="fas fa-video"></i></button>
                    <button class="btn-toggle" id="toggleAudioBtn"><i class="fas fa-microphone"></i></button>
                </div>
            </div>
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="none"><i class="fas fa-ban"></i> عادي</button>
                <button class="filter-btn" data-filter="grayscale(1)"><i class="fas fa-palette"></i> أبيض وأسود</button>
                <button class="filter-btn" data-filter="sepia(0.8)"><i class="fas fa-image"></i> بني داكن</button>
                <button class="filter-btn" data-filter="blur(3px)"><i class="fas fa-cloud"></i> ضباب</button>
                <button class="filter-btn" data-filter="invert(1)"><i class="fas fa-adjust"></i> سلبي</button>
                <button class="filter-btn" data-filter="contrast(1.5)"><i class="fas fa-circle"></i> تباين عالي</button>
            </div>
        </div>
        <div class="video-column">
            <div class="video-box" id="remoteVideoContainer">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="video-label" id="remoteTag">
                    <span>في انتظار الاتصال...</span>
                    <div class="mic-indicator off" id="remoteMicIndicator"></div>
                    <div class="cam-indicator off" id="remoteCamIndicator"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- لوحة التحكم السفلية -->
    <div class="bottom-controls">
        <button class="btn-toggle active" id="toggleMicBtn"><i class="fas fa-microphone"></i></button>
        <button class="btn-toggle active" id="toggleCamBtn"><i class="fas fa-video"></i></button>
        <button class="btn-toggle" id="flipCameraBtn" onclick="flipCamera()"><i class="fas fa-sync-alt"></i></button>
        <button class="btn btn-end-call" id="endCallBtn" onclick="endCall()" style="display: none;"><i class="fas fa-phone-slash"></i><span>إنهاء المكالمة</span></button>
        <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>خروج</span></button>
    </div>

    <!-- حالة النظام -->
    <div class="status-footer">
        <span id="statusMsg">الحالة: <span class="status-connected">متصل بالسيرفر</span></span> | 
        <span id="onlineUsers">المستخدمون المتصلون: 1</span>
    </div>
</div>

<!-- نافذة المكالمة الواردة -->
<div class="incoming-call-modal" id="incomingCallModal">
    <div class="call-modal-content">
        <div class="caller-info">
            <div class="caller-avatar" id="callerAvatar">?</div>
            <div>
                <div style="font-size: 24px; font-weight: bold;" id="callerName">مستخدم</div>
                <div class="call-type" id="incomingCallType">اتصال صوتي</div>
            </div>
        </div>
        <p style="color: var(--text-secondary); margin-bottom: 30px;">يريد الاتصال بك</p>
        <div class="call-actions">
            <button class="btn btn-danger" onclick="rejectCall()" style="min-width: 120px;"><i class="fas fa-times"></i> رفض</button>
            <button class="btn btn-success" onclick="acceptCall()" style="min-width: 120px;"><i class="fas fa-check"></i> قبول</button>
        </div>
    </div>
</div>

<!-- لوحة التخصيص -->
<div class="customize-panel" id="customizePanel">
    <h4>تخصيص الواجهة</h4>
    <div class="customize-item">
        <label>اللون الأساسي</label>
        <input type="color" id="primaryColor" value="#2563eb">
    </div>
    <div class="customize-item">
        <label>حجم الخط</label>
        <input type="range" id="fontSize" min="12" max="24" value="16">
    </div>
    <button class="auth-btn" onclick="applyCustomizations()">تطبيق</button>
</div>

<!-- Toast Notifications -->
<div class="toast-container" id="toastContainer"></div>

<script>
    // ==================== المتغيرات العامة ====================
    const SERVER_URL = "http://192.168.1.101:3000";

    let socket;
    let myName = "", myEmail = "", myUserId = null;
    let localStream = null, peerConnection = null, currentCall = null, callType = null, isCallActive = false;
    let incomingCallData = null, connectedUsers = [];
    let isWaitingRandom = false;
    let videoDevices = [], currentDeviceId = null;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // متغيرات المتابعة والقصص والدردشة
    let myFollowings = new Set();
    let myStories = [];
    let currentStory = null;
    let chats = []; // قائمة المحادثات مع المستخدمين
    let currentChatUser = null; // المستخدم الذي نتحادث معه حالياً
    let messages = []; // رسائل المحادثة الحالية
    let typingTimeout = null;

    // ==================== Toast Notifications ====================
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerText = message;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // ==================== نظام المصادقة ====================
    const authContainer = document.getElementById('authContainer');

    function showLoginScreen() {
        authContainer.innerHTML = `
            <h2>تسجيل الدخول</h2>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">أدخل بريدك الإلكتروني وكلمة المرور</p>
            <input type="email" id="loginEmail" class="auth-input" placeholder="البريد الإلكتروني">
            <input type="password" id="loginPassword" class="auth-input" placeholder="كلمة المرور">
            <button class="auth-btn" onclick="login()">دخول</button>
            <div style="margin-top: 15px;"><span class="auth-switch" onclick="showForgotPassword()">نسيت كلمة المرور؟</span></div>
            <div class="auth-switch" onclick="showSignupScreen()">ليس لديك حساب؟ أنشئ حساب جديد</div>
            <div id="authError" style="color: var(--danger); margin-top: 15px; font-size: 14px;"></div>
        `;
    }

    function showSignupScreen() {
        authContainer.innerHTML = `
            <h2>إنشاء حساب جديد</h2>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">أدخل بريدك الإلكتروني واسم المستخدم</p>
            <input type="email" id="signupEmail" class="auth-input" placeholder="البريد الإلكتروني">
            <input type="text" id="signupUsername" class="auth-input" placeholder="اسم المستخدم">
            <input type="password" id="signupPassword" class="auth-input" placeholder="كلمة المرور">
            <button class="auth-btn" onclick="sendVerificationCode()">إرسال رمز التحقق</button>
            <div class="auth-switch" onclick="showLoginScreen()">لديك حساب؟ سجل دخول</div>
            <div id="authError" style="color: var(--danger); margin-top: 15px; font-size: 14px;"></div>
        `;
    }

    function showVerificationScreen(email, username, password) {
        authContainer.innerHTML = `
            <h2>تأكيد البريد الإلكتروني</h2>
            <p style="color: var(--text-secondary); margin-bottom: 25px;">أدخل رمز التحقق المكون من 4 أرقام المرسل إلى</p>
            <p style="font-weight: bold; color: var(--primary); margin-bottom: 20px;">${email}</p>
            <div class="verification-container">
                <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 0)" onkeyup="handleCodeInput(event, this, 0)">
                <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 1)" onkeyup="handleCodeInput(event, this, 1)">
                <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 2)" onkeyup="handleCodeInput(event, this, 2)">
                <input type="text" class="code-input" maxlength="1" oninput="moveToNext(this, 3)" onkeyup="handleCodeInput(event, this, 3)">
            </div>
            <button class="auth-btn" onclick="verifyCode('${email}', '${username}', '${password}')">تأكيد</button>
            <div class="auth-switch" onclick="showSignupScreen()">تغيير البريد الإلكتروني</div>
            <div id="authError" style="color: var(--danger); margin-top: 15px;"></div>
        `;
        setTimeout(() => document.querySelector('.code-input')?.focus(), 100);
    }

    window.moveToNext = (input, index) => {
        if (input.value.length === 1 && index < 3) {
            input.parentElement.children[index + 1].focus();
        }
    };

    window.handleCodeInput = (e, input, index) => {
        if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
            input.parentElement.children[index - 1].focus();
        }
    };

    async function sendVerificationCode() {
        const email = document.getElementById('signupEmail')?.value;
        const username = document.getElementById('signupUsername')?.value;
        const password = document.getElementById('signupPassword')?.value;
        const errorEl = document.getElementById('authError');
        if (!email || !username || !password) {
            errorEl.innerText = 'يرجى ملء جميع الحقول';
            return;
        }
        if (!validateEmail(email)) {
            errorEl.innerText = 'البريد الإلكتروني غير صحيح';
            return;
        }
        try {
            const response = await fetch(`${SERVER_URL}/send-verification`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, username, password })
            });
            const data = await response.json();
            if (data.success) {
                showVerificationScreen(email, username, password);
                showToast('تم إرسال رمز التحقق', 'success');
            } else {
                errorEl.innerText = data.message || 'فشل إرسال الرمز';
                showToast(data.message || 'فشل إرسال الرمز', 'error');
            }
        } catch (err) {
            errorEl.innerText = 'خطأ في الاتصال بالسيرفر';
            showToast('خطأ في الاتصال بالسيرفر', 'error');
        }
    }

    async function verifyCode(email, username, password) {
        const inputs = document.querySelectorAll('.code-input');
        let code = '';
        inputs.forEach(input => code += input.value);
        const errorEl = document.getElementById('authError');
        if (code.length !== 4) {
            errorEl.innerText = 'يرجى إدخال الرمز المكون من 4 أرقام';
            return;
        }
        try {
            const response = await fetch(`${SERVER_URL}/verify-code`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, code })
            });
            const data = await response.json();
            if (data.success) {
                const registerResponse = await fetch(`${SERVER_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password })
                });
                const registerData = await registerResponse.json();
                if (registerData.success) {
                    showToast('تم إنشاء الحساب بنجاح!', 'success');
                    showLoginScreen();
                } else {
                    errorEl.innerText = registerData.message || 'فشل إنشاء الحساب';
                    showToast(registerData.message || 'فشل إنشاء الحساب', 'error');
                }
            } else {
                errorEl.innerText = data.message || 'رمز التحقق غير صحيح';
                showToast(data.message || 'رمز التحقق غير صحيح', 'error');
            }
        } catch (err) {
            errorEl.innerText = 'خطأ في الاتصال بالسيرفر';
            showToast('خطأ في الاتصال بالسيرفر', 'error');
        }
    }

    function showForgotPassword() {
        document.getElementById('forgotPasswordModal').style.display = 'flex';
        document.getElementById('resetCodeSection').style.display = 'none';
        document.getElementById('forgotActionBtn').innerText = 'إرسال الرمز';
        document.getElementById('forgotActionBtn').onclick = sendResetCode;
    }

    async function sendResetCode() {
        const email = document.getElementById('forgotEmail').value.trim();
        const errorEl = document.getElementById('forgotError');
        if (!email) {
            errorEl.innerText = 'يرجى إدخال البريد الإلكتروني';
            return;
        }
        try {
            const res = await fetch(`${SERVER_URL}/forgot-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('resetCodeSection').style.display = 'block';
                document.getElementById('forgotActionBtn').innerText = 'تأكيد الرمز';
                document.getElementById('forgotActionBtn').onclick = () => verifyResetCode(email);
                errorEl.innerText = '';
                showToast('تم إرسال رمز إعادة التعيين', 'success');
            } else {
                errorEl.innerText = data.message;
                showToast(data.message, 'error');
            }
        } catch (err) {
            errorEl.innerText = 'خطأ في الاتصال بالسيرفر';
            showToast('خطأ في الاتصال بالسيرفر', 'error');
        }
    }

    async function verifyResetCode(email) {
        const inputs = document.querySelectorAll('#forgotPasswordModal .code-input');
        let code = '';
        inputs.forEach(input => code += input.value);
        const newPassword = document.getElementById('newPassword').value;
        const errorEl = document.getElementById('forgotError');
        if (code.length !== 4) {
            errorEl.innerText = 'أدخل الرمز المكون من 4 أرقام';
            return;
        }
        if (!newPassword) {
            errorEl.innerText = 'أدخل كلمة المرور الجديدة';
            return;
        }
        try {
            const res = await fetch(`${SERVER_URL}/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, code, newPassword })
            });
            const data = await res.json();
            if (data.success) {
                showToast('تم تغيير كلمة المرور بنجاح', 'success');
                document.getElementById('forgotPasswordModal').style.display = 'none';
            } else {
                errorEl.innerText = data.message;
                showToast(data.message, 'error');
            }
        } catch (err) {
            errorEl.innerText = 'خطأ في الاتصال بالسيرفر';
            showToast('خطأ في الاتصال بالسيرفر', 'error');
        }
    }

    async function login() {
        const email = document.getElementById('loginEmail')?.value;
        const password = document.getElementById('loginPassword')?.value;
        const errorEl = document.getElementById('authError');
        if (!email || !password) {
            errorEl.innerText = 'يرجى إدخال البريد وكلمة المرور';
            return;
        }
        try {
            const response = await fetch(`${SERVER_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (data.success) {
                myName = data.username;
                myEmail = email;
                myUserId = data.userId;
                await initializeApp(data.avatar || '');
                showToast(`مرحباً ${myName}`, 'success');
            } else {
                errorEl.innerText = data.message || 'بريد أو كلمة مرور غير صحيحة';
                showToast(data.message || 'بريد أو كلمة مرور غير صحيحة', 'error');
            }
        } catch (err) {
            errorEl.innerText = 'خطأ في الاتصال بالسيرفر';
            showToast('خطأ في الاتصال بالسيرفر', 'error');
        }
    }

    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // ==================== تهيئة التطبيق ====================
    async function initializeApp(avatarUrl = '') {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } },
                audio: true
            });
            document.getElementById('localVideo').srcObject = localStream;
            document.getElementById('userAvatar').src = avatarUrl || 'https://via.placeholder.com/50';
            document.getElementById('myNameLabel').innerText = myName;
            connectToServer();
            document.getElementById('setupScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
            }, 300);
            setupControls();
            getVideoDevices();
            initFilters();
            await loadFollowData();
            await loadStories();
        } catch (err) {
            console.error(err);
            showToast('تعذر الوصول إلى الكاميرا أو الميكروفون. يرجى التحقق من الصلاحيات.', 'error');
        }
    }

    // ==================== الاتصال بالسيرفر ====================
    function connectToServer() {
        socket = io(SERVER_URL, { reconnection: true, reconnectionAttempts: 5, reconnectionDelay: 1000 });

        socket.on('connect', () => {
            console.log('متصل بالسيرفر');
            updateStatus('متصل بالسيرفر', true);
            socket.emit('register', { name: myName, email: myEmail });
            showToast('متصل بالسيرفر', 'success');
        });

        socket.on('disconnect', () => {
            console.log('تم قطع الاتصال بالسيرفر');
            updateStatus('غير متصل', false);
            showToast('تم قطع الاتصال بالسيرفر', 'error');
        });

        socket.on('connect_error', (err) => {
            console.error('خطأ في الاتصال:', err);
            updateStatus('فشل الاتصال', false);
            showToast('فشل الاتصال بالسيرفر', 'error');
        });

        socket.on('users-updated', (users) => {
            // users: { id (socket.id), name, inCall, avatar, userId, online, lastSeen }
            connectedUsers = users.filter(u => u.id !== socket.id);
            updateOnlineUsersCount();
            updateUsersGrid();
            updateSearchResults();
            // تحديث حالة المستخدمين في الدردشة إذا كانت مفتوحة
            if (currentChatUser) {
                const user = connectedUsers.find(u => u.userId === currentChatUser.id);
                if (user) {
                    updateChatHeaderStatus(user.online, user.lastSeen);
                }
            }
        });

        socket.on('avatar-updated', (data) => {
            if (data.email === myEmail) {
                document.getElementById('userAvatar').src = data.avatar || 'https://via.placeholder.com/50';
            }
            updateUsersGrid();
        });

        socket.on('incoming-call', (data) => {
            incomingCallData = data;
            showIncomingCallModal(data);
        });

        socket.on('call-accepted', async (data) => {
            await handleCallAccepted(data);
        });

        socket.on('call-rejected', (data) => {
            showToast(`تم رفض المكالمة من قبل ${data.from}`, 'warning');
            resetCallState();
        });

        socket.on('call-ended', (data) => {
            if (isCallActive) {
                showToast(`أنهى ${data.from} المكالمة`, 'warning');
                endCall();
            }
        });

        socket.on('calling', (data) => {
            showToast(`جاري الاتصال...`, 'info');
        });

        socket.on('offer', async (data) => {
            await handleOffer(data);
        });

        socket.on('answer', async (data) => {
            await handleAnswer(data);
        });

        socket.on('ice-candidate', (data) => {
            handleIceCandidate(data);
        });

        socket.on('random-call-matched', async (data) => {
            isWaitingRandom = false;
            document.getElementById('randomCallBtn').classList.remove('flip');
            document.getElementById('randomCallBtn').innerHTML = '<i class="fas fa-random"></i><span>اتصال عشوائي</span>';
            document.getElementById('remoteVideoContainer').classList.add('flip-animation');
            setTimeout(() => {
                document.getElementById('remoteVideoContainer').classList.remove('flip-animation');
            }, 600);
            currentCall = data.partnerId;
            callType = data.type || 'video';
            await createPeerConnection(data.partnerId);
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('call', {
                to: data.partnerId,
                from: myName,
                type: callType,
                offer: offer
            });
            updateCallUI(true, `جاري الاتصال العشوائي...`, callType);
            document.getElementById('endCallBtn').style.display = 'flex';
            showToast('تم العثور على شريك للمكالمة العشوائية', 'success');
        });

        socket.on('random-call-cancelled', () => {
            isWaitingRandom = false;
            document.getElementById('randomCallBtn').classList.remove('flip');
            document.getElementById('randomCallBtn').innerHTML = '<i class="fas fa-random"></i><span>اتصال عشوائي</span>';
            showToast('لم يتم العثور على مستخدم. حاول مرة أخرى.', 'warning');
        });

        // أحداث الدردشة
        socket.on('new-message', (message) => {
            if (currentChatUser && (message.from === currentChatUser.id || message.to === currentChatUser.id)) {
                messages.push(message);
                renderMessages();
                // تحديث حالة المشاهدة
                if (message.to === myUserId) {
                    socket.emit('mark-seen', { from: message.from });
                }
            } else {
                // تحديث قائمة المحادثات
                loadChats();
                showToast(`رسالة جديدة من ${message.fromName || 'مستخدم'}`, 'info');
            }
        });

        socket.on('message-sent', (message) => {
            // تم إرسال الرسالة بنجاح
            if (currentChatUser && (message.from === myUserId && message.to === currentChatUser.id)) {
                messages.push(message);
                renderMessages();
            }
        });

        socket.on('typing', (data) => {
            if (currentChatUser && data.from === currentChatUser.id) {
                const indicator = document.getElementById('typingIndicator');
                if (data.isTyping) {
                    indicator.style.display = 'block';
                } else {
                    indicator.style.display = 'none';
                }
            }
        });

        socket.on('messages-seen', (data) => {
            if (currentChatUser && data.by === currentChatUser.id) {
                // تحديث حالة الرسائل
                messages.forEach(msg => { if (msg.to === myUserId) msg.seen = true; });
                renderMessages();
            }
        });

        // أحداث القصص والمتابعة
        socket.on('follow-notification', (data) => {
            showToast(`📢 لديك متابع جديد!`, 'success');
        });
        socket.on('new-story', (story) => {
            addStoryToContainer(story);
            showToast(`قصة جديدة من ${story.userName}`, 'info');
        });
        socket.on('story-interaction', (data) => {
            if (currentStory && currentStory.id === data.storyId) {
                loadStoryInteractions(data.storyId);
            }
        });
    }

    // ==================== وظائف الدردشة ====================
    function toggleChat() {
        const modal = document.getElementById('chatModal');
        if (modal.style.display === 'flex') {
            modal.style.display = 'none';
        } else {
            modal.style.display = 'flex';
            loadChats();
        }
    }

    async function loadChats() {
        try {
            const res = await fetch(`${SERVER_URL}/chats/${myUserId}`);
            const data = await res.json();
            if (data.success) {
                chats = data.chats;
                renderChatsList();
            }
        } catch (err) {
            console.error('فشل تحميل المحادثات:', err);
        }
    }

    function renderChatsList() {
        const container = document.getElementById('chatUsersList');
        container.innerHTML = '';
        chats.forEach(chat => {
            const div = document.createElement('div');
            div.className = `chat-user-item ${currentChatUser && currentChatUser.id === chat.userId ? 'active' : ''}`;
            div.onclick = () => openChat(chat.userId, chat.userName, chat.userAvatar);
            div.innerHTML = `
                <img src="${chat.userAvatar || 'https://via.placeholder.com/40'}" class="chat-user-avatar">
                <div class="chat-user-info">
                    <div class="chat-user-name">
                        ${chat.userName}
                        ${chat.unreadCount > 0 ? `<span class="unread-badge">${chat.unreadCount}</span>` : ''}
                    </div>
                    <div class="chat-last-message">${chat.lastMessage ? (chat.lastMessage.type === 'text' ? chat.lastMessage.content : '📎 وسائط') : '...'}</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function openChat(userId, userName, userAvatar) {
        currentChatUser = { id: userId, name: userName, avatar: userAvatar };
        document.getElementById('chatHeader').style.display = 'flex';
        document.getElementById('chatInputArea').style.display = 'flex';
        document.getElementById('chatCurrentName').innerText = userName;
        document.getElementById('chatCurrentAvatar').src = userAvatar || 'https://via.placeholder.com/40';
        
        // تحديث حالة المستخدم (متصل/آخر ظهور)
        const user = connectedUsers.find(u => u.userId === userId);
        updateChatHeaderStatus(user ? user.online : false, user ? user.lastSeen : null);

        try {
            const res = await fetch(`${SERVER_URL}/messages/${myUserId}/${userId}`);
            const data = await res.json();
            if (data.success) {
                messages = data.messages;
                renderMessages();
            }
        } catch (err) {
            console.error('فشل تحميل الرسائل:', err);
        }

        // تحديث قائمة المحادثات (لإزالة علامة غير مقروء)
        loadChats();
    }

    function updateChatHeaderStatus(online, lastSeen) {
        const statusEl = document.getElementById('chatCurrentStatus');
        if (online) {
            statusEl.innerHTML = '<span class="online-dot"></span> متصل الآن';
        } else {
            const lastSeenDate = lastSeen ? new Date(lastSeen).toLocaleString('ar') : 'غير معروف';
            statusEl.innerText = `آخر ظهور: ${lastSeenDate}`;
        }
    }

    function renderMessages() {
        const container = document.getElementById('chatMessages');
        container.innerHTML = '';
        messages.forEach(msg => {
            const div = document.createElement('div');
            div.className = `message ${msg.from === myUserId ? 'sent' : 'received'}`;
            let contentHtml = '';
            if (msg.type === 'text') {
                contentHtml = `<div>${msg.content}</div>`;
            } else if (msg.type === 'image') {
                contentHtml = `<img src="${msg.content}" class="message-image" onclick="window.open('${msg.content}')">`;
            } else if (msg.type === 'video') {
                contentHtml = `<video src="${msg.content}" controls class="message-video"></video>`;
            } else if (msg.type === 'file') {
                contentHtml = `<div class="message-file"><i class="fas fa-file"></i> <a href="${msg.content}" target="_blank">تحميل الملف</a></div>`;
            }
            const time = new Date(msg.timestamp).toLocaleTimeString('ar');
            const seen = msg.seen ? '<span class="seen-indicator"><i class="fas fa-check-double"></i></span>' : '';
            div.innerHTML = `
                ${contentHtml}
                <div class="message-time">${time} ${seen}</div>
            `;
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const content = input.value.trim();
        if (!content || !currentChatUser) return;
        socket.emit('send-message', {
            to: currentChatUser.id,
            type: 'text',
            content: content
        });
        input.value = '';
        // إيقاف مؤشر الكتابة
        socket.emit('typing', { to: currentChatUser.id, isTyping: false });
    }

    // إرسال وسائط (صورة، فيديو، ملف)
    function sendMedia(type) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = type === 'image' ? 'image/*' : type === 'video' ? 'video/*' : '*/*';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const content = event.target.result; // base64
                socket.emit('send-message', {
                    to: currentChatUser.id,
                    type: type,
                    content: content
                });
            };
            reader.readAsDataURL(file);
        };
        input.click();
        document.getElementById('attachOptions').style.display = 'none';
    }

    // مؤشر الكتابة
    document.getElementById('chatInput').addEventListener('input', () => {
        if (!currentChatUser) return;
        socket.emit('typing', { to: currentChatUser.id, isTyping: true });
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            socket.emit('typing', { to: currentChatUser.id, isTyping: false });
        }, 1000);
    });

    document.getElementById('chatSendBtn').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    document.getElementById('attachBtn').addEventListener('click', () => {
        const opt = document.getElementById('attachOptions');
        opt.style.display = opt.style.display === 'flex' ? 'none' : 'flex';
    });

    function closeChat() {
        document.getElementById('chatModal').style.display = 'none';
        currentChatUser = null;
    }

    // ==================== وظائف المتابعة والقصص ====================
    async function loadFollowData() {
        if (!myUserId) return;
        try {
            const res = await fetch(`${SERVER_URL}/following/${myUserId}`);
            const data = await res.json();
            if (data.success) {
                myFollowings = new Set(data.following.map(f => f.userId));
            }
        } catch (err) {
            console.error('فشل تحميل بيانات المتابعة:', err);
        }
    }

    async function loadStories() {
        if (!myUserId) return;
        try {
            const res = await fetch(`${SERVER_URL}/stories/${myUserId}`);
            const data = await res.json();
            if (data.success) {
                myStories = data.stories;
                renderStories();
            }
        } catch (err) {
            console.error('فشل تحميل القصص:', err);
        }
    }

    function renderStories() {
        const container = document.getElementById('storiesContainer');
        container.innerHTML = `<div class="story-item" onclick="showAddStoryModal()"><div class="story-avatar add"><i class="fas fa-plus"></i></div><span class="story-username">إضافة قصة</span></div>`;
        myStories.forEach(story => {
            const div = document.createElement('div');
            div.className = 'story-item';
            div.onclick = () => viewStory(story.id);
            div.innerHTML = `<img class="story-avatar" src="${story.userAvatar || 'https://via.placeholder.com/70'}"><span class="story-username">${story.userName}</span>`;
            container.appendChild(div);
        });
    }

    function addStoryToContainer(story) {
        myStories.push(story);
        renderStories();
    }

    function showAddStoryModal() {
        const text = prompt('أدخل نص القصة (اختياري)');
        if (text === null) return;
        fetch(`${SERVER_URL}/post-story`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: myUserId, text: text || '', media: null })
        }).then(res => res.json()).then(data => {
            if (data.success) {
                showToast('تم نشر القصة', 'success');
            } else {
                showToast('فشل نشر القصة', 'error');
            }
        }).catch(err => showToast('خطأ في الاتصال', 'error'));
    }

    async function viewStory(storyId) {
        try {
            const res = await fetch(`${SERVER_URL}/story/${storyId}`);
            const data = await res.json();
            if (data.success) {
                currentStory = data.story;
                document.getElementById('storyImage').src = currentStory.media || 'https://via.placeholder.com/400';
                document.getElementById('storyText').innerText = currentStory.text || '';
                await loadStoryInteractions(storyId);
                document.getElementById('storyViewer').style.display = 'flex';
            }
        } catch (err) {
            showToast('خطأ في تحميل القصة', 'error');
        }
    }

    async function loadStoryInteractions(storyId) {
        try {
            const intRes = await fetch(`${SERVER_URL}/story-interactions/${storyId}`);
            const intData = await intRes.json();
            document.getElementById('storyLikes').innerText = intData.likes;
            document.getElementById('storyComments').innerText = intData.comments.length;
            const commentsList = document.getElementById('storyCommentsList');
            commentsList.innerHTML = intData.comments.map(c => `<div class="comment">${c.content}</div>`).join('');
        } catch (err) {
            console.error('فشل تحميل التفاعلات');
        }
    }

    function closeStoryViewer() {
        document.getElementById('storyViewer').style.display = 'none';
        currentStory = null;
    }

    async function likeCurrentStory() {
        if (!currentStory) return;
        try {
            await fetch(`${SERVER_URL}/interact`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ storyId: currentStory.id, userId: myUserId, type: 'like' })
            });
            const likesSpan = document.getElementById('storyLikes');
            likesSpan.innerText = parseInt(likesSpan.innerText) + 1;
        } catch (err) {
            console.error('فشل الإعجاب');
        }
    }

    function showCommentBox() {
        const comment = prompt('أدخل تعليقك');
        if (comment && currentStory) {
            fetch(`${SERVER_URL}/interact`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ storyId: currentStory.id, userId: myUserId, type: 'comment', content: comment })
            }).then(() => {
                loadStoryInteractions(currentStory.id);
            }).catch(err => console.error('فشل إرسال التعليق'));
        }
    }

    // ==================== تحديث قائمة المستخدمين مع أزرار متابعة ودردشة ====================
    function updateUsersGrid() {
        const grid = document.getElementById('onlineUsersGrid');
        const count = document.getElementById('onlineCount');
        count.innerText = connectedUsers.length + 1;
        if (connectedUsers.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-secondary); padding: 20px;">لا يوجد مستخدمون آخرون متصلون</div>';
            return;
        }
        let html = '';
        connectedUsers.forEach(user => {
            const statusClass = user.inCall ? 'in-call' : 'online';
            const statusText = user.inCall ? 'في مكالمة' : (user.online ? 'متصل' : 'غير متصل');
            const avatar = user.avatar || 'https://via.placeholder.com/50';
            const isFollowing = myFollowings.has(user.userId);
            const onlineDot = user.online ? '<span class="online-dot" title="متصل"></span>' : '<span class="offline-dot" title="غير متصل"></span>';
            html += `
                <div class="user-card">
                    <img class="user-card-avatar" src="${avatar}" onclick="selectUser('${user.name}')">
                    <div class="user-card-info" onclick="selectUser('${user.name}')">
                        <div class="user-card-name">
                            ${user.name} ${onlineDot}
                        </div>
                        <div class="user-card-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="user-actions">
                        <button class="chat-btn" onclick="openChat('${user.userId}', '${user.name}', '${avatar}')"><i class="fas fa-comment"></i></button>
                        <button class="call-btn" onclick="callUserById('${user.userId}', '${user.name}')"><i class="fas fa-phone"></i></button>
                        <button class="follow-btn" onclick="toggleFollow('${user.userId}')">${isFollowing ? 'متابع' : 'متابعة'}</button>
                    </div>
                </div>
            `;
        });
        grid.innerHTML = html;
    }

    function callUserById(userId, userName) {
        document.getElementById('targetNameInput').value = userName;
        callUser('video'); // أو audio
    }

    async function toggleFollow(targetId) {
        try {
            if (myFollowings.has(targetId)) {
                await fetch(`${SERVER_URL}/unfollow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: myUserId, targetId })
                });
                myFollowings.delete(targetId);
                showToast('تم إلغاء المتابعة', 'success');
            } else {
                await fetch(`${SERVER_URL}/follow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: myUserId, targetId })
                });
                myFollowings.add(targetId);
                showToast('تمت المتابعة', 'success');
            }
            updateUsersGrid();
        } catch (err) {
            console.error('فشل عملية المتابعة:', err);
            showToast('فشل عملية المتابعة', 'error');
        }
    }

    // ==================== الملف الشخصي ====================
    async function openMyProfile() {
        if (!myUserId) return;
        try {
            const [followersRes, followingRes, storiesRes] = await Promise.all([
                fetch(`${SERVER_URL}/followers/${myUserId}`),
                fetch(`${SERVER_URL}/following/${myUserId}`),
                fetch(`${SERVER_URL}/stories/${myUserId}`)
            ]);
            const followersData = await followersRes.json();
            const followingData = await followingRes.json();
            const storiesData = await storiesRes.json();
            document.getElementById('profileFollowers').innerText = followersData.followers.length;
            document.getElementById('profileFollowing').innerText = followingData.following.length;
            document.getElementById('profileStories').innerText = storiesData.stories.length;
            document.getElementById('profileUsername').innerText = myName;
            document.getElementById('profileAvatar').src = document.getElementById('userAvatar').src;
            document.getElementById('profileBio').innerText = 'السيرة الذاتية (قابلة للتعديل)';
            document.getElementById('profileModal').style.display = 'flex';
        } catch (err) {
            console.error('فشل فتح الملف الشخصي:', err);
        }
    }

    function closeProfile() {
        document.getElementById('profileModal').style.display = 'none';
    }

    // ==================== دوال البحث ====================
    window.selectUser = (name) => {
        document.getElementById('targetNameInput').value = name;
        document.getElementById('searchResults').style.display = 'none';
    };

    // ==================== دوال WebRTC (مع تحسين تبديل الكاميرا) ====================
    async function createPeerConnection(targetId) {
        if (peerConnection) peerConnection.close();
        peerConnection = new RTCPeerConnection(config);
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });
        peerConnection.ontrack = (event) => {
            document.getElementById('remoteVideo').srcObject = event.streams[0];
        };
        peerConnection.onicecandidate = (event) => {
            if (event.candidate && targetId) {
                socket.emit('ice-candidate', { to: targetId, candidate: event.candidate });
            }
        };
        peerConnection.onconnectionstatechange = () => {
            if (peerConnection.connectionState === 'connected') {
                isCallActive = true;
                startCallTimer();
                updateCallUI(true, `متصل`, callType);
                showToast('المكالمة متصلة', 'success');
            } else if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) {
                if (isCallActive) endCall();
            }
        };
    }

    async function callUser(type) {
        const targetName = document.getElementById('targetNameInput').value.trim();
        if (!targetName) return showToast('يرجى اختيار مستخدم', 'warning');
        if (targetName === myName) return showToast('لا يمكن الاتصال بنفسك', 'warning');
        if (isCallActive) return showToast('أنت في مكالمة حالياً', 'warning');
        const targetUser = connectedUsers.find(u => u.name === targetName);
        if (!targetUser) return showToast('المستخدم غير متصل', 'warning');
        currentCall = targetUser.id;
        callType = type;
        await createPeerConnection(targetUser.id);
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit('call', { to: targetUser.id, from: myName, type, offer });
        updateCallUI(true, `جاري الاتصال بـ ${targetName}...`, type);
        document.getElementById('endCallBtn').style.display = 'flex';
    }

    async function handleOffer(data) {
        if (isCallActive) {
            socket.emit('reject-call', { to: data.fromId, reason: 'مشغول' });
            return;
        }
        incomingCallData = { ...data, fromId: data.fromId };
        showIncomingCallModal(data);
    }

    async function acceptCall() {
        if (!incomingCallData) return;
        document.getElementById('incomingCallModal').style.display = 'none';
        currentCall = incomingCallData.fromId;
        callType = incomingCallData.type;
        await createPeerConnection(incomingCallData.fromId);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCallData.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit('accept-call', { to: incomingCallData.fromId, answer });
        socket.emit('call-accepted', { to: incomingCallData.fromId, from: myName });
        updateCallUI(true, `متصل مع ${incomingCallData.from}`, callType);
        document.getElementById('endCallBtn').style.display = 'flex';
        document.getElementById('remoteTag').innerHTML = `<span>${incomingCallData.from}</span>`;
        incomingCallData = null;
    }

    function rejectCall() {
        if (incomingCallData) {
            socket.emit('reject-call', { to: incomingCallData.fromId });
            document.getElementById('incomingCallModal').style.display = 'none';
            incomingCallData = null;
        }
    }

    async function handleAnswer(data) {
        if (peerConnection) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    }

    function handleIceCandidate(data) {
        if (peerConnection) {
            peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    }

    async function handleCallAccepted(data) {
        if (peerConnection && currentCall === data.fromId) {
            updateCallUI(true, `متصل مع ${data.from}`, callType);
            document.getElementById('remoteTag').innerHTML = `<span>${data.from}</span>`;
        }
    }

    function endCall() {
        if (currentCall) {
            socket.emit('end-call', { to: currentCall });
        }
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        resetCallState();
        document.getElementById('endCallBtn').style.display = 'none';
        stopCallTimer();
        showToast('تم إنهاء المكالمة', 'info');
    }

    function resetCallState() {
        isCallActive = false;
        currentCall = null;
        callType = null;
        incomingCallData = null;
        document.getElementById('remoteVideo').srcObject = null;
        document.getElementById('remoteTag').innerHTML = '<span>في انتظار الاتصال...</span>';
        document.getElementById('remoteVideoContainer').classList.remove('active-call');
        updateCallUI(false, 'جاهز للاتصال', null);
    }

    // ==================== دوال مساعدة ====================
    function setupControls() {
        document.getElementById('toggleMicBtn').addEventListener('click', toggleMic);
        document.getElementById('toggleCamBtn').addEventListener('click', toggleCam);
        document.getElementById('toggleVideoBtn').addEventListener('click', toggleCam);
        document.getElementById('toggleAudioBtn').addEventListener('click', toggleMic);

        document.getElementById('targetNameInput').addEventListener('input', updateSearchResults);
        document.getElementById('targetNameInput').addEventListener('focus', () => {
            updateSearchResults();
            document.getElementById('searchResults').style.display = 'block';
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        document.getElementById('uploadAvatarBtn').addEventListener('click', function() {
            document.getElementById('avatarUploadInput').click();
        });

        document.getElementById('avatarUploadInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const avatarData = event.target.result;
                try {
                    const res = await fetch(`${SERVER_URL}/update-avatar`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: myEmail, avatar: avatarData })
                    });
                    const data = await res.json();
                    if (data.success) {
                        document.getElementById('userAvatar').src = avatarData;
                        showToast('تم تحديث الصورة', 'success');
                    } else {
                        showToast('فشل تحديث الصورة', 'error');
                    }
                } catch (err) {
                    showToast('خطأ في الاتصال بالسيرفر', 'error');
                }
            };
            reader.readAsDataURL(file);
        });
    }

    function toggleMic() {
        if (localStream) {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const btn = document.getElementById('toggleMicBtn');
                btn.classList.toggle('active', audioTrack.enabled);
                btn.classList.toggle('inactive', !audioTrack.enabled);
                document.getElementById('localMicIndicator').classList.toggle('on', audioTrack.enabled);
                document.getElementById('localMicIndicator').classList.toggle('off', !audioTrack.enabled);
            }
        }
    }

    function toggleCam() {
        if (localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                const btn = document.getElementById('toggleCamBtn');
                btn.classList.toggle('active', videoTrack.enabled);
                btn.classList.toggle('inactive', !videoTrack.enabled);
                document.getElementById('localCamIndicator').classList.toggle('on', videoTrack.enabled);
                document.getElementById('localCamIndicator').classList.toggle('off', !videoTrack.enabled);
            }
        }
    }

    function updateSearchResults() {
        const searchTerm = document.getElementById('targetNameInput').value.toLowerCase();
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';
        let filtered = connectedUsers;
        if (searchTerm.trim()) {
            filtered = connectedUsers.filter(u => u.name.toLowerCase().includes(searchTerm));
        }
        if (filtered.length > 0) {
            filtered.forEach(user => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; border-bottom: 1px solid var(--border);';
                item.onmouseover = () => item.style.background = 'var(--border)';
                item.onmouseout = () => item.style.background = '';
                item.onclick = () => {
                    document.getElementById('targetNameInput').value = user.name;
                    resultsContainer.style.display = 'none';
                };
                item.innerHTML = `
                    <img src="${user.avatar || 'https://via.placeholder.com/30'}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                    <div>
                        <div style="font-weight: 600;">${user.name}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${user.inCall ? 'في مكالمة' : (user.online ? 'متصل' : 'غير متصل')}</div>
                    </div>
                `;
                resultsContainer.appendChild(item);
            });
        } else {
            resultsContainer.innerHTML = '<div style="padding: 10px; text-align: center;">لا توجد نتائج</div>';
        }
        resultsContainer.style.display = 'block';
    }

    function updateOnlineUsersCount() {
        document.getElementById('onlineUsers').innerText = `المستخدمون المتصلون: ${connectedUsers.length + 1}`;
    }

    function updateStatus(status, isConnected) {
        document.getElementById('connectionStatus').innerText = status;
        document.getElementById('statusMsg').innerHTML = `الحالة: <span class="${isConnected ? 'status-connected' : 'status-disconnected'}">${status}</span>`;
    }

    function updateCallUI(isActive, status, type) {
        // يمكن إضافة منطق
    }

    function showIncomingCallModal(data) {
        document.getElementById('callerName').innerText = data.from;
        document.getElementById('callerAvatar').innerText = data.from.charAt(0).toUpperCase();
        document.getElementById('incomingCallType').innerText = data.type === 'video' ? 'اتصال مرئي' : 'اتصال صوتي';
        document.getElementById('incomingCallModal').style.display = 'flex';
    }

    function startCallTimer() {
        callStartTime = new Date();
        document.getElementById('callTimer').style.display = 'block';
        callTimer = setInterval(() => {
            const diff = Math.floor((new Date() - callStartTime) / 1000);
            const mins = Math.floor(diff / 60);
            const secs = diff % 60;
            document.getElementById('timerDisplay').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }, 1000);
    }

    function stopCallTimer() {
        clearInterval(callTimer);
        callTimer = null;
        document.getElementById('timerDisplay').innerText = '00:00';
        document.getElementById('callTimer').style.display = 'none';
    }

    function requestRandomCall() {
        if (isWaitingRandom) {
            socket.emit('cancel-random-call');
            isWaitingRandom = false;
            document.getElementById('randomCallBtn').classList.remove('flip');
            document.getElementById('randomCallBtn').innerHTML = '<i class="fas fa-random"></i><span>اتصال عشوائي</span>';
            updateStatus('جاهز', true);
        } else {
            socket.emit('request-random-call', { name: myName });
            isWaitingRandom = true;
            document.getElementById('randomCallBtn').classList.add('flip');
            document.getElementById('randomCallBtn').innerHTML = '<i class="fas fa-times"></i><span>إلغاء الانتظار</span>';
            updateStatus('جاري البحث عن مستخدم عشوائي...', true);
        }
    }

    async function getVideoDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        videoDevices = devices.filter(device => device.kind === 'videoinput');
        if (videoDevices.length > 0 && localStream) {
            currentDeviceId = localStream.getVideoTracks()[0]?.getSettings().deviceId;
        }
    }

    async function flipCamera() {
        if (videoDevices.length < 2) {
            showToast('لا توجد كاميرا خلفية متاحة', 'warning');
            return;
        }
        const currentIndex = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
        const nextIndex = (currentIndex + 1) % videoDevices.length;
        const newDeviceId = videoDevices[nextIndex].deviceId;
        try {
            const newStream = await navigator.mediaDevices.getUserMedia({
                video: { deviceId: { exact: newDeviceId }, width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } },
                audio: true
            });
            const videoTrack = newStream.getVideoTracks()[0];
            const sender = peerConnection?.getSenders().find(s => s.track?.kind === 'video');
            if (sender) await sender.replaceTrack(videoTrack);
            const oldVideoTrack = localStream.getVideoTracks()[0];
            localStream.removeTrack(oldVideoTrack);
            localStream.addTrack(videoTrack);
            oldVideoTrack.stop();
            document.getElementById('localVideo').srcObject = localStream;
            currentDeviceId = newDeviceId;
            showToast('تم تبديل الكاميرا', 'success');
        } catch (err) {
            console.error('فشل تبديل الكاميرا:', err);
            showToast('فشل تبديل الكاميرا', 'error');
        }
    }

    function initFilters() {
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const filter = this.dataset.filter;
                document.getElementById('localVideo').style.filter = filter === 'none' ? 'none' : filter;
            });
        });
    }

    // ==================== لوحة التخصيص ====================
    function toggleCustomize() {
        const panel = document.getElementById('customizePanel');
        panel.classList.toggle('show');
    }

    function applyCustomizations() {
        const primaryColor = document.getElementById('primaryColor').value;
        const fontSize = document.getElementById('fontSize').value;
        document.documentElement.style.setProperty('--primary', primaryColor);
        document.body.style.fontSize = fontSize + 'px';
        showToast('تم تطبيق التخصيصات', 'success');
    }

    function logout() {
        if (isCallActive) endCall();
        if (localStream) {
            localStream.getTracks().forEach(t => t.stop());
        }
        if (socket) {
            socket.disconnect();
        }
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('setupScreen').style.display = 'flex';
        document.getElementById('setupScreen').style.opacity = '1';
        showLoginScreen();
    }

    window.onload = () => {
        showLoginScreen();
    };
</script>
</body>
</html>
